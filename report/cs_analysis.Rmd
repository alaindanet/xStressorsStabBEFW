---
title: Simulation connectance richness
author: Alain Danet
output:
  bookdown::pdf_document2
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  cache = FALSE,
  collapse = TRUE,
  comment = "#>",
  #fig.dim = c(7, 7),
  fig.fullwidth = TRUE,
  fig.show = "hold",
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  results = TRUE,
  fig.path="figures/"
)
```

```{r, results = FALSE}
library(tidyverse)
library(magrittr)
library(cowplot)
library(here)
library(arrow)
library(piecewiseSEM)
library(semEff)
library(easystats)

mytheme <- theme_cowplot(font_size = 8) +
background_grid() +
theme(legend.position = "bottom")
theme_set(mytheme)
source(here::here("R", "network_metrics.R"))
```

```{r}
sim_files <- list.files(here("res", "simCSZenrich"))
sim_list <- map(sim_files, function (x) {
  open_dataset(here::here("res", "simCSZenrich", x),
    format = "arrow") %>%
  collect()
})
```

```{r}
# TODO set extinction threshold in simulations
simZ_prep <- map_dfr(sim_list,
  function (x) {
    x %>%
      # Remove simulation that have failed to run
      filter(!is.na(richness)) %>%
      # Transform back interaction strength into matrices
      mutate(across(where(is.list), as.list)) %>%
      mutate(across(c(int_strength, max_int),
          ~map2(.x, S,
            function(y, rich) {
              matrix(y, nrow = rich)
            }
          )
      )
        ) %>%
      # Get matrix of alive species
      mutate(max_int_alive  = map2(max_int, bm_sp,
          function(mat, bm) {
            mask <- bm > 10^-6
            mat[mask, mask, drop = FALSE]
          }
        )
        )
  }
)
# Compute metrics of interest
simZ <- simZ_prep %>%
  mutate(
    persistence = richness / S,
    ct_alive = map_dbl(max_int_alive,
      ~ifelse(sum(.x) == 0, 0,
      sum(.x > 0) / ((ncol(.x) - 1)^2))),
    bm_sp_alive = map(bm_sp, ~.x[.x > 10^-6]),
    tlvl_alive = map2(tlvl, bm_sp, ~.x[.y > 10^-6]),
    max_tlvl_alive = map_dbl(tlvl_alive, max),
    w_avg_tlvl_alive = map2_dbl(tlvl_alive, bm_sp_alive, ~sum(.x * (.y / sum(.y)))),
    max_max_int_alive = map_dbl(max_int_alive,
      ~ifelse(length(.x[.x > 0]) == 0, 0, max(.x[.x > 0]))
      ),
    avg_max_int_alive = map_dbl(max_int_alive,
      ~ifelse(length(.x[.x > 0]) == 0, 0, mean(.x[.x > 0]))
      ),
    gini_max_int_alive = map_dbl(max_int_alive, ~gini(.x))
      )
```


```{r, eval = FALSE}
colnames(sim)
unique(simZ$env_stoch)
summary(simZ$total_biomass)
summary(simZ$persistence)
summary(simZ$ct_alive)
summary(simZ$gini_max_int_alive)
```



```{r}
simZ %>%
  filter(rho == 0) %>%
  mutate(stab_pop = 1/ avg_cv_sp) %>%
  pivot_longer(
    c(stab_com, stab_pop, sync, total_biomass),
    names_to = "metric",
    values_to = "stab") %>%
  ggplot(aes(x = richness, y = stab, color = factor(env_stoch))) +
  geom_point() +
  facet_grid(rows = vars(metric), cols = vars(productivity), scales = "free_y") +
  labs(
    color = "Evironmental stochasticity",
    x = "Species richness",
    y = "Stability component"
  )
```

```{r}
simZ %>%
  filter(rho == 1) %>%
  mutate(stab_pop = 1/ avg_cv_sp) %>%
  pivot_longer(
    c(stab_com, stab_pop, sync, total_biomass),
    names_to = "metric",
    values_to = "stab") %>%
  ggplot(aes(x = richness, y = stab, color = factor(env_stoch))) +
  geom_point() +
  facet_grid(rows = vars(metric), cols = vars(productivity), scales = "free_y") +
  labs(
    color = "Evironmental stochasticity",
    x = "Species richness",
    y = "Stability component"
  )
```


```{r}
p_basic <- ~corrplot::corrplot(
  cor(simZ %>%
    filter(productivity == "enrichment") %>%
    select(c(S, richness, ct, Z, ct_alive, total_biomass, avg_max_int_alive,
        w_avg_tlvl_alive, max_tlvl_alive, rho, env_stoch, stab_com, avg_cv_sp,
        sync)),
    method = "spearman"),
  diag = FALSE, type = "upper"
)
p_enrich <- ~corrplot::corrplot(
  cor(simZ %>%
    filter(productivity == "basic") %>%
    select(c(S, richness, ct, Z, ct_alive, total_biomass, avg_max_int_alive,
        w_avg_tlvl_alive, max_tlvl_alive, rho, env_stoch, stab_com, avg_cv_sp,
        sync)),
    method = "spearman"),
  diag = FALSE, type = "upper"
)
plot_grid(
  ggdraw(p_basic),
  ggdraw(p_enrich)
)
```

- Main results:
  - Stability increases with richness but not connectance (no overall effect)
  - Richness increases stability by increasing maximum and average trophic
    level, but also by decreasing interaction strength and increasing asymetry
    in trophic interaction, and finally by increasing total biomass (I need to control for that).
  - Synchrony decreases with species richness, max and average trophic level but increases with
    average interaction strength and symetry of interaction distributions.
  - Population varibility decreases with species richness, average and maximum
    trophic level, asymetry of interaction strength but it is increased by
    average interaction strength
  - Same effects of food-web structure on both Synchrony and Population variability
    - Surpringly, as in Danet et al. (2021), connectance has little effect on
      temporal stability and its components!


# Covariation

```{r}
compute_rotated_pca <- function(.data = NULL, naxis = 2) {
  .data <- na.omit(.data)
  pca <- ade4::dudi.pca(as.data.frame(.data),
    scannf = FALSE, nf = naxis, center = TRUE, scale = TRUE
  )
  pca_rotated <- psych::principal(.data,
    rotate = "varimax", nfactors = naxis,
    scores = TRUE
  )

  return(list(normal = pca, rotated = pca_rotated))
}
```


```{r}
library(glmmTMB)
sim_sem <- simZ %>%
  filter(rho == 0) %>%
  mutate(across(c(sync, avg_cv_sp, stab_com, richness, avg_max_int_alive, gini_max_int), log, , .names = "log_{.col}")) %>%
  mutate(
    log1_avg_max_int_alive = log(avg_max_int_alive + 1),
    productivity_f = factor(productivity)

    ) %>%
  as.data.frame() %>%
  select(c(
      ct_alive, log_richness, max_tlvl_alive, Z,
      gini_max_int, avg_max_int_alive, log1_avg_max_int_alive, env_stoch,
      log_stab_com, log_sync, log_avg_cv_sp, productivity, productivity_f)
  )
test <- sim_sem %>%
  mutate(across(where(is.double), ~scale(.x)[,1]))
```

```{r}
pred_may <- "log1_avg_max_int_alive*log_richness*ct_alive*productivity + env_stoch"
rand <- "(1 | Z)"

mod_may_single <- lm(formula(str_replace_all(paste0("log_stab_com ~ ", pred_may), "\\*", "+")), test)
performance::check_collinearity(mod_may_single)
```

```{r}
mod_may <- glmmTMB(formula(paste0("log_stab_com ~ ", pred_may, " + ", rand)), test)

r2_nakagawa(mod_may)
plot(parameters(mod_may))
```

```{r}
mod_may_sync <- glmmTMB(formula(paste0("log_sync ~ ", pred_may, " + ", rand)),
  test)
r2_nakagawa(mod_may_sync)
plot(parameters(mod_may_sync))
```

```{r}
mod_may_cv_sp <- glmmTMB(formula(paste0("log_avg_cv_sp ~ ", pred_may, " + ", rand)),
  test)
r2_nakagawa(mod_may_cv_sp)
plot(parameters(mod_may_cv_sp))
```

## Rho model

```{r}
sim_rho <- simZ %>%
  mutate(across(c(sync, avg_cv_sp, stab_com, richness, avg_max_int_alive, gini_max_int), log, , .names = "log_{.col}")) %>%
  mutate(
    log1_avg_max_int_alive = log(avg_max_int_alive + 1),
    productivity_f = factor(productivity)

    ) %>%
  as.data.frame() %>%
  select(c(
      ct_alive, log_richness, max_tlvl_alive, Z, rho,
      gini_max_int, avg_max_int_alive, log1_avg_max_int_alive, env_stoch,
      log_stab_com, log_sync, log_avg_cv_sp, productivity, productivity_f,
      persistence)
  )
sim_rho_scaled <- sim_rho %>%
  mutate(across(where(is.double), ~scale(.x)[,1]))
```


```{r}
pred_rho <- "log1_avg_max_int_alive * log_richness * rho +
log1_avg_max_int_alive * log_richness * productivity +
log1_avg_max_int_alive * log_richness * ct_alive +
log1_avg_max_int_alive * ct_alive * rho +
log1_avg_max_int_alive * ct_alive * rho +
log1_avg_max_int_alive * ct_alive * productivity +
log_richness * rho * productivity +
log_richness * ct_alive * productivity +
log_richness * ct_alive * rho +
env_stoch"
rand <- "(1 | Z)"

mod_rho_single <- lm(formula(str_replace_all(paste0("log_stab_com ~ ", pred_rho), "\\*", "+")),
  sim_rho_scaled)
performance::check_collinearity(mod_rho_single)
```

```{r}
mod_rho <- glmmTMB(formula(paste0("log_stab_com ~ ", pred_rho, " + ", rand)),
  sim_rho_scaled)

r2_nakagawa(mod_rho)
plot(parameters(mod_rho))
```

```{r}
mod_rho_sync <- glmmTMB(formula(paste0("log_sync ~ ", pred_rho, " + ", rand)),
  sim_rho_scaled)

r2_nakagawa(mod_rho_sync)
p_mod_rho_sync <- plot(parameters(mod_rho_sync))
```

```{r}
mod_rho_cv_sp <- glmmTMB(formula(paste0("log_avg_cv_sp ~ ", pred_rho, " + ", rand)),
  sim_rho_scaled)

r2_nakagawa(mod_rho_cv_sp)
p_mod_rho_cv_sp <- plot(parameters(mod_rho_cv_sp))
```

```{r}
plot_grid(
  p_mod_rho_sync,
  p_mod_rho_cv_sp
)
```


```{r}
sim_rho_pers <- simZ %>%
  mutate(across(c(S, ct, avg_max_int, gini_max_int), log, , .names = "log_{.col}")) %>%
  mutate(
    log1_avg_max_int = log(avg_max_int + 1),
    productivity_f = factor(productivity)
    ) %>%
  as.data.frame() %>%
  select(c(
      log_S, ct, max_tlvl, Z, rho,
      gini_max_int, avg_max_int, log1_avg_max_int, env_stoch,
      productivity, productivity_f,
      persistence)
  )
sim_rho_pers_scaled <- sim_rho_pers %>%
  mutate(across(where(is.double), ~scale(.x)[,1]))

pred_rho_pers <- "log1_avg_max_int * log_S * rho +
log1_avg_max_int * log_S * productivity +
log1_avg_max_int * log_S * ct +
log1_avg_max_int * ct * rho +
log1_avg_max_int * ct * rho +
log1_avg_max_int * ct * productivity +
log_S * rho * productivity +
log_S * ct * productivity +
log_S * ct * rho +
env_stoch"
rand <- "(1 | Z)"

mod_rho_pers <- glmmTMB(formula(paste0("persistence ~ ", pred_rho_pers, " + ", rand)),
  sim_rho_pers_scaled)

r2_nakagawa(mod_rho_pers)
plot(parameters(mod_rho_pers))
```

```{r}

```






# SEM


```{r}

sim_sem_basic <- sim_sem %>%
  filter(productivity == "basic")

sim_sem_enrich <- sim_sem %>%
  filter(productivity == "enrichment")
```

```{r}
pairs(
  sim_sem %>%
    select(ct_alive, log_richness, max_tlvl_alive,
      gini_max_int, log1_avg_max_int_alive, log_sync,
      log_avg_cv_sp, log_stab_com),
    pch = 19)
```

```{r}
sem_list <- list(
  max_tlvl = lm(max_tlvl_alive ~ log_richness + ct_alive, sim_sem),
  gini_max_int = lm(gini_max_int ~ log_richness + ct_alive + max_tlvl_alive, sim_sem),
  log_avg_max_int = lm(log1_avg_max_int_alive ~ log_richness + ct_alive + max_tlvl_alive + Z, sim_sem),
  log_sync = lm(log_sync ~ ct_alive + log_richness + max_tlvl_alive + gini_max_int, sim_sem),
  log_avg_cv_sp = lm(log_avg_cv_sp ~ ct_alive + log_richness + max_tlvl_alive +  gini_max_int, sim_sem),
  log_stab_com = lm(log_stab_com ~ log_sync + log_avg_cv_sp, sim_sem)
)

sem <- as.psem(sem_list)

ti <- psem(
  max_tlvl = lm(max_tlvl_alive ~ log_richness + ct_alive, sim_sem),
  gini_max_int = lm(gini_max_int ~ log_richness + ct_alive + max_tlvl_alive, sim_sem),
  log_avg_max_int = lm(log1_avg_max_int_alive ~ log_richness + ct_alive + max_tlvl_alive + Z, sim_sem),
  log_sync = lm(log_sync ~ ct_alive + log_richness + max_tlvl_alive + gini_max_int, sim_sem),
  log_avg_cv_sp = lm(log_avg_cv_sp ~ ct_alive + log_richness + max_tlvl_alive +  gini_max_int, sim_sem)
)

group_sem <- multigroup(ti, group = "productivity_f")
```

```{r}
sem_list_basic <- list(
  max_tlvl = lm(max_tlvl_alive ~ log_richness + ct_alive, sim_sem_basic),
  gini_max_int = lm(gini_max_int ~ log_richness + ct_alive + max_tlvl_alive, sim_sem_basic),
  log_avg_max_int = lm(log1_avg_max_int_alive ~ log_richness + ct_alive + max_tlvl_alive + Z, sim_sem_basic),
  log_sync = lm(log_sync ~ ct_alive + log_richness + max_tlvl_alive + gini_max_int, sim_sem),
  log_avg_cv_sp = lm(log_avg_cv_sp ~ ct_alive + log_richness + max_tlvl_alive +  gini_max_int, sim_sem_basic),
  log_stab_com = lm(log_stab_com ~ log_sync + log_avg_cv_sp, sim_sem_basic)
)

sem_basic <- as.psem(sem_list_basic)

map_dfr(setNames(sem_list_basic, names(sem_list_basic)), performance::check_collinearity, .id = "response")
map_dfr(sem_list_basic, rsquared)
summary(sem)$coefficients[, c(1, 2, 8, 9)]
```


```{r}
sem_int_list_basic <- list(
  max_tlvl = lm(max_tlvl_alive ~ log_richness + ct_alive + Z, sim_sem_basic),
  gini_max_int = lm(gini_max_int ~ log_richness + ct_alive + max_tlvl_alive + Z, sim_sem_basic),
  log_avg_max_int = lm(log1_avg_max_int_alive ~ log_richness + ct_alive + max_tlvl_alive + Z,
    sim_sem_basic),
  log_sync = lm(log_sync ~ log_richness + log1_avg_max_int_alive + max_tlvl_alive + gini_max_int + Z,
    sim_sem_basic),
  log_avg_cv_sp = lm(log_avg_cv_sp ~ log_richness + log1_avg_max_int_alive + max_tlvl_alive + gini_max_int + Z,
    sim_sem_basic),
  log_stab_com = lm(log_stab_com ~ log_sync + log_avg_cv_sp,
    sim_sem_basic)
)

sem_int_basic <- as.psem(sem_int_list_basic)
plot(sem_int_basic)
```

```{r}
map_dfr(setNames(sem_int_list_basic, names(sem_int_list_basic)),
  performance::check_collinearity, .id = "response")
map_dfr(sem_int_list_basic, rsquared)
summary(sem_int_basic)$coefficients[, c(1, 2, 8, 9)]
```




```{r}
sem_int_list_enrich <- list(
  max_tlvl = lm(max_tlvl_alive ~ log_richness + ct_alive + Z, sim_sem_enrich),
  gini_max_int = lm(gini_max_int ~ log_richness + ct_alive + max_tlvl_alive + Z, sim_sem_enrich),
  log_avg_max_int = lm(log1_avg_max_int_alive ~ log_richness + ct_alive + max_tlvl_alive + Z, sim_sem_enrich),
  log_sync = lm(log_sync ~ log_richness + log1_avg_max_int_alive + max_tlvl_alive + gini_max_int + Z, sim_sem_enrich),
  log_avg_cv_sp = lm(log_avg_cv_sp ~ log_richness + log1_avg_max_int_alive + max_tlvl_alive + gini_max_int + Z, sim_sem_enrich),
  log_stab_com = lm(log_stab_com ~ log_sync + log_avg_cv_sp, sim_sem_enrich)
)

sem_int_enrich <- as.psem(sem_int_list_enrich)
plot(sem_int_enrich)
```

```{r}
map_dfr(setNames(sem_int_list_enrich, names(sem_int_list_enrich)),
  performance::check_collinearity, .id = "response")
map_dfr(sem_int_list_enrich, rsquared)
summary(sem_int_enrich)$coefficients[, c(1, 2, 8, 9)]
```

```{r}
summary(sem_int_basic)$coefficients[, c(1, 2, 8, 9)]
summary(sem_int_enrich)$coefficients[, c(1, 2, 8, 9)]
```

```{r}
boot_int_basic <- semEff(sem_int_basic, R = 50, ci.type =  "perc")
boot_int_enrich <- semEff(sem_int_enrich, R = 50, ci.type =  "perc")
summary(boot_int_basic)
summary(boot_int_enrich)
```
```{r}
tot_sem_int <- rbind(
  from_semEff_to_table(boot_int_basic) %>%
    mutate(productivity = "basic"),
  from_semEff_to_table(boot_int_enrich) %>%
    mutate(productivity = "enrichment")
)
```

```{r}
tot_sem_int %>%
  filter(
    effect_type == "total",
    response %in% c("log_stab_com", "log_sync", "log_avg_cv_sp"),
    !predictor %in% c("log_sync", "log_avg_cv_sp"),

    ) %>%
  ggplot(aes(
      y = predictor, x = effect,
      xmin = lower_ci, xmax = upper_ci,
      color = productivity)
    ) +
  geom_pointrange() +
  facet_grid(cols = vars(response))
```


# Effect of species richness

```{r}
unique(simZ$Z)
```




```{r}
sim_rich_prod <- simZ %>%
  filter(
    Z == 100,
    env_stoch == .5,
    rho %in% c(0, 1)
  )
```

```{r}
p_sim_rich_prod <- sim_rich_prod %>%
  mutate(stab_pop = 1/ avg_cv_sp) %>%
  pivot_longer(
    c(stab_com, stab_pop, sync),
    names_to = "metric",
    values_to = "stab") %>%
  mutate(
    metric = var_replacement()[metric],
    rho = rho_replacement()[as.character(rho)]
  ) %>%
  ggplot(aes(x = richness, y = stab, color = factor(productivity))) +
  geom_point(alpha = .1, shape = 20) +
  geom_smooth() +
  facet_grid(rows = vars(metric), cols = vars(rho), scales = "free_y") +
  labs(
    color = "Productivity",
    x = "Species richness",
    y = "Stability component"
  ) +
  scale_x_continuous(
    sec.axis = sec_axis(~ . ,
      name = "Response diversity",
      breaks = NULL,
      labels = NULL)
  )
ggsave(
  filename = here::here("fig", "stability_rich.pdf"),
  p_sim_rich_prod,
  scale = 1.8,
  width = 88,
  height = 88 * .6,
  units = "mm"
)
```

```{r}
sim_rich_prod %>%
  mutate(stab_pop = 1/ avg_cv_sp) %>%
  pivot_longer(
    c(stab_com, stab_pop, sync),
    names_to = "metric",
    values_to = "stab") %>%
  mutate(
    metric = var_replacement()[metric],
    rho = rho_replacement()[as.character(rho)]
  ) %>%
  ggplot(aes(x = avg_max_int_alive, y = stab, color = factor(productivity))) +
  geom_point(alpha = .1, shape = 20) +
  geom_smooth() +
  facet_grid(rows = vars(metric), cols = vars(rho), scales = "free_y")
```

```{r}
library(easystats)

sim_sem <- simZ %>%
  filter(env_stoch == .5) %>%
  mutate(across(c(sync, avg_cv_sp, stab_com, richness, avg_max_int_alive, gini_max_int), log, , .names = "log_{.col}")) %>%
  mutate(
    log1_avg_max_int_alive = log(avg_max_int_alive + 1),
    productivity_f = factor(productivity)

    ) %>%
  as.data.frame() %>%
  select(c(
      ct_alive, log_richness, max_tlvl_alive, Z, rho, w_avg_tlvl_alive,
      gini_max_int, avg_max_int_alive, log1_avg_max_int_alive, env_stoch,
      log_stab_com, log_sync, log_avg_cv_sp, productivity, productivity_f)
  )

#model <- lm(log_stab_com ~ log_richness * log1_avg_max_int_alive * rho * productivity_f, data = sim_sem)
#
#vizdata <- sim_sem %>%
#  visualisation_matrix(at = c("log_richness", "log1_avg_max_int_alive"), length = 2) %>%
#  visualisation_matrix("ct_alive", length = 3, numerics = "all")
#vizdata$Predicted <- insight::get_predicted(model, vizdata)
#vizdata
```

```{r}
sim_sem %>%
  filter(log1_avg_max_int_alive > 0, rho == 0) %>%
  mutate(
   cat_log1_avg_max_int_alive = cut(
     log1_avg_max_int_alive,
     breaks= 3, ordered_result = TRUE)

  ) %>%
  ggplot(aes(x = log_richness, y = log_stab_com, color =
      cat_log1_avg_max_int_alive)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_grid(cols = vars(productivity_f)) +
  #  geom_line(data = vizdata, aes(y = Predicted, group = log1_avg_max_int_alive), size = 1) +
  theme_modern()
```

```{r}
sim_sem %>%
  filter(rho == 0) %>%
  mutate(
   cat_max_tlvl_alive = cut(
     max_tlvl_alive,
     breaks= 3, ordered_result = TRUE)
  ) %>%
  ggplot(aes(x = log_richness, y = log_stab_com, color =
      cat_max_tlvl_alive)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_grid(cols = vars(productivity_f)) +
  #  geom_line(data = vizdata, aes(y = Predicted, group = log1_avg_max_int_alive), size = 1) +
  theme_modern()
```

```{r}
sim_sem %>%
  filter(rho == 0) %>%
  mutate(
   cat_w_avg_tlvl_alive = cut(
     w_avg_tlvl_alive,
     breaks= 3, ordered_result = TRUE)
  ) %>%
  ggplot(aes(
      x = log_richness,
      y = log_stab_com,
      color = cat_w_avg_tlvl_alive)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_grid(cols = vars(productivity_f)) +
  #  geom_line(data = vizdata, aes(y = Predicted, group = log1_avg_max_int_alive), size = 1) +
  theme_modern()
```


```{r}
sim_sem %>%
  filter(rho == 0) %>%
  mutate(
   cat_ct_alive = cut(
     ct_alive,
     breaks = 3,
     ordered_result = TRUE)
  ) %>%
  ggplot(aes(x = log_richness, y = log_stab_com, color =
      cat_ct_alive)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_grid(cols = vars(productivity_f)) +
  theme_modern()
```


```{r}
sim_sem %>%
  ggplot(aes(x = log_richness, y = log_stab_com, color =
      as.factor(rho))) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_grid(cols = vars(productivity_f)) +
  #  geom_line(data = vizdata, aes(y = Predicted, group = log1_avg_max_int_alive), size = 1) +
  theme_modern()
```

```{r}
sim_rich_prod %>%
  mutate(stab_pop = 1/ avg_cv_sp) %>%
  pivot_longer(
    c(stab_com, stab_pop, sync),
    names_to = "metric",
    values_to = "stab") %>%
  mutate(
    metric = var_replacement()[metric],
    rho = rho_replacement()[as.character(rho)]
  ) %>%
  ggplot(aes(x = max_tlvl_alive, y = stab, color = factor(productivity))) +
  geom_point(alpha = .1, shape = 20) +
  geom_smooth() +
  facet_grid(rows = vars(metric), cols = vars(rho), scales = "free_y")
```


