---
title: Simulation connectance richness
author: Alain Danet
output:
  bookdown::pdf_document2
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  cache = FALSE,
  collapse = TRUE,
  comment = "#>",
  #fig.dim = c(7, 7),
  fig.fullwidth = TRUE,
  fig.show = "hold",
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  results = TRUE,
  fig.path="figures/"
)
```

```{r, results = FALSE}
library(tidyverse)
library(magrittr)
library(cowplot)
library(here)
library(arrow)
library(piecewiseSEM)
library(semEff)

mytheme <- theme_cowplot(font_size = 8) +
background_grid() +
theme(legend.position = "bottom")


theme_set(mytheme)
```
```{r}
sim_brut <- open_dataset(
  here::here("res", "sim_cs.arrow"),
  #here::here("res", "sim_cs_stdK.arrow"),
  format = "arrow")
sim <- sim_brut %>%
  collect() %>%
  mutate(across(where(is.list), as.list)) %>%
  mutate(across(c(int_strength, max_int),
      ~map2(.x, S,
        function(y, rich) {
          matrix(y, nrow = rich)
        }
      )
  )
    ) %>%
  mutate(max_int_alive  = map2(max_int, bm_sp,
      function(mat, bm) {
        mask <- bm > 10^-16
        mat[mask, mask]
      }
      ),
    ct_alive = map_dbl(max_int_alive, ~ sum(.x > 0) / ((ncol(.x) - 1)^2)),
    bm_sp_alive = map(bm_sp, ~.x[.x > 10^-16]),
    tlvl_alive = map2(tlvl, bm_sp, ~.x[.y > 10^-16]),
    max_tlvl_alive = map_dbl(tlvl_alive, max),
    w_avg_tlvl_alive = map2_dbl(tlvl_alive, bm_sp_alive, ~sum(.x * (.y / sum(.y)))),
    max_max_int_alive = map_dbl(max_int_alive, ~max(.x[.x > 0])),
    avg_max_int_alive = map_dbl(max_int_alive, ~mean(.x[.x > 0])),
    #gini_max_int_alive = map_dbl(max_int_alive, ),
  )
```
```{r}
simZ <- open_dataset(here::here("res", "sim_csZ.arrow"),
  format = "arrow") %>%
  collect()
simZ2 <- open_dataset(here::here("res", "sim_csZ2.arrow"),
  format = "arrow") %>%
  collect()

# TODO set extinction threshold in simulations
simZ <- map_dfr(list(simZ, simZ2),
  function (x) {
    x %>%
      filter(!is.na(richness)) %>%
      mutate(across(where(is.list), as.list)) %>%
      mutate(across(c(int_strength, max_int),
          ~map2(.x, S,
            function(y, rich) {
              matrix(y, nrow = rich)
            }
          )
      )
        ) %>%
      mutate(max_int_alive  = map2(max_int, bm_sp,
          function(mat, bm) {
            mask <- bm > 10^-16
            mat[mask, mask]
          }
          ),
        ct_alive = map_dbl(max_int_alive, ~ sum(.x > 0) / ((ncol(.x) - 1)^2)),
        bm_sp_alive = map(bm_sp, ~.x[.x > 10^-16]),
        tlvl_alive = map2(tlvl, bm_sp, ~.x[.y > 10^-16]),
        max_tlvl_alive = map_dbl(tlvl_alive, max),
        w_avg_tlvl_alive = map2_dbl(tlvl_alive, bm_sp_alive, ~sum(.x * (.y / sum(.y)))),
        max_max_int_alive = map_dbl(max_int_alive, ~max(.x[.x > 0])),
        avg_max_int_alive = map_dbl(max_int_alive, ~mean(.x[.x > 0])),
        #gini_max_int_alive = map_dbl(max_int_alive, ),
      )


  }
) %>%
filter(max_max_int_alive != -Inf) %>%
mutate(persistence = richness / S)
```


```{r, eval = FALSE}
colnames(sim)
unique(sim$env_stoch)
summary(sim$total_biomass)
```



```{r}
sim %>%
  mutate(stab_pop = 1/ avg_cv_sp) %>%
  pivot_longer(
    c(stab_com, stab_pop, sync),
    names_to = "metric",
    values_to = "stab") %>%
  ggplot(aes(x = richness, y = stab)) +
  geom_point() +
  facet_grid(rows = vars(metric), scales = "free_y") +
  labs(
    color = "Connectance",
    x = "Species richness",
    y = "Stability component"
  )
```

```{r}
corrplot::corrplot(
  cor(sim %>% select(
      c(S, richness, ct, ct_alive, total_biomass, avg_max_int_alive, w_avg_tlvl_alive,
        max_tlvl_alive, rho, env_stoch, stab_com, avg_cv_sp, sync
        )
      ),
    method = "spearman"),
  diag = FALSE, type = "upper"
)
```

- Main results:
  - Stability increases with richness but not connectance (no overall effect)
  - Richness increases stability by increasing maximum and average trophic
    level, but also by decreasing interaction strength and increasing asymetry
    in trophic interaction, and finally by increasing total biomass (I need to control for that).
  - Synchrony decreases with species richness, max and average trophic level but increases with
    average interaction strength and symetry of interaction distributions.
  - Population varibility decreases with species richness, average and maximum
    trophic level, asymetry of interaction strength but it is increased by
    average interaction strength
  - Same effects of food-web structure on both Synchrony and Population variability
    - Surpringly, as in Danet et al. (2021), connectance has little effect on
      temporal stability and its components!


# Covariation

It seems that the effects of food-web structure are mainly richness effects!

```{r}
sim %>%
  mutate(stab_pop = 1/ avg_cv_sp) %>%
  pivot_longer(
    c(stab_com, stab_pop, sync),
    names_to = "metric",
    values_to = "stab") %>%
  ggplot(aes(x = avg_max_int_alive, y = stab, color = richness)) +
  geom_point() +
  geom_smooth() +
  facet_grid(rows = vars(metric), scales = "free_y") +
  labs(
    color = "Richness",
    x = "Avg interaction strength",
    y = "Stability component"
  )

```

```{r}
sim%>%
  mutate(stab_pop = 1/ avg_cv_sp) %>%
  pivot_longer(
    c(stab_com, stab_pop, sync),
    names_to = "metric",
    values_to = "stab") %>%
  ggplot(aes(x = gini_max_int, y = stab, color = richness)) +
  geom_point() +
  geom_smooth() +
  facet_grid(rows = vars(metric), scales = "free_y") +
  labs(
    color = "Richness",
    x = "Gini interaction strength",
    y = "Stability component"
  )

```

```{r}
sim %>%
  mutate(stab_pop = 1/ avg_cv_sp) %>%
  pivot_longer(
    c(stab_com, stab_pop, sync),
    names_to = "metric",
    values_to = "stab") %>%
  ggplot(aes(x = ct_alive, y = stab, color = richness)) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_grid(rows = vars(metric), scales = "free_y") +
  labs(
    color = "Richness",
    x = "Connectance",
    y = "Stability component"
  )
```

```{r}
sim %>%
  mutate(stab_pop = 1/ avg_cv_sp) %>%
  pivot_longer(
    c(stab_com, stab_pop, sync),
    names_to = "metric",
    values_to = "stab") %>%
  ggplot(aes(x = max_tlvl_alive, y = stab, color = richness)) +
  geom_point() +
  geom_smooth() +
  facet_grid(rows = vars(metric), scales = "free_y") +
  labs(
    color = "Richness",
    x = "Avg trophic level",
    y = "Stability component"
  )
```

# SEM


```{r}
sim_sem <- sim %>%
  filter(rho == 0, env_stoch == .5) %>%
  mutate(across(c(sync, avg_cv_sp, stab_com, richness, avg_max_int_alive, gini_max_int), log, , .names = "log_{.col}")) %>%
  as.data.frame() %>%
  select(c(ct_alive, log_richness, max_tlvl_alive, Z, gini_max_int, log_avg_max_int_alive, env_stoch, log_stab_com, log_sync, log_avg_cv_sp))
```

```{r}
pairs(
  sim_sem %>%
    select(ct_alive, log_richness, max_tlvl_alive,
      gini_max_int, log_avg_max_int_alive, log_sync,
      log_avg_cv_sp, log_stab_com),
    pch = 19)
```

```{r}
sem_list <- list(
  max_tlvl = lm(max_tlvl_alive ~ log_richness + ct_alive, sim_sem),
  gini_max_int = lm(gini_max_int ~ log_richness + ct_alive + max_tlvl_alive, sim_sem),
  log_avg_max_int = lm(log_avg_max_int_alive ~ log_richness + ct_alive + max_tlvl_alive, sim_sem),
  log_sync = lm(log_sync ~ ct_alive + log_richness + max_tlvl_alive + gini_max_int, sim_sem),
  log_avg_cv_sp = lm(log_avg_cv_sp ~ ct_alive + log_richness + max_tlvl_alive +  gini_max_int, sim_sem),
  log_stab_com = lm(log_stab_com ~ log_sync + log_avg_cv_sp, sim_sem)
)

sem <- as.psem(sem_list)
```

```{r}
map_dfr(setNames(sem_list, names(sem_list)), performance::check_collinearity)
map_dfr(sem_list, rsquared)
summary(sem)$coefficients[, c(1, 2, 8, 9)]
```

```{r}
plot(sem)
```

```{r}
boot_eff <- semEff(sem, R = 50, ci.type =  "perc")
summary(boot_eff)
```


```{r}
sem_int_list <- list(
  max_tlvl = lm(max_tlvl_alive ~ log_richness + ct_alive, sim_sem),
  gini_max_int = lm(gini_max_int ~ log_richness + ct_alive + max_tlvl_alive, sim_sem),
  log_avg_max_int = lm(log_avg_max_int_alive ~ log_richness + ct_alive + max_tlvl_alive, sim_sem),
  log_sync = lm(log_sync ~ log_richness + log_avg_max_int_alive + max_tlvl_alive + gini_max_int, sim_sem),
  log_avg_cv_sp = lm(log_avg_cv_sp ~ log_richness + log_avg_max_int_alive + max_tlvl_alive + gini_max_int, sim_sem),
  log_stab_com = lm(log_stab_com ~ log_sync + log_avg_cv_sp, sim_sem)
)

sem_int <- as.psem(sem_int_list)
plot(sem_int)
```

```{r}
map(setNames(sem_int_list, names(sem_int_list)), performance::check_collinearity)
map_dfr(sem_int_list, rsquared)
summary(sem_int)$coefficients[, c(1, 2, 8, 9)]
```

```{r}
boot_int <- semEff(sem_int, R = 50, ci.type =  "perc")
summary(boot_int)
```

# With Z

```{r}
colnames(simZ)
corrplot::corrplot(
  cor(simZ %>%
    select(
      c(S, richness, persistence, ct, ct_alive, total_biomass, avg_max_int_alive,
        max_max_int_alive, gini_max_int, w_avg_tlvl_alive, max_tlvl_alive, Z,
        rho, env_stoch, stab_com, avg_cv_sp, sync
        )
      ),
    method = "spearman"),
  diag = FALSE, type = "upper"
)
```

```{r}
unique(simZ$richness)
simZ %>%
  ggplot(aes(x = as.factor(Z), y = avg_cv_sp, fill = richness)) +
  geom_boxplot()
```

```{r}
sim_sem <- simZ %>%
  filter(S == richness) %>%
  filter(rho == 0) %>%
  mutate(across(c(sync, avg_cv_sp, stab_com, richness, avg_max_int_alive, gini_max_int), log, , .names = "log_{.col}")) %>%
  select(c(ct_alive, log_richness, max_tlvl_alive, Z, gini_max_int, log_avg_max_int_alive, env_stoch, log_stab_com, log_sync, log_avg_cv_sp)) %>%
  as.data.frame()
```


```{r}
sem_int_list <- list(
  ct = lm(ct_alive ~ log_richness, sim_sem),
  max_tlvl = lm(max_tlvl_alive ~ log_richness + Z + ct_alive, sim_sem),
  gini_max_int = lm(gini_max_int ~ log_richness + ct_alive + max_tlvl_alive + Z, sim_sem),
  log_avg_max_int = lm(log_avg_max_int_alive ~ log_richness + ct_alive + max_tlvl_alive + Z, sim_sem),
  log_sync = lm(log_sync ~ log_richness + log_avg_max_int_alive + max_tlvl_alive + gini_max_int + env_stoch + Z, sim_sem),
  log_avg_cv_sp = lm(log_avg_cv_sp ~ log_richness + log_avg_max_int_alive + max_tlvl_alive + gini_max_int + env_stoch + Z, sim_sem),
  log_stab_com = lm(log_stab_com ~ log_sync + log_avg_cv_sp, sim_sem)
)

sem_int <- as.psem(sem_int_list)
plot(sem_int)
```

```{r}
map(setNames(sem_int_list, names(sem_int_list)), performance::check_collinearity)
map_dfr(sem_int_list, rsquared)
summary(sem_int)$coefficients[, c(1, 2, 8, 9)]
```

```{r}
summary(sim_sem$richness)
summary(sim_sem$S)
summary(sim_sem$persistence)
```

```{r}
boot_int <- semEff(sem_int, ci.type = "perc", R = 50, ncpus = 2)
summary(boot_int)
```


```{r}
unique(simZ$Z)
sim_sem <- simZ %>%
  filter(rho == 0, Z == 50) %>%
  mutate(across(c(sync, avg_cv_sp, stab_com, richness, avg_max_int_alive, gini_max_int), log, , .names = "log_{.col}")) %>%
  select(c(ct_alive, log_richness, max_tlvl_alive, Z, gini_max_int, log_avg_max_int_alive, env_stoch, log_stab_com, log_sync, log_avg_cv_sp)) %>%
  as.data.frame()
```


```{r}
sem_int_list <- list(
  ct = lm(ct_alive ~ log_richness, sim_sem),
  max_tlvl = lm(max_tlvl_alive ~ log_richness + ct_alive, sim_sem),
  gini_max_int = lm(gini_max_int ~ log_richness + ct_alive + max_tlvl_alive , sim_sem),
  log_avg_max_int = lm(log_avg_max_int_alive ~ log_richness + ct_alive + max_tlvl_alive, sim_sem),
  log_sync = lm(log_sync ~ log_richness + log_avg_max_int_alive + max_tlvl_alive + gini_max_int + env_stoch , sim_sem),
  log_avg_cv_sp = lm(log_avg_cv_sp ~ log_richness + log_avg_max_int_alive + max_tlvl_alive + gini_max_int + env_stoch , sim_sem),
  log_stab_com = lm(log_stab_com ~ log_sync + log_avg_cv_sp, sim_sem)
)

sem_int <- as.psem(sem_int_list)
plot(sem_int)
```

```{r}
boot_int <- semEff(sem_int, ci.type = "perc", R = 50, ncpus = 2)
summary(boot_int)
```


```{r}
unique(simZ$Z)
sim_sem <- simZ %>%
  filter(rho == 1) %>%
  mutate(across(c(ct_alive, sync, avg_cv_sp, stab_com, richness, avg_max_int_alive, gini_max_int), log, .names = "log_{.col}")) %>%
  select(c(log_ct_alive, log_richness, max_tlvl_alive, Z, gini_max_int, log_avg_max_int_alive, env_stoch, log_stab_com, log_sync, log_avg_cv_sp)) %>%
  as.data.frame()
pairs(sim_sem, pch = 19)
```



```{r}
sem_int_list <- list(
  ct = lm(log_ct_alive ~ log_richness, sim_sem),
  max_tlvl = lm(max_tlvl_alive ~ log_richness + Z, sim_sem),
  gini_max_int = lm(gini_max_int ~ log_ct_alive + max_tlvl_alive , sim_sem),
  log_avg_max_int = lm(log_avg_max_int_alive ~ log_ct_alive + max_tlvl_alive + Z, sim_sem),
  log_sync = lm(log_sync ~ log_richness + log_avg_max_int_alive + gini_max_int + env_stoch, sim_sem),
  log_avg_cv_sp = lm(log_avg_cv_sp ~ log_richness + log_avg_max_int_alive + gini_max_int + env_stoch , sim_sem),
  log_stab_com = lm(log_stab_com ~ log_sync + log_avg_cv_sp, sim_sem)
)

sem_int <- as.psem(sem_int_list)
plot(sem_int)
```

```{r}
map(setNames(sem_int_list, names(sem_int_list)), performance::check_collinearity)
map_dfr(sem_int_list, rsquared)
summary(sem_int)$coefficients[, c(1, 2, 8, 9)]
```

```{r}
boot_int <- semEff(sem_int, ci.type = "perc", R = 50, ncpus = 2)
summary(boot_int)
```

```{r}
simZ %>%
  ggplot(aes(y = persistence, x = as.factor(Z))) +
  geom_boxplot()
```

