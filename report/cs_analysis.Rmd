---
title: Simulation connectance richness
author: Alain Danet
output:
  bookdown::pdf_document2
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  cache = FALSE,
  collapse = TRUE,
  comment = "#>",
  #fig.dim = c(7, 7),
  fig.fullwidth = TRUE,
  fig.show = "hold",
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  results = TRUE,
  fig.path="figures/"
)
```

```{r, results = FALSE}
library(tidyverse)
library(magrittr)
library(cowplot)
library(here)

mytheme <- theme_cowplot(font_size = 8) +
background_grid() +
theme(legend.position = "bottom")


theme_set(mytheme)
```

```{r}
df_brut <- read_csv(here::here("res", "cs_sim.csv"))
df <- df_brut %>%
  select(where(is.double))
summary(df)
```

```{r}
df %>%
  filter(stab_com <= 1000) %>%
  mutate(stab_pop = 1/ avg_cv_sp) %>%
  pivot_longer(
    c(stab_com, stab_pop, sync),
    names_to = "metric",
    values_to = "stab") %>%
  ggplot(aes(x = as.factor(richness), y = stab, color = as.factor(ct))) +
  geom_boxplot() +
  facet_grid(rows = vars(metric), scales = "free_y") +
  labs(
    color = "Connectance",
    x = "Species richness",
    y = "Stability component"
  )
```

```{r}
corrplot::corrplot(
  cor(df %>% select(-rep, -Z, -env_stoch, -sim_timing), method = "spearman"),
  diag = FALSE, type = "upper"
)
```

- Main results:
  - Stability increases with richness but not connectance (no overall effect)
  - Richness increases stability by increasing maximum and average trophic
    level, but also by decreasing interaction strength and increasing asymetry
    in trophic interaction, and finally by increasing total biomass (I need to control for that).
  - Synchrony decreases with species richness, max and average trophic level but increases with
    average interaction strength and symetry of interaction distributions.
  - Population varibility decreases with species richness, average and maximum
    trophic level, asymetry of interaction strength but it is increased by
    average interaction strength
  - Same effects of food-web structure on both Synchrony and Population variability
    - Surpringly, as in Danet et al. (2021), connectance has little effect on
      temporal stability and its components!


# Covariation

It seems that the effects of food-web structure are mainly richness effects!

```{r}
df %>%
  filter(stab_com <= 1000) %>%
  mutate(stab_pop = 1/ avg_cv_sp) %>%
  pivot_longer(
    c(stab_com, stab_pop, sync),
    names_to = "metric",
    values_to = "stab") %>%
  ggplot(aes(x = avg_max_int, y = stab, color = as.factor(richness))) +
  geom_point() +
  geom_smooth() +
  facet_grid(rows = vars(metric), scales = "free_y") +
  labs(
    color = "Richness",
    x = "Avg interaction strength",
    y = "Stability component"
  )

```

```{r}
df %>%
  filter(stab_com <= 1000) %>%
  mutate(stab_pop = 1/ avg_cv_sp) %>%
  pivot_longer(
    c(stab_com, stab_pop, sync),
    names_to = "metric",
    values_to = "stab") %>%
  ggplot(aes(x = gini_max_int, y = stab, color = as.factor(richness))) +
  geom_point() +
  geom_smooth() +
  facet_grid(rows = vars(metric), scales = "free_y") +
  labs(
    color = "Richness",
    x = "Gini interaction strength",
    y = "Stability component"
  )

```

```{r}
df %>%
  filter(stab_com <= 1000) %>%
  mutate(stab_pop = 1/ avg_cv_sp) %>%
  pivot_longer(
    c(stab_com, stab_pop, sync),
    names_to = "metric",
    values_to = "stab") %>%
  ggplot(aes(x = ct, y = stab, color = as.factor(richness))) +
  geom_point() +
  geom_smooth(method = "lm") +
  facet_grid(rows = vars(metric), scales = "free_y") +
  labs(
    color = "Richness",
    x = "Connectance",
    y = "Stability component"
  )
```

```{r}
df %>%
  filter(stab_com <= 1000) %>%
  mutate(stab_pop = 1/ avg_cv_sp) %>%
  pivot_longer(
    c(stab_com, stab_pop, sync),
    names_to = "metric",
    values_to = "stab") %>%
  ggplot(aes(x = w_avg_tlvl, y = stab, color = as.factor(richness))) +
  geom_point() +
  geom_smooth() +
  facet_grid(rows = vars(metric), scales = "free_y") +
  labs(
    color = "Richness",
    x = "Avg trophic level",
    y = "Stability component"
  )
```

# SEM

```{r}
library(piecewiseSEM)
library(semEff)
```

```{r}
df_sem <- df %>%
  filter(stab_com < 1000) %>%
  mutate(across(c(sync, avg_cv_sp, stab_com, richness, avg_max_int, gini_max_int), log, , .names = "log_{.col}"))
```

```{r}
pairs(
  df_sem %>%
    select(ct, log_richness, max_tlvl,
      log_gini_max_int, log_avg_max_int, log_sync,
      log_avg_cv_sp, log_stab_com),
    pch = 19)
```

```{r}
sem_list <- list(
  max_tlvl = lm(max_tlvl ~ log_richness + ct, df_sem),
  gini_max_int = lm(gini_max_int ~ log_richness + ct + max_tlvl, df_sem),
  log_avg_max_int = lm(log_avg_max_int ~ log_richness + ct + max_tlvl, df_sem),
  log_sync = lm(log_sync ~ ct + log_richness + max_tlvl + gini_max_int, df_sem),
  log_avg_cv_sp = lm(log_avg_cv_sp ~ ct + log_richness + max_tlvl +  gini_max_int, df_sem),
  log_stab_com = lm(log_stab_com ~ log_sync + log_avg_cv_sp, df_sem)#~,
  #log_avg_max_int %~~% log_richness
)

sem <- as.psem(sem_list)
```

```{r}
map_dfr(setNames(sem_list, names(sem_list)), performance::check_collinearity)
map_dfr(sem_list, rsquared)
summary(sem)
```

```{r}
plot(sem)
```

```{r}
boot_eff <- semEff(sem, R = 50, ci.type =  "perc")
summary(boot_eff)
```


```{r}
sem_int_list <- list(
  max_tlvl = lm(max_tlvl ~ log_richness + ct, df_sem),
  gini_max_int = lm(gini_max_int ~ log_richness + ct + max_tlvl, df_sem),
  log_avg_max_int = lm(log_avg_max_int ~ log_richness + ct + max_tlvl, df_sem),
  log_sync = lm(log_sync ~ log_richness + log_avg_max_int + gini_max_int, df_sem),
  log_avg_cv_sp = lm(log_avg_cv_sp ~ log_richness + log_avg_max_int + gini_max_int, df_sem),
  log_stab_com = lm(log_stab_com ~ log_sync + log_avg_cv_sp, df_sem)
)

sem_int <- as.psem(sem_int_list)
plot(sem_int)
```

```{r}
map(setNames(sem_int_list, names(sem_int_list)), performance::check_collinearity)
map_dfr(sem_list, rsquared)
summary(sem)
```

```{r}
boot_int <- semEff(sem_int, R = 50, ci.type =  "perc")
summary(boot_int)
```

