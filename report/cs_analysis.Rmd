---
title: Simulation connectance richness
author: Alain Danet
output:
  bookdown::pdf_document2
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  cache = FALSE,
  collapse = TRUE,
  comment = "#>",
  fig.pos = "H",  # pdf mode
  #fig.dim = c(7, 7),
  fig.fullwidth = TRUE,
  fig.show = "hold",
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  results = TRUE,
  fig.path="figures/"
)
```

```{r, results = FALSE}
library(tidyverse)
library(magrittr)
library(ggcorrplot)
library(cowplot)
library(here)
library(arrow)
library(piecewiseSEM)
library(semEff)
library(easystats)
library(glmmTMB)
library(targets)

library(rpart)
library(rpart.plot)
library(caret)
library(ipred)
library(kableExtra)

mytheme <- theme_cowplot(font_size = 8) +
background_grid() +
theme(legend.position = "bottom")
theme_set(mytheme)
source(here::here("R", "network_metrics.R"))
source(here::here("R", "string_replacements.R"))
```

```{r, eval = FALSE}
colnames(sim)
unique(simZ$env_stoch)
summary(simZ$total_biomass)
summary(simZ$persistence)
summary(simZ$ct_alive)
summary(simZ$gini_max_int_alive)
```

# Introduction

- Response diversity is key in driving stability in ecological communities
- Response diversity control asynchrony with richness
- Mainly done in plants or in same food-web modules
- Food-webs structure can also modulate synchrony and population stability by
  the strength of trophic interactions

# Research questions

For me, there are two ways to see the question.

##  What are the mecanisms driving stability in food-webs ?

- How structure of food-webs (connectance, species richness, prey-predator
     size ratio) gives emergence to food-web structure (max trophic level,
     weighted avg trophic level, omnivory) ?
- How food-web structure influence biomass fluxes (avg interaction
     strength, sd of interaction strength, asymetry)?
- How food-web structure and biomass fluxes affect stability components?
     total biomass, species variability, statistical averaging, evenness,
     compensatory dynamics (interaction and environment)?

## What is the effects of species richness on stability facing multiple stressors in competitive and food-webs communities?

- How do species richness drive average population stability and asynchrony
  in competitive and food-webs communities ?
- How is it affected by enrichment and response diversity?

# Material & Methods


## Bioenergetic model

TO Complete

- Important bits:
  - Niche model (Connectance highly constrained by richness)
  - Type III functional response
  - No predator interference
  - Enrichment: K = 1 or 20
  - Standardized carrying capacity (Remove the effect of species richness on
    total biomass, i.e. remove the effect of niche complementarity on biomass
    produced by primary producers)

## Variables

- S: 5 to 60
- C: .02 to .3
- K: 1 and 20
- $\rho$: 0 to 1
- Z: 5 to 1000

```{r}
tar_load(simZ)
tar_load(sim_rho)
tar_load(sim_rho_scaled)
```


```{r}
cor_enrich <- cor(simZ %>%
    filter(productivity == "enrichment") %>%
    select(c(S, richness, ct, Z, ct_alive, total_biomass, avg_max_int_alive,
        sd_max_int_alive, cv_max_int_alive,
        gini_max_int_alive,
        w_avg_tlvl_alive, max_tlvl_alive, rho, env_stoch, stab_com, avg_cv_sp,
        sync)) %>% na.omit(),
    method = "spearman")
cor_basic <- cor(simZ %>%
    filter(productivity == "basic") %>%
select(c(S, richness, ct, Z, ct_alive, total_biomass, avg_max_int_alive,
        sd_max_int_alive, cv_max_int_alive,
        gini_max_int_alive,
        w_avg_tlvl_alive, max_tlvl_alive, rho, env_stoch, stab_com, avg_cv_sp,
        sync)) %>% na.omit(),
    method = "spearman")
p_cor_basic <- ggcorrplot(cor_basic, type = "lower",
   lab = TRUE)
p_cor_enrich <- ggcorrplot(cor_enrich, type = "lower",
   lab = TRUE)
p_cor <- plot_grid(
  p_cor_basic,
  p_cor_enrich,
  ncol = 2,
  labels = "auto"
)
ggsave(here("report", "figures", "p_cor.pdf"),
  plot = p_cor,
  device = NULL,
  path = NULL,
  scale = 3.0,
  units = "mm",
  width = 140,
  height = 140 * .5,
  dpi = 300,
  limitsize = TRUE,
  bg = NULL
)
```

```{r}
cor_cap <- "Correlation among foodweb structure and stability for basic (a) and
enriched (b) environments."
```


```{r, fig.cap=cor_cap}
knitr::include_graphics(here::here("report", "figures", "p_cor.pdf"))
```

# Effect of species richness

```{r}
sim_rich_prod <- simZ %>%
  filter(
    env_stoch == .5
  )
```

```{r}
p_sim_rich_prod <- sim_rich_prod %>%
  mutate(stab_pop = 1/ avg_cv_sp) %>%
  pivot_longer(
    c(stab_com, stab_pop, sync),
    names_to = "metric",
    values_to = "stab") %>%
  mutate(
    metric = var_replacement()[metric],
    rho = rho_replacement()[as.character(rho)]
  ) %>%
  ggplot(aes(x = richness, y = stab, color = factor(productivity))) +
  geom_point(alpha = .1, shape = 20) +
  geom_smooth() +
  facet_grid(rows = vars(metric), cols = vars(rho), scales = "free_y") +
  labs(
    color = "Productivity",
    x = "Species richness",
    y = "Stability component"
  ) +
  scale_x_continuous(
    sec.axis = sec_axis(~ . ,
      name = "Response diversity",
      breaks = NULL,
      labels = NULL)
  )
ggsave(
  filename = here::here("report", "figures", "stability_rich.pdf"),
  p_sim_rich_prod,
  scale = 1.8,
  width = 88,
  height = 88 * .6,
  units = "mm"
)
```


```{r}
p_sim_rich_prod_fw_only <- sim_rich_prod %>%
  filter(ct_alive != 0, avg_max_int_alive != 0) %>%
  mutate(stab_pop = 1/ avg_cv_sp) %>%
  pivot_longer(
    c(stab_com, stab_pop, sync),
    names_to = "metric",
    values_to = "stab") %>%
  mutate(
    metric = var_replacement()[metric],
    rho = rho_replacement()[as.character(rho)]
  ) %>%
  ggplot(aes(x = log(richness), y = log(stab), color = factor(productivity))) +
  geom_point(alpha = .1, shape = 20) +
  geom_smooth(method = "lm") +
  facet_grid(rows = vars(metric), cols = vars(rho), scales = "free_y") +
  labs(
    color = "Productivity",
    x = "Species richness",
    y = "Stability component"
  ) +
  scale_x_continuous(
    sec.axis = sec_axis(~ . ,
      name = "Response diversity",
      breaks = NULL,
      labels = NULL)
  )
ggsave(
  filename = here("report", "figures", "p_sim_rich_prod_fw_only.pdf"),
  p_sim_rich_prod_fw_only,
  scale = 1.8,
  width = 88,
  height = 88 * .6,
  units = "mm"
)
```


```{r}
p_sim_rich_prod_p_only <- sim_rich_prod %>%
  filter(ct_alive == 0) %>%
  mutate(stab_pop = 1/ avg_cv_sp) %>%
  pivot_longer(
    c(stab_com, stab_pop, sync),
    names_to = "metric",
    values_to = "stab") %>%
  mutate(
    metric = var_replacement()[metric],
    rho = rho_replacement()[as.character(rho)]
  ) %>%
  ggplot(aes(x = richness, y = stab, color = factor(productivity))) +
  geom_point(alpha = .1, shape = 20) +
  geom_smooth() +
  facet_grid(rows = vars(metric), cols = vars(rho), scales = "free_y") +
  labs(
    color = "Productivity",
    x = "Species richness",
    y = "Stability component"
  ) +
  scale_x_continuous(
    sec.axis = sec_axis(~ .,
      name = "Response diversity",
      breaks = NULL,
      labels = NULL)
  )
ggsave(
  filename = here("report", "figures", "p_sim_rich_prod_p_only.pdf"),
  p_sim_rich_prod_p_only,
  scale = 1.8,
  width = 88,
  height = 88 * .6,
  units = "mm"
)
```

```{r, fig.cap = "Food-Web only."}
knitr::include_graphics(here("report", "figures", "p_sim_rich_prod_fw_only.pdf"))
```

```{r, fig.cap = "Primary producers only."}
knitr::include_graphics(here::here("report", "figures", "p_sim_rich_prod_p_only.pdf"))
```

- Enrichment decreases the effect of response diversity of stability
- Enrichment increases synchrony
- Richness decreases population stability, but increases it in absence of response
  diversity
- Food-web maintains some asynchrony despite the absence of response
  diversity but synchrony increase with richness in basic environment


```{r}
simZ %>%
  filter(rho == 1) %>%
  mutate(stab_pop = 1/ avg_cv_sp) %>%
  pivot_longer(
    c(stab_com, stab_pop, sync, total_biomass),
    names_to = "metric",
    values_to = "stab") %>%
  ggplot(aes(x = richness, y = stab, color = factor(env_stoch))) +
  geom_point() +
  facet_grid(rows = vars(metric), cols = vars(productivity), scales = "free_y") +
  labs(
    color = "Evironmental stochasticity",
    x = "Species richness",
    y = "Stability component"
  )
```

# Food-web structure and interaction strength drive stability

```{r}
compute_rotated_pca <- function(.data = NULL, naxis = 2) {
  .data <- na.omit(.data)
  pca <- ade4::dudi.pca(as.data.frame(.data),
    scannf = FALSE, nf = naxis, center = TRUE, scale = TRUE
  )
  pca_rotated <- psych::principal(.data,
    rotate = "varimax", nfactors = naxis,
    scores = TRUE
  )

  return(list(normal = pca, rotated = pca_rotated))
}
```


```{r}
sim_sem <- simZ %>%
  filter(ct_alive != 0, env_stoch == 0.5, rho == 0) %>%
  mutate(across(c(async, stab_pop, stab_com, richness, ct_alive, sd_max_int_alive, avg_max_int_alive), log, , .names = "log_{.col}")) %>%
  mutate(
    log1_avg_max_int_alive = log(avg_max_int_alive + 1),
    log1_sd_max_int_alive = log(sd_max_int_alive + 1),
    productivity_f = factor(productivity)
    ) %>%
  as.data.frame()
scaled_sim_sem <- sim_sem %>%
  mutate(across(where(is.double), ~scale(.x)[,1]))
```

```{r}
var_fw_struct <- c("richness", "ct_alive", "Z")
var_fw_emergent_struct <- c("max_tlvl_alive", "w_avg_tlvl_alive")
var_fw_flux <- c("gini_max_int_alive", "avg_max_int_alive", "sd_max_int_alive",
  "cv_max_int_alive")
var_stab <- c("async", "stab_com", "stab_pop")
```


```{r}
#colnames(simZ)
pairs(sim_sem %>%
  filter(env_stoch == .5) %>%
  select(c(var_fw_struct, var_fw_emergent_struct, var_fw_flux, stab_pop)))
```

```{r, eval = FALSE}
performance::check_collinearity(lm(w_avg_tlvl_alive ~ max_tlvl_alive,sim_sem))
performance::check_collinearity(lm(w_avg_tlvl_alive ~ ct_alive + richness,sim_sem))
performance::check_collinearity(lm(w_avg_tlvl_alive ~ ct_alive + richness,sim_sem))
performance::check_collinearity(lm(avg_max_int_alive ~ w_avg_tlvl_alive + ct_alive + richness,sim_sem))
performance::check_collinearity(lm(avg_max_int_alive ~ max_tlvl_alive + ct_alive,sim_sem))
performance::check_collinearity(lm(stab_com ~ log_richness + log1_avg_max_int_alive + log1_sd_max_int_alive + w_avg_tlvl_alive + ct_alive,sim_sem))
performance::check_collinearity(lm(stab_com ~ richness + avg_max_int_alive + sd_max_int_alive + w_avg_tlvl_alive + ct_alive,sim_sem))
```

```{r}
sem_list_basic <- list(
  w_avg_tlvl_alive = lm(w_avg_tlvl_alive ~ richness + ct_alive, sim_sem),
  sd_max_int_alive = lm(sd_max_int_alive ~ richness + ct_alive + w_avg_tlvl_alive, sim_sem),
  avg_max_int_alive = lm(avg_max_int_alive ~ richness + ct_alive + w_avg_tlvl_alive, sim_sem),
  log_async = lm(log_async ~ richness + avg_max_int_alive + sd_max_int_alive + w_avg_tlvl_alive + ct_alive, sim_sem),
  log_stab_pop = lm(log_stab_pop ~ richness + avg_max_int_alive + sd_max_int_alive + w_avg_tlvl_alive + ct_alive, sim_sem),
  log_stab_com = lm(log_stab_com ~ log_async + log_stab_pop, sim_sem)
)
sem_basic <- as.psem(sem_list_basic)
```

```{r}
ti <- summary(sem_basic)$coefficients[, c(1, 2, 8, 9)]
colnames(ti)[4] <- "Signif"
ti %>%
  mutate(
    Response = var_replacement()[Response],
    Predictor = var_replacement()[Predictor]
  ) %>%
  kable(caption = "Standardized estimates for the Structural Equation Models.") %>%
  collapse_rows(1, valign = "middle") %>%
  kable_styling()
```

```{r, eval = FALSE}
ti <- map_dfr(setNames(sem_list_basic, names(sem_list_basic)),
  performance::check_collinearity,
  .id = "response") %>%
  as_tibble
ti %>%
  mutate(
    response = var_replacement()[response],
    Term = var_replacement()[Term]
  ) %>%
  kable(caption = "Variance Inflation Factors for the Structural Equation Model.") %>%
  kable_styling()
```

```{r, eval = FALSE}
map_dfr(sem_list_basic, rsquared) %>%
  mutate(Response = var_replacement()[Response]) %>%
  select(Response, R.squared) %>%
  kable(caption = "Rsquared for the Structural Equation Model.") %>%
  kable_styling()
```



```{r}
sim_sem_nodivresp <- simZ %>%
  filter(ct_alive != 0, env_stoch == 0.5, rho == 1) %>%
  mutate(across(c(async, stab_pop, stab_com, richness, ct_alive, sd_max_int_alive, avg_max_int_alive), log, , .names = "log_{.col}")) %>%
  mutate(
    log1_avg_max_int_alive = log(avg_max_int_alive + 1),
    log1_sd_max_int_alive = log(sd_max_int_alive + 1),
    productivity_f = factor(productivity)
    ) %>%
  as.data.frame()
```

```{r}
sem_list_nodivresp <- list(
  w_avg_tlvl_alive = lm(w_avg_tlvl_alive ~ richness + ct_alive, sim_sem_nodivresp),
  sd_max_int_alive = lm(sd_max_int_alive ~ richness + ct_alive + w_avg_tlvl_alive, sim_sem_nodivresp),
  avg_max_int_alive = lm(avg_max_int_alive ~ richness + ct_alive + w_avg_tlvl_alive, sim_sem_nodivresp),
  log_async = lm(log_async ~ richness + avg_max_int_alive + sd_max_int_alive + w_avg_tlvl_alive + ct_alive, sim_sem_nodivresp),
  log_stab_pop = lm(log_stab_pop ~ richness + avg_max_int_alive + sd_max_int_alive + w_avg_tlvl_alive + ct_alive, sim_sem_nodivresp),
  log_stab_com = lm(log_stab_com ~ log_async + log_stab_pop, sim_sem_nodivresp)
)
sem_nodivresp <- as.psem(sem_list_nodivresp)
```

```{r}
coef_sem_nodivresp <- summary(sem_nodivresp)$coefficients[, c(1, 2, 8, 9)]
colnames(coef_sem_nodivresp)[4] <- "Signif"
coef_sem_nodivresp %>%
  mutate(
    Response = var_replacement()[Response],
    Predictor = var_replacement()[Predictor]
  ) %>%
  kable(caption = "Standardized estimates for the Structural Equation Models with no response diversity.") %>%
  collapse_rows(1, valign = "middle") %>%
  kable_styling()
```


# Effect of multiple stressors on stability in monotrophic and food-webs


```{r}
tar_load(p_mod_rho_scaled)
p_mod_rho_scaled_tot <- plot_grid(plotlist = p_mod_rho_scaled)
ggsave(here("report", "figures", "p_mod_rho_scaled_tot.pdf"),
  plot = p_mod_rho_scaled_tot,
  device = NULL,
  path = NULL,
  scale = 2.4,
  units = "mm",
  width = 140,
  height = 140 * .5,
  dpi = 300,
  limitsize = TRUE,
  bg = NULL
)
```


```{r, eval = FALSE}
tar_load(p_mod_rho)
plot_grid(plotlist = p_mod_rho)
```

```{r, eval = FALSE}
sim_rho
```


```{r}
tar_load(pred_rho)
p_pred_rho <- pred_rho %>%
  mutate(rho = rho_replacement()[as.character(rho)]) %>%
  ggplot(aes(
      y = log_stab_com,
      x = log_richness,
      color = factor(ct_alive),
      linewidth = factor(log1_avg_max_int_alive)
      )) +
  geom_line() +
  labs(
    color = "Connectance",
    linewidth = "Avg interaction strength",
    y = "Community stability",
    x = "Species richness (log)"
    ) +
  facet_grid(
    rows = vars(rho),
    cols = vars(productivity)
  )
ggsave(here("report", "figures", "p_pred_rho.pdf"),
  plot = p_pred_rho,
  device = NULL,
  path = NULL,
  scale = 2.4,
  units = "mm",
  width = 140,
  height = 140 * .5,
  dpi = 300,
  limitsize = TRUE,
  bg = NULL
)
```

```{r}
predS_cap <- "Predictions for the model of drivers of community stability in
basic and enriched environments (columns) and across varying response diversity
(rows)."
```

```{r predS, fig.cap = predS_cap}
knitr::include_graphics(here("report", "figures", "p_pred_rho.pdf"))
```


```{r}
coef_rho_cap <- "Coefficients for the model of drivers of community stability,
population stability and asynchrony. See predictions for a more simple overview."
```

```{r coef-rho, fig.cap = coef_rho_cap}
knitr::include_graphics(here("report", "figures", "p_mod_rho_scaled_tot.pdf"))
```

- From the predictions of the model:
  - Stong interaction among interaction strength, connectance and species
    richness, enrichment and response diversity = *Food-web structure effects on
    stability is context dependant*
  - High connectance and high interaction strength is generally destabilizing,
    driving negative relationships between stability and species richness in
    enrichment context (high $K$)
  - At the reverse, low connectance and high interaction strength is stabilizing
  - In basic environment, high interaction strength stabilise the community
    biomass in the absence of response diversity. At the opposite, low
    interaction strength generate a negative stability richness relationship.
  - In enrichment context, response diversity has little effect on stability!
  - In enrichment context, High interaction strength is generally stabilizing!


```{r, eval = FALSE}
mod_rho_tot <- glmmTMB(
  log_stab_com ~ log1_avg_max_int_alive*log_richness*ct_alive*rho*productivity +
    env_stoch + (1 | Z),
  sim_rho_scaled)
coef_mod_rho_tot <- model2tibble(mod_rho_tot)
coef_mod_rho_tot %>%
  ggplot(aes(y = parameter, x = coefficient, xmin = ci_low, xmax = ci_high)) +
  geom_pointrange() +
  labs(x = "Standardized Coefficients")
```

```{r, eval = FALSE}
sim_rho_pers <- simZ %>%
  mutate(across(c(S, ct, avg_max_int, gini_max_int), log, , .names = "log_{.col}")) %>%
  mutate(
    log1_avg_max_int = log(avg_max_int + 1),
    productivity_f = factor(productivity)
    ) %>%
  as.data.frame() %>%
  select(c(
      log_S, ct, max_tlvl, Z, rho,
      gini_max_int, avg_max_int, log1_avg_max_int, env_stoch,
      productivity, productivity_f,
      persistence)
  )
sim_rho_pers_scaled <- sim_rho_pers %>%
  mutate(across(where(is.double), ~scale(.x)[,1]))

pred_rho_pers <- "log1_avg_max_int * log_S * rho +
log1_avg_max_int * log_S * productivity +
log1_avg_max_int * log_S * ct +
log1_avg_max_int * ct * rho +
log1_avg_max_int * ct * rho +
log1_avg_max_int * ct * productivity +
log_S * rho * productivity +
log_S * ct * productivity +
log_S * ct * rho +
env_stoch"
rand <- "(1 | Z)"

mod_rho_pers <- glmmTMB(formula(paste0("persistence ~ ", pred_rho_pers, " + ", rand)),
  sim_rho_pers_scaled)

r2_nakagawa(mod_rho_pers)
plot(parameters(mod_rho_pers))
```

## Regression tree


```{r, eval = FALSE}
library(rpart)
library(rpart.plot)
set.seed(123)
m1 <- rpart(
  formula = log_stab_com ~ .,
  data    = sim_rho %>%
    select(log_stab_com, log_richness, ct_alive, rho, env_stoch,
      gini_max_int, max_tlvl_alive, log1_avg_max_int_alive, productivity),
  method  = "anova"
  )
rpart.plot(m1)
```

```{r, eval=FALSE}
bagged_m1 <- bagging(
  formula = log_stab_com ~ .,
  data    = sim_rho %>%
    select(log_stab_com, log_richness, ct_alive, rho, env_stoch,
      gini_max_int, max_tlvl_alive, log1_avg_max_int_alive, productivity),
  coob    = TRUE
)
```

```{r, eval = FALSE}
library(ipred)
ctrl <- trainControl(method = "cv",  number = 10)

# CV bagged model
bagged_cv <- train(
  Sale_Price ~ .,
  data = ames_train,
  method = "treebag",
  trControl = ctrl,
  importance = TRUE
  )
```

```{r, fig.cap = "Variable importance from bagged regression tree."}
ctrl <- trainControl(method = "cv",  number = 10)

# CV bagged model
bagged_cv <- train(
  stab_com ~ richness + ct_alive + max_tlvl_alive +
    w_avg_tlvl_alive + avg_max_int_alive + sd_max_int_alive + rho + productivity,
  data = simZ %>% filter(ct_alive != 0, avg_max_int_alive != 0),
  cp = .2,
  maxdepth = 6,
  method = "treebag",
  trControl = ctrl,
  importance = TRUE
  )
plot(varImp(bagged_cv), 8)
```

```{r, fig.cap="Regression tree "}
m1 <- rpart(
  formula = stab_com ~ richness + ct_alive + rho + productivity + w_avg_tlvl_alive + max_tlvl_alive +
    avg_max_int_alive + sd_max_int_alive,
  data    = simZ %>%
    filter(ct_alive != 0, avg_max_int_alive != 0),
  method  = "anova"
  )
rpart.plot(m1)
```
