---
title: "Target Markdown"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

Target Markdown is a powerful R Markdown interface for reproducible analysis
pipelines, and the chapter at https://books.ropensci.org/targets/markdown.html
walks through it in detail. This R Markdown report the example from the chapter.
Try it out in both interactive and non-interactive modes, either by running the
code chunks in different ways or setting the `tar_interactive` chunk option.

# Packages

The example requires several R packages, and `targets` must be version 0.5.0.9000 or above.

```{r, eval = FALSE}
install.packages(c("biglm", "dplyr", "ggplot2", "readr", "targets", "tidyr"))
```

# Setup

If you are using old versions of `targets` (<= 0.7.0) and/or `knitr` (<= 1.33), you will need to load the `targets` package in the R Markdown document in order for Target Markdown code chunks to work.

```{r}
library(targets)
```

Near the top of the document, you may also wish to remove the `_targets_r` directory previously written by non-interactive runs of the report. Otherwise, your pipeline may contain superfluous targets.

```{r}
library(targets)
tar_unscript()
```

# Globals

We first define some global options/functions common to all targets. The function below plots a histogram of ozone concentrations, and our histogram target will need it.

```{targets example-globals, tar_globals = TRUE}
options(tidyverse.quiet = TRUE)
tar_option_set(
  error = "null",
  packages = c("tidyverse", "magrittr", "cowplot", "here", "arrow", "piecewiseSEM", "semEff", "easystats", "glmmTMB", "ggcorrplot", "kableExtra", "DHARMa")
)
#Â Load custom functions
lapply(list.files(here::here("R"), full.names = TRUE), source)
map_tibble <- tibble::tibble(
  names = c("csc_rerun", "csc_kno", "csc_non_allo", "csc_rebuild")
    )
```


# Targets

Our first target borrows the `airquality` dataset built into base R.


## SEM

```{targets sem-process}
list(
  tar_target(sim_fw, sim_fw_csc_rerun),
  tar_target(sim_fw_sem,
    sim_fw %>%
      as.data.frame() %>%
      mutate(across(c(stab_com, pop_stab, async, cpe, sae_total, evenness_sae,
            sae_even, cpe_int, cpe_env), log))
    ),
  tar_target(sem_eff,  sem_main_text_eff_csc_rerun),
  tar_target(sem_eff_tab, sem_main_text_eff_tab_csc_rerun),
  tar_target(sem_eff_coeff, sem_main_text_eff_tab_csc_rerun),
  tar_target(sem_collinearity, sem_main_text_collinearity_csc_rerun),
  tar_target(sem_rsquared, sem_main_text_rsquared_csc_rerun),
  tar_target(tab_sem_vif,
    sem_collinearity %>%
      mutate(across(c("response", "Term"), ~var_replacement()[.x])) %>%
      mutate(VIF = round(VIF, 1)) %>%
      select(Response = response, Term, VIF)
    ),
  tar_target(tab_sem_rsquared,
    sem_rsquared %>%
      rename(`$R^2$` = R.squared) %>%
      kable(caption = "Rsquared for the Structural Equation Model.") %>%
      kable_styling()
  ),
  tar_target(tab_sem_simplified_eff,
    sem_simplified_eff_tab %>%
      filter(effect_type == "direct") %>%
      mutate(across(c("response", "predictor"), ~var_replacement()[.x])) %>%
      mutate(effect = round(effect, 2)) %>%
      select(
        Response = response,
        Predictor = predictor,
        `Std estimate` = effect
      )
  ),
  tar_target(tab_sem_doak_eff,
    sem_doak_eff_tab %>%
      filter(effect_type == "direct") %>%
      mutate(across(c("response", "predictor"), ~var_replacement()[.x])) %>%
      mutate(effect = round(effect, 2)) %>%
      select(
        Response = response,
        Predictor = predictor,
        `Std estimate` = effect
      )
  )
)
```

```{r, eval = FALSE}
library(targets)
tar_load_globals()
tar_load(starts_with("sim_fw_csc"))
sim_fw_csc_rerun
sim_fw_csc_rebuild
sim_fw_csc_kno
sim_fw_csc_non_allo
sim_fw_csc_non_allo
tar_read(sem_rsquared) %>%
  rename(`$R^2$` = R.squared) %>%
  kable(caption = "Rsquared for the Structural Equation Model.") %>%
  kable_styling()
```


```{targets all-analysis}
library(tarchetypes)
tar_map(
  values = map_tibble,
  names = names,
  tar_target(sim_files, here::here("data", paste0("sim_fw_", names)), format = "file"),
  tar_target(sim_fw, readRDS(sim_files)),
  tar_target(sem_simplified_file, here::here("data", paste0("sem_simplified_", names)), format = "file"),
  tar_target(sem_simplified, { readRDS(sem_simplified_file) }),
  tar_target(sem_simplified_eff_file, here::here("data", paste0("sem_simplified_eff_", names)), format = "file"),
  tar_target(sem_simplified_eff, { readRDS(sem_simplified_eff_file) }),
  tar_target(sem_simplified_collinearity_file, here::here("data", paste0("sem_simplified_collinearity_", names)), format = "file"),
  tar_target(sem_simplified_collinearity, { readRDS(sem_simplified_collinearity_file) }),
  tar_target(sem_simplified_rsquared_file, here::here("data", paste0("sem_simplified_rsquared_", names)), format = "file"),
  tar_target(sem_simplified_rsquared, { readRDS(sem_simplified_rsquared_file) }),
  tar_target(sem_simplified_eff_tab, from_semEff_to_table(sem_simplified_eff)),
  tar_target(sem_main_text_file, here::here("data", paste0("sem_main_text_", names)), format = "file"),
  tar_target(sem_main_text, { readRDS(sem_main_text_file) }),
  tar_target(sem_main_text_eff_file, here::here("data", paste0("sem_main_text_eff_", names)), format = "file"),
  tar_target(sem_main_text_eff, { readRDS(sem_main_text_eff_file) }),
  tar_target(sem_main_text_collinearity_file, here::here("data", paste0("sem_main_text_collinearity_", names)), format = "file"),
  tar_target(sem_main_text_collinearity, { readRDS(sem_main_text_collinearity_file) }),
  tar_target(sem_main_text_rsquared_file, here::here("data", paste0("sem_main_text_rsquared_", names)), format = "file"),
  tar_target(sem_main_text_rsquared, { readRDS(sem_main_text_rsquared_file) }),
  tar_target(sem_main_text_coeff_file, here::here("data", paste0("sem_main_text_coeff_", names)), format = "file"),
  tar_target(sem_main_text_eff_tab, from_semEff_to_table(sem_main_text_eff)),

  tar_target(sem_doak_file, here::here("data", paste0("sem_doak_", names)), format = "file"),
  tar_target(sem_doak, { readRDS(sem_doak_file) }),
  tar_target(sem_doak_eff_file, here::here("data", paste0("sem_doak_eff_", names)), format = "file"),
  tar_target(sem_doak_eff, { readRDS(sem_doak_eff_file) }),
  tar_target(sem_doak_eff_tab, from_semEff_to_table(sem_doak_eff)),
  tar_target(sem_doak_collinearity_file, here::here("data", paste0("sem_doak_collinearity_", names)), format = "file"),
  tar_target(sem_doak_collinearity, { readRDS(sem_doak_collinearity_file) }),
  tar_target(sem_doak_rsquared_file, here::here("data", paste0("sem_doak_rsquared_", names)), format = "file"),
  tar_target(sem_doak_rsquared, { readRDS(sem_doak_rsquared_file) })
)
```

```{targets group-all-analysis}
list(
  tar_target(sem_main_text_tot,
    tibble(
      sim_type = c(
        "rerun",
        "non_allo",
        "rebuild",
        "kno"),
      eff = list(
        sem_main_text_eff_tab_csc_rerun,
        sem_main_text_eff_tab_csc_non_allo,
        sem_main_text_eff_tab_csc_rebuild,
        sem_main_text_eff_tab_csc_kno
        ),
      collinearity = list(
        sem_main_text_collinearity_csc_rerun,
        sem_main_text_collinearity_csc_non_allo,
        sem_main_text_collinearity_csc_rebuild,
        sem_main_text_collinearity_csc_kno
        ),
    )
  ),
  tar_target(sem_doak_tot,
    tibble(
      sim_type = c(
        "rerun",
        "non_allo",
        "rebuild",
        "kno"),
      eff = list(
        sem_doak_eff_tab_csc_rerun,
        sem_doak_eff_tab_csc_non_allo,
        sem_doak_eff_tab_csc_rebuild,
        sem_doak_eff_tab_csc_kno
        ),
      collinearity = list(
        sem_doak_collinearity_csc_rerun,
        sem_doak_collinearity_csc_non_allo,
        sem_doak_collinearity_csc_rebuild,
        sem_doak_collinearity_csc_kno
        ),
    )
  ),
  tar_target(sem_main_text_eff_tab_tot,
    sem_main_text_tot %>%
      select(sim_type, eff) %>%
      unnest(cols = eff)),
  tar_target(p_sem_main_text_eff_tab_tot,
    sem_main_text_eff_tab_tot %>%
      filter(effect_type == "total") %>%
      filter(response %in% c("async", "pop_stab", "stab_com")) %>%
      filter(predictor %in% sem_tot_predictor()) %>%
      mutate(
        response = recode_factor(response, !!!var_replacement(), .ordered = TRUE),
        predictor = recode_factor(predictor, !!!var_replacement()[rev(sem_tot_predictor())], .ordered = TRUE),
        sim_type = recode_factor(sim_type, !!!sim_type_replacement(), .ordered = TRUE)
        ) %>%
      ggplot(aes(
          y = predictor,
          x = effect,
          color = response,
          shape = sim_type
        )
        ) +
      geom_point(alpha = .5) +
      scale_colour_manual(values = stab_color()) +
      scale_alpha_manual(values = stab_alpha()) +
      #  geom_hline(yintercept = 0, linetype = "dashed") +
      geom_vline(xintercept = 0, linetype = "dashed") +
      facet_grid(cols = vars(response)) +
      labs(
        x = "Total standardised effects",
        color = "Stability component",
        alpha = "Stability component"
        ) +
      theme_bw() +
      theme(
        axis.title.y = element_blank(),
        #legend.justification = "right",
        legend.position = "bottom") +
      guides(
        color = FALSE
        ) +
      theme(
        legend.title = element_blank(),
        legend.position = "bottom",
        legend.justification = c("left", "top")
      )
  ),
  tar_target(sem_doak_eff_tab_tot,
    sem_doak_tot %>%
      select(sim_type, eff) %>%
      unnest(cols = eff)),
  tar_target(p_sem_doak_eff_tab_tot,
    sem_doak_eff_tab_tot %>%
      filter(effect_type == "total") %>%
      filter(response %in% c("async", "pop_stab", "stab_com")) %>%
      filter(predictor %in% sem_tot_predictor()) %>%
      mutate(
        response = recode_factor(response, !!!var_replacement(), .ordered = TRUE),
        predictor = recode_factor(predictor, !!!var_replacement()[rev(sem_tot_predictor())], .ordered = TRUE),
        sim_type = recode_factor(sim_type, !!!sim_type_replacement(), .ordered = TRUE)
        ) %>%
      ggplot(aes(
          y = predictor,
          x = effect,
          color = response,
          shape = sim_type
        )
        ) +
      geom_point(alpha = .5) +
      scale_colour_manual(values = stab_color()) +
      scale_alpha_manual(values = stab_alpha()) +
      #  geom_hline(yintercept = 0, linetype = "dashed") +
      geom_vline(xintercept = 0, linetype = "dashed") +
      facet_grid(cols = vars(response)) +
      labs(
        x = "Total standardised effects",
        color = "Stability component",
        alpha = "Stability component"
        ) +
      theme_bw() +
      theme(
        axis.title.y = element_blank(),
        #legend.justification = "right",
        legend.position = "bottom") +
      guides(
        color = FALSE
        ) +
      theme(
        legend.title = element_blank(),
        legend.position = "bottom",
        legend.justification = c("left", "top")
      )
  )
)
```


```{targets simplified-sem}
list(
  tar_target(sem_simplified_eff_tab, sem_simplified_eff_tab_csc_rerun),
  tar_target(sem_main_text_eff_tab, sem_main_text_eff_tab_csc_rerun),
  tar_target(sem_doak_eff_tab, sem_doak_eff_tab_csc_rerun)
)
```

```{targets model-to-pred}
list(
  tar_target(stab_com_part_var, c("stab_com", "pop_stab", "async")),
  tar_target(model_fw_stab_comp,
    tibble(
      response = stab_com_part_var,
      model = list(glmmTMB(formula_stab_fw_model(
      resp = stab_com_part_var,
      rand_effect = TRUE,
      term_to_del = "richness : resp_div : Z +"),
      data = mutate(sim_fw,
      across(c(stab_com, pop_stab, async), log)
      ))
        )),
        pattern = stab_com_part_var
  ),
  tar_target(model_fw_stab_comp_scaled,
    tibble(
      response = stab_com_part_var,
      model = list(glmmTMB(formula_stab_fw_model(
        resp = stab_com_part_var,
        rand_effect = TRUE,
        term_to_del = "richness : resp_div : Z +"
        ),
      data = sim_fw %>%
        mutate(across(c(stab_com, pop_stab, async), log)) %>%
        mutate(across(c(sim_id, fw_id), as.factor)) %>%
        mutate(
          across(c(stab_com, pop_stab, async, richness,
              env_stoch, resp_div, Z, c,
              ct_alive, w_avg_tlvl, avg_int_strength),
            ~scale(.x)[, 1])
        )
        ))),
        pattern = stab_com_part_var
  ),
  tar_target(model_fw_stab_comp_scaled_coeff,
    model_fw_stab_comp_scaled %>%
      mutate(
        coeff = map(model, function(x) {
          confint(x, level = 0.95) %>%
          as.data.frame() %>%
          rownames_to_column("term") %>%
          as_tibble() %>%
          mutate(term = str_replace(term, "cond\\.", ""))
        })
      ) %>%
      select(-model)
  ),
  tar_target(fixed_effect_fw_stab_comp,
    model_fw_stab_comp %>%
      mutate(
      fix_effect = map(model, ~fixef(.x)$cond)
      ) %>%
      select(-model)
  ),
  tar_target(default_variable_values_pred,
    c(
      "resp_div" = mean(sim_fw$resp_div),
      "env_stoch" = mean(sim_fw$env_stoch),
      "ct_alive" = mean(sim_fw$ct_alive),
      "avg_int_strength" = mean(sim_fw$avg_int_strength),
      "c" = mean(sim_fw$c),
      "w_avg_tlvl" = mean(sim_fw$w_avg_tlvl),
      "Z" = mean(sim_fw$Z)
    )
  ),
  tar_target(pred_range_fw,
    map(rlang::set_names(c("avg_int_strength", "ct_alive", "w_avg_tlvl")),
      ~quantile(sim_fw[[.x]], probs = c(.05, .95))
    )
  ),
  tar_target(pred_stab_comp_resp_div,
    fixed_effect_fw_stab_comp %>%
      left_join(
        list(
          response = fixed_effect_fw_stab_comp$response,
          variable = c("avg_int_strength", "w_avg_tlvl", "ct_alive")
          ) %>%
        expand.grid() %>%
        left_join(
          tibble(
            variable = c("avg_int_strength", "w_avg_tlvl", "ct_alive"),
            values = list(
              seq(
                min(pred_range_fw$avg_int_strength),
                max(pred_range_fw$avg_int_strength),
                length.out = 50
                ),
              seq(
                min(pred_range_fw$w_avg_tlvl),
                max(pred_range_fw$w_avg_tlvl),
                length.out = 50
              ),
              seq(
                min(pred_range_fw$ct_alive),
                max(pred_range_fw$ct_alive),
                length.out = 50
              )
            )
          )
        )
        ) %>%
    mutate(slope = pmap(
        list(
          param_name = variable,
          param_values = values,
          coeff = fix_effect
          ),
        function(param_name, param_values, coeff) {
          param <- list(
            seq(0, 1, length.out = length(param_values)),
            param_values
          )
          names(param) <- c("resp_div", param_name)

          encaps_get_slope_change(
            param_list = param,
            coeff_data = coeff,
            slope_term = "richness",
            default_variable_values = default_variable_values_pred
          )
        }
        )
    ) %>%
    select(-fix_effect, -values) %>%
    select(-variable) %>%
    mutate(slope = map(slope,
      ~pivot_longer(.x,
        -c(resp_div, slope),
        names_to = "variable",
        values_to = "variable_values"
      )
    )
  ) %>%
  unnest(cols = slope)
  )
)
```

```{targets full-model-pred}
list(
  tar_target(model_fw_stab_comp_full,
    tibble(
      response = stab_com_part_var,
      model = list(glmmTMB(formula_stab_fw_model(
      resp = stab_com_part_var,
      rand_effect = TRUE,
      term_to_del = "richness : resp_div : Z +"),
      data = mutate(sim_fw,
      across(c(stab_com, pop_stab, async), log)
      ))
        )),
        pattern = stab_com_part_var
  ),
  tar_target(model_fw_stab_comp_full_scaled,
    tibble(
      response = stab_com_part_var,
      model = list(glmmTMB(formula_stab_fw_model(
        resp = stab_com_part_var,
        rand_effect = TRUE,
        term_to_del = "richness : resp_div : Z +"
        ),
      data = sim_fw %>%
        mutate(across(c(stab_com, pop_stab, async), log)) %>%
        mutate(across(c(sim_id, fw_id), as.factor)) %>%
        mutate(
          across(c(stab_com, pop_stab, async, richness,
              env_stoch, resp_div, Z, c,
              ct_alive, w_avg_tlvl, avg_int_strength),
            ~scale(.x)[, 1])
        )
        ))),
        pattern = stab_com_part_var
  ),
  tar_target(model_fw_stab_comp_full_scaled_coeff,
    model_fw_stab_comp_full_scaled %>%
      mutate(
        coeff = map(model, function(x) {
          confint(x, level = 0.95) %>%
          as.data.frame() %>%
          rownames_to_column("term") %>%
          as_tibble() %>%
          mutate(term = str_replace(term, "cond\\.", ""))
        })
      ) %>%
      select(-model)
  ),
  tar_target(fixed_effect_fw_stab_comp_full,
    model_fw_stab_comp_full %>%
      mutate(
      fix_effect = map(model, ~fixef(.x)$cond)
      ) %>%
      select(-model)
  ),
  tar_target(pred_stab_comp_full_resp_div,
    fixed_effect_fw_stab_comp_full %>%
      left_join(
        list(
          response = fixed_effect_fw_stab_comp_full$response,
          variable = c("avg_int_strength", "w_avg_tlvl", "ct_alive")
          ) %>%
        expand.grid() %>%
        left_join(
          tibble(
            variable = c("avg_int_strength", "w_avg_tlvl", "ct_alive"),
            values = list(
              seq(
                min(pred_range_fw$avg_int_strength),
                max(pred_range_fw$avg_int_strength),
                length.out = 50
                ),
              seq(
                min(pred_range_fw$w_avg_tlvl),
                max(pred_range_fw$w_avg_tlvl),
                length.out = 50
              ),
              seq(
                min(pred_range_fw$ct_alive),
                max(pred_range_fw$ct_alive),
                length.out = 50
              )
            )
          )
        )
        ) %>%
    mutate(slope = pmap(
        list(
          param_name = variable,
          param_values = values,
          coeff = fix_effect
          ),
        function(param_name, param_values, coeff) {
          param <- list(
            seq(0, 1, length.out = length(param_values)),
            param_values
          )
          names(param) <- c("resp_div", param_name)

          encaps_get_slope_change(
            param_list = param,
            coeff_data = coeff,
            slope_term = "richness",
            default_variable_values = default_variable_values_pred
          )
        }
        )
    ) %>%
    select(-fix_effect, -values) %>%
    select(-variable) %>%
    mutate(slope = map(slope,
      ~pivot_longer(.x,
        -c(resp_div, slope),
        names_to = "variable",
        values_to = "variable_values"
      )
    )
  ) %>%
  unnest(cols = slope)
  ),
  tar_target(p_pred_stab_comp_full_resp_div,
    pred_stab_comp_full_resp_div %>%
  filter(response == "stab_com") %>%
  mutate(
    variable = var_replacement()[variable]
    ) %>%
  ggplot(aes(x = resp_div, y = variable_values, fill = slope)) +
  geom_raster() +
  facet_wrap(~variable, scales = "free_y", strip.position = "left") +
  coord_cartesian(expand = FALSE) +
  scale_fill_gradient2(
    low = resp_div_cat_colors()["Low"],
    mid = "white",
    high = resp_div_cat_colors()["High"],
    midpoint = 0,
    space = "Lab",
    na.value = "grey50",
    guide = "colourbar",
    aesthetics = "fill") +
  labs(
    x = var_replacement()["resp_div"],
    y = "Food-web structure",
    fill = "Slope community stability - Richness"
    ) +
  theme(
    legend.position = "bottom",
    legend.key.width = unit(2.5, "cm"),
    plot.margin = margin(l = 10, r = 10, t = 5, unit = "pt"),
    strip.placement = "outside",
    strip.background = element_blank(),
    strip.text = element_text(size = 11),
    axis.title.y = element_blank()
  )
    )
)
```


# plot

```{r, eval = FALSE}
tar_load(sem_main_text_tot)
sem_simplified_tot %>%
  select(sim_type, collinearity) %>%
  unnest(cols = c(collinearity)) %>%
  group_by(sim_type) %>%
  summarise(
    med = median(VIF),
    max = max(VIF)
  )
tar_read(sem_main_text_eff_rerun)
tar_load(pred_stab_comp_resp_div)
library(targets)
tar_load(sem_doak_eff_tab_csc_rerun)
sem_doak_eff_tab_csc_rerun %>%
  filter(effect_type == "direct", abs(effect) > .05) %>%
  print(n = 40)

sem_doak_eff_tab_csc_rerun %>%
  filter(effect_type == "direct") %>%
  print(n = 40)
```


```{targets plot-sem-tot}
list(
  tar_target(p_sem_tot_stab,
    sem_doak_eff_tab_csc_rerun %>%
      filter(effect_type == "total") %>%
      filter(response %in% c("async", "pop_stab", "stab_com")) %>%
      filter(predictor %in% sem_tot_predictor()) %>%
      mutate(
        response = recode_factor(response, !!!var_replacement(), .ordered = TRUE),
        predictor = recode_factor(predictor, !!!var_replacement()[rev(sem_tot_predictor())], .ordered = TRUE)
        ) %>%
      ggplot(aes(
          y = predictor,
          x = effect,
          color = response,
          alpha = response,
          ymin = lower_ci,
          ymax = upper_ci)
        ) +
      geom_pointrange() +
      scale_colour_manual(values = stab_color()) +
      scale_alpha_manual(values = stab_alpha()) +
      #  geom_hline(yintercept = 0, linetype = "dashed") +
      geom_vline(xintercept = 0, linetype = "dashed") +
      #facet_grid(cols = vars(response)) +
      labs(
        x = "Total standardised effects",
        color = "Stability component",
        alpha = "Stability component"
        ) +
      theme_bw() +
      theme(
        axis.title.y = element_blank(),
        #legend.justification = "right",
        legend.position = "bottom") +
      guides(
        color = guide_legend(override.aes = list(linetype = 0, alpha = 1))
        ) +
      theme(
        legend.title = element_blank(),
        legend.position = c(.005, .995),
        legend.justification = c("left", "top")
      )
    ),
  tar_target(p_sem_tot_stab_leg,
    plot_grid(
      p_sem_tot_stab +
        theme(
          legend.position = "none",
        ),
      get_legend(p_sem_tot_stab),
      nrow = 2,
      rel_heights = c(1, .05)
      )
  ),
  tar_target(sem_file, here("report", "figures", "sem_stab_doak.pdf"), format = "file"),
  tar_target(p_sem,
    ggdraw() +
      draw_image(magick::image_read_pdf(sem_file, density = 600),
        x = 0, y = 0,
        width = 1, height = 1,
        hjust = 0, halign = 0, valign = 0
      )
  ),
  tar_target(p_sem_fig,
    plot_grid(
      p_sem,
      p_sem_tot_stab +
        guides(
            color = guide_legend(override.aes = list(linetype = 0, alpha = 1)),
            y = "none",
            y.sec = "axis"
          ) +
          theme(
            text = element_text(size = 20),
            legend.title = element_blank(),
            legend.position = c(.005, .995),
            legend.justification = c("left", "top"),
        ),
      nrow = 2, rel_heights = c(1, .8),
      labels = "auto", hjust = -.7, vjust = 1.7
  )
  ),
  tar_target(p_sem_fig_file,
    ggsave_multiple(
      paste0("p_sem_fig", c(".png", ".pdf")),
      plot = p_sem_fig,
      path = here::here("report", "figures"),
      scale = 3.4,
      dpi = 400,
      width = 80,
      height = 80 * 1,
      units = "mm")
  ),
  tar_target(p_sem_tot_stab_file,
    ggsave_multiple(
  paste0("p_sem_tot_stab", c(".png", ".pdf")),
  plot = p_sem_tot_stab +
      guides(
        color = guide_legend(override.aes = list(linetype = 0, alpha = 1))
      ) +
      theme(
        legend.title = element_blank(),
        legend.position = c(.005, .995),
        legend.justification = c("left", "top"),

    ),
  path = here::here("report", "figures"),
  scale = 2.4,
  dpi = 400,
  width = 80,
  height = 80 * .4,
  units = "mm"))
)
```

```{targets plot-repro}
list(
  tar_target(p_pred_sr_resp_div,
    pred_stab_comp_resp_div %>%
  filter(response == "stab_com") %>%
  mutate(
    variable = var_replacement()[variable]
    ) %>%
  ggplot(aes(x = resp_div, y = variable_values, fill = slope)) +
  geom_raster() +
  facet_wrap(~variable, scales = "free_y", strip.position = "left") +
  coord_cartesian(expand = FALSE) +
  scale_fill_gradient2(
    low = resp_div_cat_colors()["Low"],
    mid = "white",
    high = resp_div_cat_colors()["High"],
    midpoint = 0,
    space = "Lab",
    na.value = "grey50",
    guide = "colourbar",
    aesthetics = "fill") +
  labs(
    x = var_replacement()["resp_div"],
    y = "Food-web structure",
    fill = "Slope community stability - Richness"
    ) +
  theme(
    legend.position = "bottom",
    legend.key.width = unit(2.5, "cm"),
    plot.margin = margin(l = 10, r = 10, t = 5, unit = "pt"),
    strip.placement = "outside",
    strip.background = element_blank(),
    strip.text = element_text(size = 11),
    axis.title.y = element_blank()
  )
    ),
  tar_target(p_pred_sr_resp_div_file,
    ggsave_multiple(
      paste0("p_pred_sr_resp_div", c(".png", ".pdf")),
      plot = p_pred_sr_resp_div,
      path = here::here("report", "figures"),
      scale = 2.2,
      dpi = 400,
      width = 120,
      height = 120 * .45,
      units = "mm")),
  tar_target(p_pred_sr_resp_div_supp,
    pred_stab_comp_resp_div %>%
      mutate(
        variable = var_replacement()[variable],
        response = recode_factor(response, !!!var_replacement(), .ordered = TRUE),
        ) %>%
    ggplot(aes(x = resp_div, y = variable_values, fill = slope)) +
    geom_raster() +
    facet_grid(cols = vars(response), rows = vars(variable), scales = "free") +
    coord_cartesian(expand = FALSE) +
    scale_x_continuous(
      breaks = c(0, .5, 1),
      labels = c(0, 0.5, 1)
      ) +
    scale_fill_gradient2(
      low = resp_div_cat_colors()["Low"],
      mid = "white",
      high = resp_div_cat_colors()["High"],
      midpoint = 0,
      space = "Lab",
      na.value = "grey50",
      guide = "colourbar",
      aesthetics = "fill") +
    labs(
      x = var_replacement()["resp_div"],
      y = "Food-web structure",
      fill = "Slope stability - Richness"
      ) +
    theme(
      legend.position = "bottom",
      legend.key.width = unit(2.0, "cm"),
      plot.margin = margin(l = 10, r = 10, unit = "pt")
      )),
  tar_target(p_pred_sr_resp_div_supp_file,
    ggsave_multiple(
      paste0("p_pred_sr_resp_div_supp", c(".png", ".pdf")),
      plot = p_pred_sr_resp_div_supp,
      path = here::here("report", "figures"),
      scale = 2.4,
      dpi = 400,
      width = 80,
      height = 80 * 1,
      units = "mm")
  )
)
```

```{targets fig-stab-sr}
list(
  tar_target(richness_gradient_pred_show, seq(1, 30, length.out = 20)),
  tar_target(pred_data_show, {
    low_resp_example <- rbind(default_variable_values_pred) %>%
      as_tibble() %>%
      mutate(resp_div = .1, w_avg_tlvl = 2.0, fw_id = "new") %>%
      slice(rep(1, length(richness_gradient_pred_show))) %>%
      mutate(richness = richness_gradient_pred_show)
    high_resp_example <- rbind(default_variable_values_pred) %>%
      as_tibble() %>%
      mutate(resp_div = .9, w_avg_tlvl = 1.2, fw_id = "new") %>%
      slice(rep(1, length(richness_gradient_pred_show))) %>%
      mutate(richness = richness_gradient_pred_show)
    out <- rbind(low_resp_example, high_resp_example)
    out$stab_com <- predict(
      model_fw_stab_comp[model_fw_stab_comp$response == "stab_com", ]$model[[1]],
      out,
      allow.new.levels = TRUE
    )
    out
  }
    ),
  tar_target(p_pred_data_show_low_resp,
    pred_data_show %>%
      filter(resp_div == .1) %>%
      ggplot(aes(x = richness, y = exp(stab_com))) +
      geom_line(color = resp_div_cat_colors()["Low"]) +
      ylim(10, 25) +
      labs(x = "Species richness", y = "Community stability") +
      theme_half_open()
    ),
  tar_target(p_pred_data_show_low_resp_file,
    ggsave_multiple(
      paste0("p_pred_data_show_low_resp", c(".png", ".pdf")),
      plot = p_pred_data_show_low_resp,
      path = here::here("report", "figures"),
      scale = 1.4,
      dpi = 400,
      width = 80,
      height = 80 * .9,
      units = "mm")
    ),
  tar_target(p_pred_data_show_high_resp,
    pred_data_show %>%
      filter(resp_div == .9) %>%
      ggplot(aes(x = richness, y = exp(stab_com))) +
      geom_line(color = resp_div_cat_colors()["High"]) +
      ylim(10, 25) +
      labs(x = "Species richness", y = "Community stability") +
      theme_half_open()
    ),
  tar_target(p_pred_data_show_high_resp_file,
    ggsave_multiple(
      paste0("p_pred_data_show_high_resp", c(".png", ".pdf")),
      plot = p_pred_data_show_high_resp,
      path = here::here("report", "figures"),
      scale = 1.4,
      dpi = 400,
      width = 80,
      height = 80 * .9,
      units = "mm")
    ),
  tar_target(data_label_pred_show,
    pred_data_show %>%
      select(resp_div, richness, w_avg_tlvl) %>%
      filter(richness == min(richness)) %>%
      pivot_longer(c(w_avg_tlvl), names_to = "variable",
        values_to = "variable_values") %>%
      mutate(variable = var_replacement()[variable],
        label = c("b", "c")
      )
    ),
  tar_target(p_fig3,
    plot_grid(
      p_pred_sr_resp_div +
        theme(
          legend.position = "bottom",
          legend.title = element_text(vjust = .75),
          legend.key.width = unit(2.0, "cm")
          ) +
        geom_label(
          data = data_label_pred_show,
          aes(color = NULL, fill = NULL, label = label),
          fontface = "bold"
          ),
        plot_grid(NULL,p_pred_data_show_low_resp,
          p_pred_data_show_high_resp, NULL,
          labels = c("", "b", "c", ""), nrow = 1,
          rel_widths = c(.25, 1, 1, .25)
          ),
        labels = c("a"),
        rel_heights = c(1, .75),
        nrow = 2
    )
    ),
  tar_target(p_fig3_file,
    ggsave_multiple(
      paste0("p_fig3", c(".png", ".pdf")),
      plot = p_fig3,
      path = here::here("report", "figures"),
      scale = 2.6,
      dpi = 400,
      width = 80,
      height = 80 * .8,
      units = "mm")
  )
)
```
```{targets pred_show_full}
list(
  tar_target(pred_data_show_full, {
    low_resp_example_full <- rbind(default_variable_values_pred) %>%
      as_tibble() %>%
      mutate(resp_div = .1, w_avg_tlvl = 2.0, fw_id = "new") %>%
      slice(rep(1, length(richness_gradient_pred_show))) %>%
      mutate(richness = richness_gradient_pred_show)
    high_resp_example_full <- rbind(default_variable_values_pred) %>%
      as_tibble() %>%
      mutate(resp_div = .9, w_avg_tlvl = 1.2, fw_id = "new") %>%
      slice(rep(1, length(richness_gradient_pred_show))) %>%
      mutate(richness = richness_gradient_pred_show)
    out <- rbind(low_resp_example_full, high_resp_example_full)
    out$stab_com <- predict(
      model_fw_stab_comp[model_fw_stab_comp_full$response == "stab_com", ]$model[[1]],
      out,
      allow.new.levels = TRUE
    )
    out
  }
    ),
  tar_target(p_pred_data_show_low_resp_full,
    pred_data_show_full %>%
      filter(resp_div == .1) %>%
      ggplot(aes(x = richness, y = exp(stab_com))) +
      geom_line(color = resp_div_cat_colors()["Low"]) +
      ylim(10, 25) +
      labs(x = "Species richness", y = "Community stability") +
      theme_half_open()
    ),
  tar_target(p_pred_data_show_low_resp_file_full,
    ggsave_multiple(
      paste0("p_pred_data_show_low_resp_full", c(".png", ".pdf")),
      plot = p_pred_data_show_low_resp_full,
      path = here::here("report", "figures"),
      scale = 1.4,
      dpi = 400,
      width = 80,
      height = 80 * .9,
      units = "mm")
    ),
  tar_target(p_pred_data_show_high_resp_full,
    pred_data_show_full %>%
      filter(resp_div == .9) %>%
      ggplot(aes(x = richness, y = exp(stab_com))) +
      geom_line(color = resp_div_cat_colors()["High"]) +
      ylim(10, 25) +
      labs(x = "Species richness", y = "Community stability") +
      theme_half_open()
    ),
  tar_target(p_pred_data_show_high_resp_file_full,
    ggsave_multiple(
      paste0("p_pred_data_show_high_resp_full", c(".png", ".pdf")),
      plot = p_pred_data_show_high_resp_full,
      path = here::here("report", "figures"),
      scale = 1.4,
      dpi = 400,
      width = 80,
      height = 80 * .9,
      units = "mm")
    ),
  tar_target(data_label_pred_show_full,
    pred_data_show_full %>%
      select(resp_div, richness, w_avg_tlvl) %>%
      filter(richness == min(richness)) %>%
      pivot_longer(c(w_avg_tlvl), names_to = "variable",
        values_to = "variable_values") %>%
      mutate(variable = var_replacement()[variable],
        label = c("b", "c")
      )
      )
)
```


```{targets r}
list(
  tar_target(p_pop_stab_w_avg_tlvl,
    sim_fw %>%
      filter(env_stoch == .3) %>%
      ggplot(aes(x = w_avg_tlvl, y = log(pop_stab))) +
      geom_point(alpha = .2) +
      geom_smooth(method = "lm") +
      labs(
        x = var_replacement()["w_avg_tlvl"],
        y = var_replacement()["pop_stab"]
        ) +
      theme_bw()
    ),
  tar_target(p_pop_stab_c,
    sim_fw %>%
      filter(env_stoch == .3) %>%
      ggplot(aes(x = as.factor(c), y = log(pop_stab))) +
      geom_boxplot(alpha = .2) +
      labs(
        x = var_replacement()["h"],
        y = var_replacement()["pop_stab"]
        ) +
      theme_bw()
    ),
  tar_target(p_pop_stab_env_stoch,
    sim_fw %>%
      ggplot(aes(x = as.factor(env_stoch), y = log(pop_stab))) +
      geom_boxplot(alpha = .2) +
      labs(
        x = var_replacement()["env_stoch"],
        y = var_replacement()["pop_stab"]
        ) +
      theme_bw()
    ),
  tar_target(p_even_sae_richness,
    sim_fw %>%
      filter(resp_div == 0) %>%
      ggplot(aes(x = as.factor(richness), y = log(evenness_sae))) +
      geom_boxplot(alpha = .2) +
      geom_smooth(method = "lm") +
      labs(
        x = var_replacement()["richness"],
        y = var_replacement()["evenness_sae"]
        ) +
      theme_bw()
    ),
  tar_target(p_sae_total_richness,
    sim_fw %>%
      filter(resp_div == 0) %>%
      ggplot(aes(x = as.factor(richness), y = log(sae_total))) +
      geom_boxplot(alpha = .2) +
      geom_smooth(method = "lm") +
      scale_x_discrete(breaks = seq(0, 35, 5)) +
      labs(
        x = var_replacement()["richness"],
        y = var_replacement()["sae_total"]
        ) +
      theme_bw()
    ),
  tar_target(p_even_sae_w_avg_tlvl,
    sim_fw %>%
      filter(resp_div == 0) %>%
      ggplot(aes(x = w_avg_tlvl, y = log(evenness_sae))) +
      geom_point(alpha = .2) +
      geom_smooth(method = "lm") +
      labs(
        x = var_replacement()["w_avg_tlvl"],
        y = var_replacement()["evenness_sae"]
        ) +
      theme_bw()
    ),
  tar_target(p_sae_total_w_avg_tlvl,
    sim_fw %>%
      filter(resp_div == 0) %>%
      ggplot(aes(x = w_avg_tlvl, y = log(sae_total))) +
      geom_point(alpha = .2) +
      geom_smooth(method = "lm") +
      labs(
        x = var_replacement()["w_avg_tlvl"],
        y = var_replacement()["sae_total"]
        ) +
      theme_bw()
    ),
  tar_target(p_even_sae_avg_int,
    sim_fw %>%
      filter(resp_div == 0) %>%
      ggplot(aes(x = avg_int_strength, y = log(evenness_sae))) +
      geom_point(alpha = .2) +
      geom_smooth(method = "lm") +
      labs(
        x = var_replacement()["avg_int_strength"],
        y = var_replacement()["evenness_sae"]
        ) +
      theme_bw()
    ),
  tar_target(p_sae_total_avg_int,
    sim_fw %>%
      filter(resp_div == 0) %>%
      ggplot(aes(x = avg_int_strength, y = log(sae_total))) +
      geom_point(alpha = .2) +
      geom_smooth(method = "lm") +
      labs(
        x = var_replacement()["avg_int_strength"],
        y = var_replacement()["sae_total"]
        ) +
      theme_bw()
    ),
  tar_target(p_sae_total_ct_alive,
    sim_fw %>%
      filter(resp_div == 0) %>%
      ggplot(aes(x = ct_alive, y = log(sae_total))) +
      geom_point(alpha = .2) +
      geom_smooth(method = "lm") +
      labs(
        x = var_replacement()["ct_alive"],
        y = var_replacement()["sae_total"]
        ) +
      theme_bw()
    ),
  tar_target(p_cpe_int_avg_int,
    sim_fw %>%
      ggplot(aes(x = avg_int_strength, y = log(cpe_int))) +
      geom_point(alpha = .2) +
      geom_smooth(method = "lm") +
      labs(
        x = var_replacement()["avg_int_strength"],
        y = var_replacement()["cpe_int"]
        ) +
      theme_bw()
    ),
  tar_target(p_cpe_avg_int,
    sim_fw %>%
      ggplot(aes(x = avg_int_strength, y = log(cpe))) +
      geom_point(alpha = .2) +
      geom_smooth(method = "lm") +
      labs(
        x = var_replacement()["avg_int_strength"],
        y = var_replacement()["cpe"]
        ) +
      theme_bw()
    ),
  tar_target(p_cpe_resp_div,
    sim_fw %>%
      ggplot(aes(x = resp_div, y = log(cpe), group = resp_div)) +
      geom_boxplot() +
      labs(
        x = var_replacement()["resp_div"],
        y = var_replacement()["cpe"]
        ) +
      theme_bw()
    ),
  tar_target(p_raw_bivariate_relations,
    plot_grid(
      p_pop_stab_w_avg_tlvl, p_pop_stab_c, p_pop_stab_env_stoch,
      p_sae_total_richness, p_sae_total_ct_alive, p_sae_total_w_avg_tlvl,
      p_sae_total_avg_int, p_cpe_avg_int, p_cpe_resp_div
    )
    )
)
```

## Partial residuals SEM

```{targets partial_sem_relations, eval = FALSE}
list(
  tar_target(scaled_sim_fw_sem,
    sim_fw_sem %>%
      mutate(across(where(is.numeric), ~scale(.x)[, 1]))
    ),
  tar_target(scaled_sem_simplified_model_list,
    map(sem_simplified_model_list,
      ~update(.x, data = scaled_sim_fw_sem)
      )),
  tar_target(scaled_sem_simplified,
    as.psem(scaled_sem_simplified_model_list)
    ),
  tar_target(formula_sem_bivariate_relations,
    c(
      "pop_stab ~ w_avg_tlvl",
      "pop_stab ~ c",
      "pop_stab ~ env_stoch",
      "sae_total ~ richness",
      "sae_total ~ ct_alive",
      "sae_total ~ w_avg_tlvl",
      "sae_total ~ avg_int_strength",
      "cpe ~ avg_int_strength",
      "cpe ~ resp_div"
    )
    )#,
  #tar_target(partial_resid_sem_simplified, {
  #  partialResid(as.formula(formula_sem_bivariate_relations),
  #          modelList = scaled_sem_simplified,
  #          data = scaled_sim_fw_sem
  #        )},
  #        pattern = map(formula_sem_bivariate_relations)
  #),
  #tar_target(sem_simplified_bivariate_relations,
  #  tibble(sem_formula = formula_sem_bivariate_relations) %>%
  #    separate(
  #      col = sem_formula,
  #      into = c("response", "predictor"),
  #      sep = " ~ ", remove = FALSE) %>%
  #  mutate(
  #    data = partial_resid_sem_simplified,
  #    coefs = map2(response, predictor,
  #      ~coefficients(scaled_sem_simplified[[.x]])[c("(Intercept)", .y)]
  #      ),
    #  plot = pmap(list(
    #      data = data,
    #      response = response,
    #      predictor = predictor,
    #      coef = coefs
    #      ),
    #    function (data, response, predictor, coef, ext_data) {
    #      if (predictor %in% c("h", "env_stoch", "resp_div")) {
    #        p <- data %>%
    #          ggplot(aes(
    #              y = yresid, x = xresid,
    #              group = cut(round(xresid, 1),
    #                breaks = length(unique(ext_data[[predictor]]))
    #              )
    #              )) +
    #          geom_boxplot(alpha = .1)
    #      } else {
    #        p <- data %>%
    #          ggplot(aes(y = yresid, x = xresid)) +
    #          geom_point(alpha = .1)
    #      }
    #      p +
    #        geom_abline(
    #          intercept = coef["(Intercept)"],
    #          slope = coef[2],
    #          linewidth = 1
    #          ) +
    #        labs(
    #          x = var_replacement()[predictor],
    #          y = var_replacement()[response]
    #          ) +
    #        coord_cartesian(expand = FALSE) +
    #        theme_half_open()

    #    }, ext_data = scaled_sim_fw_sem)
    #)
  #)
)
```





```{targets p-stab}
list(
  tar_target(p_cpe_env_rho, sim_fw %>%
    ggplot(aes(x = as.factor(1 - rho), y = cpe_env)) +
    geom_hline(yintercept = 1, linetype = "dashed") +
    geom_hline(yintercept = .5, linetype = "dashed", color = "red") +
    geom_boxplot() +
    labs(x = "Response diversity", y = "Env. Compensatory effect") +
    theme_bw()),
  tar_target(p_stoch_pop_stab,
    sim_fw %>%
      ggplot(aes(x = as.factor(env_stoch), y = pop_stab)) +
      geom_boxplot() +
      labs(x = "Environmental stochasticity", y = "Population stability") +
      theme_bw()),
    tar_target(p_stab_comp_stress,
      plot_grid(
        p_cpe_env_rho,
        p_stoch_pop_stab,
        labels = "auto"
      )
    )
)
```

## Stability-diversity relationship

```{targets p-stab-rich}
list(
    tar_target(p_stab_s_env_stoch,
      sim_fw %>%
        filter(env_stoch %in% c(.5, 1.5), rho == 0) %>%
        ggplot(aes(x = richness, y = stab_com, color = as.factor(env_stoch))) +
        geom_point() +
        geom_smooth() +
        labs(x = "Species richness", y = "Community stability", color = "Env. variability") +
        theme_bw()),
      tar_target(p_stab_s_resp_div,
        sim_fw %>%
          filter(rho %in% c(0, 1), env_stoch == .5) %>%
          ggplot(aes(x = richness, y = stab_com, color = as.factor(1 - rho))) +
          geom_point() +
          geom_smooth() +
          labs(x = "Species richness", y = "Community stability", color = "Response diversity") +
          theme_bw()
      ),
      tar_target(p_stab_s_stress,
         plot_grid(
           p_stab_s_env_stoch,
           p_stab_s_resp_div,
           labels = "auto"
         )
      )
)
```

```{targets p_stab_rich_env_rho, tar_simple = TRUE}
sim_fw %>%
  filter(env_stoch %in% c(.1, .6), rho %in% c(0, .75), c == 1, Z == 100) %>%
  ggplot(aes(x = log(richness), y = log(stab_com), color = as.factor(rho))) +
  geom_point(alpha = .3) +
  geom_smooth(method = "lm") +
  facet_grid(cols = vars(env_stoch), labeller = label_both) +
  labs(
    x = "Species richness (Log)", y = "Community stability (Log)",
    color = "Environmental correlation"
  ) +
  theme_bw() +
  theme(legend.position = "bottom")
```


## Interaction strength effect


```{targets p_int_stab, tar_simple = TRUE}
sim_fw %>%
  filter(rho %in% c(0), env_stoch == .5) %>%
  pivot_longer(c(stab_com, async, sae_total, cpe,
      sae_even, evenness_sae,
      cpe_int, cpe_env, pop_stab
      ), names_to = "async_decomp", values_to = "values") %>%
  mutate(async_decomp = var_replacement()[async_decomp]) %>%
  ggplot(aes(x = avg_int_strength, y = values)) +
  geom_point() +
  geom_smooth() +
  labs(x = "Avg feeding rate", y = "Asynchrony component") +
  facet_wrap(~async_decomp, ncol = 3, scales = "free_y") +
  theme_bw()
```

```{targets p_int_fw, tar_simple = TRUE}
sim_fw %>%
  filter(rho %in% c(0), env_stoch == .5) %>%
  pivot_longer(c(richness, ct_alive, max_tlvl, avg_omnivory, w_avg_tlvl
      ), names_to = "fw_str", values_to = "values") %>%
  mutate(fw_str = var_replacement()[fw_str]) %>%
  ggplot(aes(x = avg_int_strength, y = values)) +
  geom_point() +
  geom_smooth() +
  labs(x = "Avg feeding rate", y = "Food-web structure") +
  facet_wrap(~fw_str, ncol = 3, scales = "free_y") +
  theme_bw()
```

## Avg Omnivory

```{targets p-omn}
list(
  tar_target(p_omn_stab,
    sim_fw %>%
      filter(rho %in% c(0), env_stoch == .5) %>%
      pivot_longer(c(stab_com, pop_stab, async
          ), names_to = "stab_comp", values_to = "values") %>%
      mutate(stab_comp = var_replacement()[stab_comp]) %>%
      ggplot(aes(x = avg_omnivory, y = values)) +
      geom_point() +
      geom_smooth() +
      labs(x = "Avg omnivory", y = "Stability component") +
      facet_wrap(~stab_comp, ncol = 3, scales = "free_y") +
      theme_bw()),
  tar_target(p_omn_fw,
    sim_fw %>%
      filter(rho %in% c(0), env_stoch == .5) %>%
      pivot_longer(c(richness, ct_alive, w_avg_tlvl, max_tlvl
          ), names_to = "fw_str", values_to = "values") %>%
      mutate(fw_str = var_replacement()[fw_str]) %>%
      ggplot(aes(x = avg_omnivory, y = values)) +
      geom_point() +
      geom_smooth() +
      labs(x = "Avg. Omnivory", y = "Food-web structure") +
      facet_wrap(~fw_str, ncol = 3, scales = "free_y") +
      theme_bw()
  )
)
```

```{targets p-ct-rich-stab}
list(
  tar_target(p_ct_stab,
    sim_fw %>%
      filter(rho %in% c(0), env_stoch == .1) %>%
      pivot_longer(c(stab_com, async, sae_total, cpe,
          sae_even, evenness_sae,
          cpe_int, cpe_env, pop_stab
          ), names_to = "async_decomp", values_to = "values") %>%
      mutate(async_decomp = var_replacement()[async_decomp]) %>%
      ggplot(aes(x = ct_alive, y = values)) +
      geom_point() +
      geom_smooth() +
      labs(x = "Connectance", y = "Asynchrony component") +
      facet_wrap(~async_decomp, ncol = 3, scales = "free_y") +
      theme_bw()
    ),
  tar_target(p_rich_stab,
    sim_fw %>%
      filter(rho %in% c(0), env_stoch == .1) %>%
      pivot_longer(c(stab_com, async, sae_total, cpe,
          sae_even, evenness_sae,
          cpe_int, cpe_env, pop_stab
          ), names_to = "async_decomp", values_to = "values") %>%
      mutate(async_decomp = var_replacement()[async_decomp]) %>%
      ggplot(aes(x = richness, y = values)) +
      geom_point() +
      geom_smooth() +
      labs(x = "Species richness", y = "Asynchrony component") +
      facet_wrap(~async_decomp, ncol = 3, scales = "free_y") +
      theme_bw()
    )
)
```

```{targets p_int_fw_str, tar_simple = TRUE}
p1 <- sim_fw %>%
  ggplot(aes(x = as.factor(richness), y = avg_int_strength)) +
  geom_point() +
  labs(x = "Species richness", y = "Avg. Interaction strength") +
  theme_bw()
p2 <- sim_fw %>%
  ggplot(aes(x = as.factor(Z), y = avg_int_strength)) +
  geom_boxplot() +
  labs(x = "PPBR", y = "Avg. Interaction strength") +
  theme_bw()
p3 <- sim_fw %>%
  filter(Z == 100) %>%
  ggplot(aes(x = as.factor(c), y = avg_int_strength)) +
  geom_boxplot() +
  labs(x = "Hill exponent", y = "Avg. Interaction strength") +
  theme_bw()
plot_grid(p1, p2, p3, ncol = 2)
```


```{targets p_cor, tar_simple = TRUE}
cor_var <- cor(
  sim_fw %>%
    select(c(
        bm_total, stab_com, pop_stab, async, sae_total, sae_doak, cpe, cpe_int, cpe_env,
        richness, ct_alive, avg_int_strength, avg_omnivory, max_tlvl,
        w_avg_tlvl, Z, resp_div, env_stoch, c
        )) %>%
  na.omit() %>%
  rename(any_of(get_rev_vec_name_val(var_replacement()))),
    method = "spearman")
ggcorrplot(cor_var, type = "lower", lab = TRUE)
```
```{targets p_cor_file, tar_simple = TRUE}
ggsave_multiple(
  paste0("p_cor", c(".png", ".pdf")),
  plot = p_cor,
  path = here::here("report", "figures"),
  scale = 3.4,
  dpi = 400,
  width = 80,
  height = 80 * .9,
  units = "mm")
```

```{targets p_model_fw_stab_comp_scaled_coeff, tar_simple=TRUE}
pattern <- c(var_replacement(), get_term_replacement())
names(pattern) <- paste0("\\b", names(pattern), "\\b")
model_fw_stab_comp_scaled_coeff %>%
  unnest(cols = c(coeff)) %>%
  rename(lower_ci = `2.5 %`, upper_ci = `97.5 %`) %>%
  rename_with(tolower) %>%
  filter(!str_detect(term, "(Intercept)")) %>%
  mutate(
    type = ifelse(str_detect(term, ":"), "interaction", "single"),
    term = str_replace_all(term, pattern),
    response = recode_factor(response, !!!var_replacement(), .ordered = TRUE)
    ) %>%
  ggplot(aes(
      y = term, x = estimate,
      xmin = lower_ci, xmax = upper_ci,
      color = response)) +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_pointrange() +
  scale_colour_manual(values = stab_color()) +
  labs(x = "Standardised coefficients") +
  theme_bw() +
  theme(
    axis.title.y = element_blank(),
    legend.title = element_blank(),
    legend.position = "bottom"
  )
```

```{targets p_model_fw_stab_comp_scaled_coeff_file, tar_simple = TRUE}
ggsave_multiple(
  paste0("p_model_fw_stab_comp_scaled_coeff", c(".png", ".pdf")),
  plot = p_model_fw_stab_comp_scaled_coeff,
  path = here::here("report", "figures"),
  scale = 2.2,
  dpi = 400,
  width = 80,
  height = 80 * 1.4,
  units = "mm")
```

```{targets p_sem_main_text_eff_tab_tot_file, tar_simple = TRUE}
ggsave_multiple(
  paste0("p_sem_main_text_eff_tab_tot", c(".png", ".pdf")),
  plot = p_sem_main_text_eff_tab_tot,
  path = here::here("report", "figures"),
  scale = 2.4,
  dpi = 400,
  width = 80,
  height = 80 * .5,
  units = "mm"
  )
```

```{targets p_sem_doak_eff_tab_tot_file, tar_simple = TRUE}
ggsave_multiple(
  paste0("p_sem_doak_eff_tab_tot", c(".png", ".pdf")),
  plot = p_sem_doak_eff_tab_tot,
  path = here::here("report", "figures"),
  scale = 2.4,
  dpi = 400,
  width = 80,
  height = 80 * .5,
  units = "mm"
  )
```




# Table

```{targets sem_fig_coeff, tar_simple=TRUE}
sem_doak_eff_tab %>%
  filter(effect_type == "direct",
    predictor %in% c(
      sem_tot_predictor(), "async", "stab_com", "pop_stab", "sae_doak",
      "cpe_int")) %>%
select(response, predictor, effect) %>%
mutate(effect = round(effect, 2)) %>%
filter(abs(effect) >= .05)
```


```{targets check-model-pred-sr}
list(
  tar_target(model_fw_stab_comp_wo_int,
    lm(stab_com ~ richness + resp_div + env_stoch + ct_alive + w_avg_tlvl + Z +
      avg_int_strength + c, data = sim_fw_sem)),
  tar_target(tab_model_fw_stab_comp_wo_int_vif,
    model_fw_stab_comp_wo_int %>%
      performance::check_collinearity() %>%
      as_tibble() %>%
      mutate(Term = var_replacement()[Term]) %>%
      mutate(VIF = round(VIF, 1)) %>%
      select(Term, VIF)
      ),
    tar_target(sim_res_model_fw_stab_comp,
      model_fw_stab_comp %>%
        mutate(
          res = map(model, DHARMa::simulateResiduals),
          ) %>%
      select(-model)
    ),
    tar_target(plot_diagnotisc_model_fw_stab_comp,
    {
      p <- map(sim_res_model_fw_stab_comp$res,
            function(x) {
              plot(x)
              out <- recordPlot()
              ggdraw(out)
            }
      )
      plot_grid(plotlist = p,
        nrow = 3,
        labels = "auto")
      }),
  tar_target(p_diagnotisc_model_fw_stab_comp_file,
    ggsave_multiple(
      paste0("p_diagnotisc_model_fw_stab_comp", c(".jpg", ".pdf")),
      plot = plot_diagnotisc_model_fw_stab_comp,
      path = here::here("report", "figures"),
      scale = 2.4,
      dpi = 400,
      width = 80,
      height = 80 * 1.8,
      units = "mm")
  )
)
```

```{targets}
list(
  tar_target(sim_param_file, here::here("data", "sim_param_csc_rerun"), format = "file"),
  tar_target(sim_param, {readRDS(sim_param_file)}),
  tar_target(param_comb_nb,
    sim_param %>%
      group_by(Z, rho, env_stoch, c, S) %>%
      summarise(n = n())
  ),
  tar_target(sim_param_tab,
    sim_param %>%
      mutate(resp_div = 1 - rho) %>%
      select(-A) %>%
      pivot_longer(everything(), names_to = "Parameter", values_to = "values") %>%
      group_by(Parameter) %>%
      summarise(
        u = list(sort(unique(values))),
        n = length(unique(round(values, 2))),
        min = min(values),
        max = max(values)
        )
    ),
  tar_target(tab_sim_param,
    sim_param_tab %>%
      mutate(Values = pmap_chr(list(u = u, min = min, max = max, n = n),
          function(u, min, max, n) {
            if (length(u) < 10) {
              out <- paste0("[", paste(round(u, 2), collapse = ", "), "]")
            } else {
              out <- paste0("(", round(min, 2), ", ", round(max, 2), ")", ", N = ", n)
            }
            out
          }
          )) %>%
      filter(!Parameter %in% c("sim_id", "fw_id", "rho", "rep")) %>%
      select(Parameter, Values) %>%
      mutate(
        parameter_name = parameter_name_replacement()[Parameter],
        Parameter = latex_symbol_replacement()[Parameter],
        Parameter = paste0(parameter_name, " (", surround_latex_math(Parameter), ")")
        ) %>%
      select(-parameter_name)
  ),
  tar_target(fix_parameter,
    tibble(
      h = 2,
      B0 = 0.5,
      r = 1.0,
      K = 10,
      alpha_ij = 0.5,
      prod_mass = 1.0
    )
  ),
  tar_target(allometric_parameter,
    tibble(
      d0 = 0.4,
      allo_slope = -0.25,
      ax = list(c(producer = 0, ectotherm = 0.88)), #, endotherm = 0.314
      ay = list(c(producer = 0.0, ectotherm = 4.0)), #, endotherm = 8.0 #not allometric
      eij = list(c(carnivory = 0.85, herbivory = 0.45))
    )
  ),
  tar_target(param_table,
    fix_parameter %>%
  bind_cols(allometric_parameter) %>%
  mutate(across(where(is.list), ~map_chr(.x, function(x) paste_named_vector(x)))) %>%
  mutate(across(where(is.double), ~as.character(.x))) %>%
  pivot_longer(everything(), names_to = "Parameter", values_to = "Values") %>%
  mutate(
    parameter_name = parameter_name_replacement()[Parameter],
    Parameter = latex_symbol_replacement()[Parameter],
    Parameter = paste0(parameter_name, " (", surround_latex_math(Parameter), ")")
    ) %>%
  select(-parameter_name) %>%
  bind_rows(tab_sim_param)
  ),
  tar_target(sim_summary_stat, get_sim_summary_stat(x = sim_fw)),
  tar_target(tab_sim_summary_stat,
  sim_summary_stat %>%
    mutate(
      var = var_replacement()[var],
      type = str_to_sentence(type)
      ) %>%
    select(Type = type, `Metric` = var, N = n, `Median (5%, 95%)`)
  )
)
```

```{r, eval = FALSE}
tar_load(sim_summary_stat)
tar_load(sim_fw)
```



# Pipeline

If you ran all the `{targets}` chunks in non-interactive mode, then your R scripts are set up to run the pipeline.

```{r tar-make}
tar_make()
tar_visnetwork()
tar_make_future(workers = 3)
```

# Output

You can retrieve results from the `_targets/` data store using `tar_read()` or `tar_load()`.

```{r output-load, message = FALSE}
library(targets)
library(tidyverse)
library(magrittr)
library(cowplot)
library(here)
library(arrow)
library(piecewiseSEM)
library(semEff)
library(easystats)
library(glmmTMB)
library(ggcorrplot)
library(kableExtra)
lapply(list.files(here::here("R"), full.names = TRUE), source)
```

```{r}
tar_load(sim_fw_sem)
```

```{r}
# Does not work in targets
tar_load(sim_res_model_fw_stab_comp)
tmp_diagnotisc_model_fw_stab_comp <- map(sim_res_model_fw_stab_comp$res,
            function(x) {
              plot(x)
              out <- recordPlot()
              ggdraw(out)
            }
      )
plot_diagnotisc_model_fw_stab_comp <- plot_grid(
  plotlist = tmp_diagnotisc_model_fw_stab_comp,
  nrow = 3,
  labels = "auto")
ggsave_multiple(
  paste0("p_diagnotisc_model_fw_stab_comp", c(".png", ".pdf")),
  plot = plot_diagnotisc_model_fw_stab_comp,
  path = here::here("report", "figures"),
  scale = 2.6,
  dpi = 400,
  width = 80,
  height = 80 * 1.3,
  units = "mm")
```



```{r debug, eval = FALSE}
tar_load(sim_fw)
tar_load(c(sim_fw_no_rerun,
    sim_fw_rerun,
    sim_fw_no_rerun_short,
    sim_fw_no_rerun_no_disconnected,
    sim_fw_non_allo_no_rerun))
tar_load(c(
    sem_simplified_no_rerun,
    sem_simplified_rerun,
    sem_simplified_no_rerun_short,
    sem_simplified_no_rerun_no_disconnected,
    sem_simplified_non_allo_no_rerun
    ))
```

```{r}
tar_load(sim_param_tab)
tar_load(sim_param)
tar_load(tab_sim_param)
tar_load(param_table)
kable(param_table, "html", booktabs = T, escape = FALSE) %>%
  kable_styling()
tar_load(c(fix_parameter, allometric_parameter, tab_sim_param))
ti <- fix_parameter %>%
  bind_cols(allometric_parameter) %>%
  mutate(across(where(is.list), ~map_chr(.x, function(x) paste_named_vector(x)))) %>%
  mutate(across(where(is.double), ~as.character(.x))) %>%
  pivot_longer(everything(), names_to = "Parameter", values_to = "Values") %>%
  mutate(
    parameter_name = parameter_name_replacement()[Parameter],
    Parameter = latex_symbol_replacement()[Parameter],
    Parameter = paste0(parameter_name, " (", surround_latex_math(Parameter), ")")
    ) %>%
  select(-parameter_name) %>%
  bind_rows(tab_sim_param)
ti %>%
  kable("html", booktabs = T, escape = FALSE) %>%
  kable_styling()
```

```{r}
```


## SEM plot

The partial residual function does not work inside targets unfortunately,

>   Last error: â¹ In argument: `data = map(...)`.
> Caused by error in `map()`:
> â¹ In index: 1.
> Caused by error in `is.data.frame()`:
> ! object 'scaled_sim_fw_sem' not found

```{r}
tar_load(
  c(
    formula_sem_bivariate_relations,
    scaled_sem_simplified,
    scaled_sim_fw_sem
  )
)
sem_simplified_bivariate_relations <- tibble(formula = formula_sem_bivariate_relations) %>%
  separate(
    col = formula,
    into = c("response", "predictor"),
    sep = " ~ ", remove = FALSE
    ) %>%
mutate(
  data = map(formula_sem_bivariate_relations,
    ~partialResid(as.formula(.x),
      modelList = scaled_sem_simplified,
      data = scaled_sim_fw_sem
    )
    ),
  coefs = map2(response, predictor,
    ~coefficients(scaled_sem_simplified[[.x]])[c("(Intercept)", .y)]
    ),
  plot = pmap(list(
      data = data,
      response = response,
      predictor = predictor,
      coef = coefs
      ),
    function (data, response, predictor, coef, ext_data) {
      if (predictor %in% c("h", "env_stoch", "resp_div")) {
        p <- data %>%
          ggplot(aes(
              y = yresid, x = xresid,
              group = cut(round(xresid, 1),
                breaks = length(unique(ext_data[[predictor]]))
              )
              )) +
          geom_boxplot(alpha = .1)
      } else {
        p <- data %>%
          ggplot(aes(y = yresid, x = xresid)) +
          geom_point(alpha = .1)
      }
      p +
        geom_abline(
          intercept = coef["(Intercept)"],
          slope = coef[2],
          linewidth = 1
          ) +
        labs(
          x = var_replacement()[predictor],
          y = var_replacement()[response]
          ) +
        coord_cartesian(expand = FALSE) +
        theme_half_open()

    }, ext_data = scaled_sim_fw_sem)
)
```

```{r}
tar_meta(fields = error, complete_only = TRUE) %>%
  print(n = 100)
```


```{r}
label_sem <- as.character(as.roman(seq_len(nrow(sem_simplified_bivariate_relations))))
p_sem_simplified_bivariate_relations <- plot_grid(
  plotlist = sem_simplified_bivariate_relations$plot,
  label_x = 1, hjust = 1.0,
  labels = label_sem
)
```


```{r}
p_sem_tot <- plot_grid(
  p_sem, p_sem_simplified_bivariate_relations,
  nrow = 2, rel_heights = c(.6, 1),
  labels = "auto"
)
```


```{r fig-sem}
ggsave_multiple(
  paste0("p_sem_tot", c(".jpg", ".png", ".pdf")),
  plot = p_sem_tot,
  path = here::here("report", "figures"),
  scale = 2.4,
  dpi = 400,
  width = 80,
  height = 80 * 1.6,
  units = "mm")
```


```{r}
ggsave_multiple(
  paste0("p_sem_simplified_bivariate_relations", c(".jpg", ".png", ".pdf")),
  plot = p_sem_simplified_bivariate_relations + theme(axis.title = element_text(size = 7)),
  path = here::here("report", "figures"),
  scale = 3.5,
  dpi = 300,
  width = 70,
  height = 70 * .9,
  units = "mm")
```


```{r, eval = FALSE}
bivariate_rel_file <- here("report", "figures", "p_sem_simplified_bivariate_relations.jpg")
p_bivariate_rel <- ggdraw() +
  draw_image(magick::image_read(bivariate_rel_file, density = 300),
    x = 0, y = 0,
    width = 1, height = 1,
    hjust = 0, halign = 0, valign = 0
  )
```

```{r plot-sim}
sim_for_plot <- readRDS(here("data", "sim_for_plot"))
length(unique(sim_for_plot$sim_id))
sim_for_plot %<>%
  left_join(
    tar_read(sim_fw_csc_rerun)
  )
stoch <- 0.3
hill <- 2
env_corr <- 0
label_var <- c("w_avg_tlvl", "stab_com", "pop_stab", "async", "sae_total", "cpe")
unique(sim_for_plot$env_stoch)
```


```{r}
sim_for_plot %>%
  filter(env_stoch == !!stoch, c == hill, Z == 1, rho == env_corr) %>%
  arrange(fw_id)
low_z_low_rich <- sim_for_plot %>%
  filter(env_stoch == !!stoch, c == hill, Z == 1, rho == env_corr, richness == 10) %>%
  arrange(desc(max_tlvl), richness)
tu <- timespecies_mat_to_long_tibble(low_z_low_rich$species[[1]])
plot_timeseries_lg_tbl(tu)
```

```{r}
low_z_high_rich <- sim_for_plot %>%
  filter(env_stoch == !!stoch, c == hill, Z == 1, rho == env_corr) %>%
  # For plotting purpose, not too much species
  filter(richness > 15) %>%
  arrange(desc(max_tlvl), desc(richness))

low_z_high_rich_mat <- get_mat_list(low_z_high_rich)
plot_timeseries_lg_tbl(timespecies_mat_to_long_tibble(low_z_high_rich_mat[[2]]))
```

```{r}
sim_for_plot %>%
  filter(env_stoch == !!stoch, c == hill, Z == 100,
    rho == env_corr, richness == 10) %>%
  arrange(desc(max_tlvl))
high_z_low_rich <- sim_for_plot %>%
  filter(env_stoch == !!stoch, c == hill, Z == 100,
    rho == env_corr, richness == 10) %>%
  arrange(desc(max_tlvl))

plot_timeseries_lg_tbl(timespecies_mat_to_long_tibble(high_z_low_rich$species[[3]]))
```

```{r}
sim_for_plot %>%
  filter(env_stoch == !!stoch, c == hill, Z == 100, rho == env_corr) %>%
  # For plotting purpose, not too much species
  filter(richness <= 20) %>%
  arrange(desc(max_tlvl))
high_z_high_rich <- sim_for_plot %>%
  filter(env_stoch == !!stoch, c == hill, Z == 100, rho == env_corr) %>%
  # For plotting purpose, not too much species
  filter(richness == 20) %>%
  arrange(desc(max_tlvl))
plot_timeseries_lg_tbl(timespecies_mat_to_long_tibble(high_z_high_rich$species[[3]]))
```

```{r}
sim_for_plot$int_strength[[1]] %>% dim
p_low_z_low_rich <- plot_sim(x = sim_for_plot,
  id = low_z_low_rich$sim_id[[1]],
  col_palette = NULL,
  node_size_scale = .3,
  tmax = 200,
  var_label = label_var
)
p_low_z_high_rich <- plot_sim(x = sim_for_plot,
  id = low_z_high_rich$sim_id[[2]],
  col_palette = NULL,
  node_size_scale = .5,
  var_label = label_var
)
p_high_z_low_rich <- plot_sim(
  x = sim_for_plot,
  id = high_z_low_rich$sim_id[[5]],
  col_palette = NULL,
  node_size_scale = .3,
  var_label = label_var)
p_high_z_high_rich <- plot_sim(
  x = sim_for_plot,
  id = high_z_high_rich$sim_id[[3]],
  col_palette = NULL,
  node_size_scale = .4,
  var_label = label_var
)

word_label_size <- 11
p_sim_example <- plot_grid(
  p_low_z_low_rich + draw_label(
    "Low PPMR", fontface = 'bold', x = 0, y = .5,
    hjust = .5, vjust = 1, angle = 90, size = word_label_size) +
  draw_label("Low richness", fontface = 'bold', x = 0.5, y = 1,
    hjust = 0.5, vjust = 1, angle = 0, size = word_label_size),
  p_low_z_high_rich + draw_label("High richness", fontface = 'bold', x = 0.5, y = 1,
    hjust = 0.5, vjust = 1, angle = 0, size = word_label_size),
  p_high_z_low_rich + draw_label(
    "High PPMR", fontface = 'bold', x = 0, y = .5,
    hjust = .5, vjust = 1, angle = 90, size = word_label_size),
  p_high_z_high_rich,
  labels = c("b", "", "", ""),
  align = "hv"
)

ggsave_multiple(
  paste0("p_sim_example", c(".png", ".pdf")),
  plot = p_sim_example,
  path = here::here("report", "figures"),
  scale = 2.6,
  dpi = 400,
  width = 80,
  height = 80 * .5,
  units = "mm")
```

```{r}
sim_for_plot %>%
  filter(Z == 100, env_stoch == 0.3, rho %in% c(0, 1), S == 10, h == 2) %>%
  group_by(fw_id) %>%
  summarise(n = n()) %>%
  filter(n > 1)
sim_for_plot %>%
  filter(env_stoch == 0.3, rho %in% c(0, 1), S == 10, h == 3) %>%
  group_by(fw_id) %>%
  summarise(n = n()) %>%
  filter(n > 1)
fwid <- 6
z <- 10
sim_for_plot %>%
  filter(fw_id == fwid, Z == z, env_stoch == 0.6, rho %in% c(0, 1), S == 10, h == 2)

high_resp_div_low_rich <- sim_for_plot %>%
  filter(fw_id == fwid, Z == z, env_stoch == 0.6, rho == 0)
  #filter(env_stoch == .6, Z == 1, S == 10, rho == 0) %>%
  #arrange(desc(async))
p_high_resp_div_low_rich <- plot_sim(
  x = sim_for_plot,
  id = high_resp_div_low_rich$sim_id[[1]],
  col_palette = NULL,
  node_size_scale = .2,
  title = "High response diversity",
  var_label = label_var
)

low_resp_div_low_rich <- sim_for_plot %>%
  filter(fw_id == fwid, Z == z, env_stoch == 0.6, rho == 1) %>%
  arrange(desc(async))
p_low_resp_div_low_rich <- plot_sim(
  x = sim_for_plot,
  id = low_resp_div_low_rich$sim_id[[1]],
  col_palette = NULL,
  node_size_scale = .2,
  title = "Low response diversity",
  var_label = label_var
)

p_sim_rho_example <- plot_grid(
  p_low_resp_div_low_rich,
  p_high_resp_div_low_rich,
  labels = c("a", ""),
  align = "hv"
)
ggsave_multiple(
  paste0("p_sim_rho_example", c(".png", ".pdf")),
  plot = p_sim_rho_example,
  path = here::here("report", "figures"),
  scale = 2.6,
  dpi = 400,
  width = 80,
  height = 80 * .3,
  units = "mm")
```

```{r}
p_methods <- plot_grid(p_sim_rho_example, p_sim_example, nrow = 2, rel_heights = c(1, 2))
ggsave_multiple(
  paste0("p_methods", c(".png", ".pdf")),
  plot = p_methods,
  path = here::here("report", "figures"),
  scale = 3.0,
  dpi = 400,
  width = 80,
  height = 80 * .6,
  units = "mm")
```


```{r}
tar_read(sim_fw) %>%
  filter(env_stoch == .6, S == 40, Z == 100) %>%
  ggplot(aes(y = pop_stab, x = as.factor(resp_div), color = as.factor(c))) +
  geom_boxplot()
```



```{r}
tar_read(sem_simplified_eff_tab) %>%
  filter(effect_type == "direct") %>%
  #filter(response %in% c("async", "pop_stab", "stab_com")) %>%
  filter(predictor %in% c("resp_div")) %>%
  mutate(across(c(response, predictor), ~var_replacement()[.x]))
```




```{r}
tar_load(pred_stab_comp_rho)
p_pred_stab_comp_rho <-
  pred_stab_comp_rho %>%
  mutate(
    response = var_replacement()[response],
    variable = var_replacement()[variable],
    ) %>%
  ggplot(aes(x = rho, y = variable_values, fill = slope)) +
  geom_raster() +
  facet_grid(cols = vars(response), rows = vars(variable), scales = "free") +
  coord_cartesian(expand = FALSE) +
  scale_fill_gradient2(
    low = "red",
    mid = "white",
    high = "blue",
    midpoint = 0,
    space = "Lab",
    na.value = "grey50",
    guide = "colourbar",
    aesthetics = "fill") +
  labs(
    x = "Environmental correlation",
    y = "Food-web structure",
    fill = "Slope Stability-Richness"
    ) +
  theme_bw() +
  theme(legend.position = "bottom")
ggsave_multiple(
  paste0("p_pred_stab_comp_rho", c(".png", ".pdf")),
  plot = p_pred_stab_comp_rho,
  path = here::here("report", "figures"),
  scale = 2.0,
  dpi = 400,
  width = 80,
  height = 80 * 1.1,
  units = "mm")
```

```{r}
tar_load(fixed_effect_fw_stab)
```




```{r}
fw_values_bin <- list(
  ct_alive = c(low = .05, high = 0.30),
  avg_int_strength = c(low = .01, high = .1),
  w_avg_tlvl = c(low = 1, high = 2.3),
  resp_div = c(low = .25, high = 1)
)

tar_read(pred_data)
pred_data_sr_fw <- pred_data %>%
  filter(
    ct_alive %in% fw_values_bin$ct_alive,
    resp_div %in% fw_values_bin$resp_div,
    richness >= 1,
    Z == 100,
    c %in% c(1),
    avg_int_strength %in% fw_values_bin$avg_int_strength,
    env_stoch == .1,
    w_avg_tlvl %in% fw_values_bin$w_avg_tlvl
    ) %>%
mutate(
  group_ct_alive = case_when(
    ct_alive == fw_values_bin$ct_alive["high"] &
      avg_int_strength == fw_values_bin$avg_int_strength["low"] &
      w_avg_tlvl == fw_values_bin$w_avg_tlvl["low"] ~ "High",
    ct_alive == fw_values_bin$ct_alive["low"] &
      avg_int_strength == fw_values_bin$avg_int_strength["low"] &
      w_avg_tlvl == fw_values_bin$w_avg_tlvl["low"] ~ "Low"
    ),
  group_avg_int_strength = case_when(
    ct_alive == fw_values_bin$ct_alive["low"] &
      avg_int_strength == fw_values_bin$avg_int_strength["high"] &
      w_avg_tlvl == fw_values_bin$w_avg_tlvl["low"] ~ "High",
    ct_alive == fw_values_bin$ct_alive["low"] &
      avg_int_strength == fw_values_bin$avg_int_strength["low"] &
      w_avg_tlvl == fw_values_bin$w_avg_tlvl["low"] ~ "Low"
    ),
  group_w_avg_tlvl = case_when(
    ct_alive == fw_values_bin$ct_alive["low"] &
      avg_int_strength == fw_values_bin$avg_int_strength["low"] &
      w_avg_tlvl == fw_values_bin$w_avg_tlvl["high"] ~ "High",
    ct_alive == fw_values_bin$ct_alive["low"] &
      avg_int_strength == fw_values_bin$avg_int_strength["low"] &
      w_avg_tlvl == fw_values_bin$w_avg_tlvl["low"] ~ "Low"
    )) %>%
pivot_longer(starts_with("group_")) %>%
filter(!is.na(value)) %>%
mutate(
  name = str_remove(name, "group_"),
  resp_div_cat = str_replace_all(resp_div, resp_div_replacement()),
  variable_values = case_when(
    name == "ct_alive" & value == "Low" ~ fw_values_bin$ct_alive["low"],
    name == "ct_alive" & value == "High" ~ fw_values_bin$ct_alive["high"],
    name == "avg_int_strength" & value == "Low" ~ fw_values_bin$avg_int_strength["low"],
    name == "avg_int_strength" & value == "High" ~ fw_values_bin$avg_int_strength["high"],
    name == "w_avg_tlvl" & value == "Low" ~ fw_values_bin$w_avg_tlvl["low"],
    name == "w_avg_tlvl" & value == "High" ~ fw_values_bin$w_avg_tlvl["high"]
  )
)

breaks_log_richness <- log(c(3, 6, 20))
breaks_log_stab_com <- log(c(250, 500, 1000))

p_pred_data_sr_fw <- pred_data_sr_fw %>%
  mutate(
    name = var_replacement()[name]
    ) %>%
  ggplot(aes(
      x = richness, y = stab_com,
      color = resp_div_cat,
      fill = resp_div_cat,
      linetype = value,
      #alpha = as.factor(avg_int_strength)
      )) +
  geom_line(linewidth = .8) +
  geom_ribbon(
    aes(ymin = stab_com - stab_com_se, ymax = stab_com + stab_com_se),
    alpha = .3, color = NA) +
  scale_color_manual(values = resp_div_cat_colors()) +
  scale_fill_manual(values = resp_div_cat_colors()) +
  scale_x_continuous(breaks = breaks_log_richness, label = exp(breaks_log_richness)) +
  scale_y_continuous(breaks = breaks_log_stab_com, label = exp(breaks_log_stab_com)) +
  facet_grid(cols = vars(name)) +
  labs(
    x = var_replacement()["richness"],
    y = var_replacement()["stab_com"],
    fill = var_replacement()["resp_div"],
    color = var_replacement()["resp_div"],
    linetype = "Food-web structure value"
  ) +
  theme_bw() +
  theme(legend.position = "bottom") +
  guides(
    linetype = guide_legend(keywidth = 2,
      override.aes = list(fill = NA, alpha = 1)
      ),
    fill = guide_legend(override.aes = list(linetype = 0, alpha = 1))
  )

ggsave_multiple(
  paste0("p_pred_data_sr_fw", c(".png", ".pdf")),
  plot = p_pred_data_sr_fw,
  path = here::here("report", "figures"),
  scale = 3,
  dpi = 400,
  width = 80,
  height = 80 * .4,
  units = "mm")
```

## Figure SR

```{r}
pred_stab_comp_resp_div
p_pred_sr_resp_div +
  geom_point(
    data = pred_data_sr_fw %>%
      filter(richness == min(richness)) %>%
      mutate(name = var_replacement()[name]) %>%
      rename(variable = name),
    aes(color = NULL, fill = NULL)
  )

p_pred_sr <- plot_grid(
  p_pred_data_sr_fw + theme(legend.position = "right"),
  # Add location of the fw values of p_pred_data_sr_fw
  p_pred_sr_resp_div +
  geom_point(
    data = pred_data_sr_fw %>%
      filter(richness == min(richness)) %>%
      mutate(name = var_replacement()[name]) %>%
      rename(variable = name),
    aes(color = NULL, fill = NULL)
  ),
  nrow = 2,
  rel_heights = c(.7, 1),
  labels = "auto"
)
ggsave_multiple(
  paste0("p_pred_sr", c(".png", ".pdf")),
  plot = p_pred_sr,
  path = here::here("report", "figures"),
  scale = 2.0,
  dpi = 400,
  width = 120,
  height = 120 * .7,
  units = "mm")
```



## Simplified SEM

simplified SEM for main text

```{r}
tar_read(sem_simplified_coeff) %>%
  filter(abs(Std.Estimate) > .1) %>%
  janitor::clean_names() %>%
  mutate(std_estimate = round(std_estimate, 1))
tar_read(sem_simplified_rsquared) %>%
  janitor::clean_names() %>%
  mutate(r_squared = round(r_squared, 2))
```

## Modelling interaction between stability and food-web structure


```{r}
tar_load(sim_fw_df)
sim_fw_df %<>%
  mutate(across(c(stab_com, pop_stab, async, cpe, sae_total, evenness_sae, sae_even, cpe_int, cpe_env), log))

tu <- list(
      #ct_alive = lm(ct_alive ~ ct + S, sim_fw_df),
      #richness = lm(richness ~ ct + S, sim_fw_df),
      #  max_tlvl = lm(max_tlvl ~ ct + S + Z, sim_fw_df),
      w_avg_tlvl = lm(w_avg_tlvl ~ richness + ct_alive + Z, sim_fw_df),
      avg_omnivory = lm(avg_omnivory ~ ct_alive + richness, sim_fw_df),
      avg_int_strength = lm(avg_int_strength ~ ct_alive + richness + h, sim_fw_df),
      pop_stab = lm(pop_stab ~ Z + richness + avg_int_strength + w_avg_tlvl + ct_alive + env_stoch + h, sim_fw_df),
      evenness_sae = lm(evenness_sae ~ richness + avg_int_strength + w_avg_tlvl + ct_alive, sim_fw_df),
      sae_even = lm(sae_even ~ richness, sim_fw_df),
      cpe_int = lm(cpe_int ~ richness + avg_int_strength + w_avg_tlvl + ct_alive + h, sim_fw_df),
      cpe_env = lm(cpe_env ~ richness + rho, sim_fw_df),
      async = lm(async ~ sae_even + evenness_sae + cpe_env + cpe_int, sim_fw_df),
      stab_com = lm(stab_com ~ pop_stab + async, sim_fw_df)
    )
map_dfr(tu, check_collinearity)
sem <- as.psem(tu)
sem <- update(sem, avg_omnivory %~~% w_avg_tlvl)
```

```{r}
ti <- compute_rotated_pca(sim_fw_df %>% select(
    richness, w_avg_tlvl, avg_omnivory, avg_int_strength,
    max_tlvl
    ), naxis = 2)
p <- plot_rotated_pca(pca_rotated = ti, axis = c(1, 2))
p[[1]]
```

```{r}
ti <- compute_rotated_pca(sim_fw_df %>% select(
    w_avg_tlvl, avg_omnivory, avg_int_strength
    ), naxis = 2)
p <- plot_rotated_pca(pca_rotated = ti, axis = c(1, 2))
p[[1]]
p$rotated
cor(ti$rotated$scores[, "RC1"], sim_fw_df[,"richness"])
```

## Correlation matrix






```{r}
tar_load(c(sim_fw))
colnames(sim_fw)
summary(sim_fw$avg_int_strength)
unique(sim_fw$env_stoch)
tar_read(p_cor)
tar_read(p_prod_pop_stab)
tar_read(p_stab_s_stress)
tar_read(p_ct_stab)
tar_read(p_rich_stab)

sim_fw %>%
  filter(env_stoch == 0.3, rho %in% c(0, .5, 1)) %>%
  ggplot(aes(x = richness, y = cpe_env, color = as.factor(rho))) +
  geom_point() +
  labs(x = "Species richness", y = "Comp. effects (Environment)") +
  theme_bw()
```

```{r}
var_fw_struct <- c("richness", "ct_alive", "Z")
var_fw_emergent_struct <- c("max_tlvl", "w_avg_tlvl", "avg_omnivory")
var_fw_flux <- c("avg_int_strength")
var_stab <- c("async", "stab_com", "pop_stab")
```

```{r, eval = FALSE}
#colnames(simZ)
pairs(sim_fw %>%
  filter(env_stoch == .2) %>%
  select(c(var_fw_struct, var_fw_emergent_struct, var_fw_flux, pop_stab)))
```

```{r}
unique(sim_fw$Z)
```

```{r}
sim_fw %>%
  filter(
    rho %in% c(0), env_stoch == .3
    ) %>%
  ggplot(aes(y = pop_stab, x = as.factor(Z))) +
  geom_boxplot()
```



```{r}
sim_fw %>%
  filter(
    rho %in% c(0), env_stoch == .3, Z == 25) %>%
  pivot_longer(c(stab_com, async, sae_total, cpe,
      sae_even, evenness_sae,
      cpe_int, cpe_env, pop_stab
      ), names_to = "async_decomp", values_to = "values") %>%
  mutate(async_decomp = var_replacement()[async_decomp]) %>%
  ggplot(aes(x = as.factor(richness), y = values)) +
  geom_boxplot() +
  labs(x = "Species richness", y = "Asynchrony component") +
  facet_wrap(~async_decomp, ncol = 3, scales = "free_y") +
  theme_bw()
```

```{r}
tar_load(sim_sp)

sim_sp %>%
  filter(env_stoch == .4, rho == 1, Z == 100) %>%
  ggplot(aes(x = tlvl, y = log(cv_sp))) +
  geom_point() +
  geom_smooth()
```

```{r}
tar_read(sem_coeff) %>%
  filter(abs(Std.Estimate) > .1) %>%
  mutate(Std.Estimate = round(Std.Estimate, 1))
tar_read(sem_rsquared) %>%
  mutate(R.squared = round(R.squared, 2))
tar_load(sem_collinearity)
tar_read(sem_collinearity) %>%
  print(., n = 38)
```



```{r}
tar_load_globals()
tar_load(pred_stab_comp_resp_div)
pred_data_show <- pred_stab_comp_resp_div %>%
  filter(response == "stab_com") %>%
  select(-response) %>%
  pivot_wider(names_from = "variable", values_from = "variable_values") %>%
  filter(!is.na(w_avg_tlvl))
unique(pred_data_show$w_avg_tlvl) %>% round(., 3)
unique(pred_data_show$resp_div) %>% round(., 2)
```












The `targets` dependency graph helps your readers understand the steps of your pipeline at a high level.

```{r}
tar_visnetwork()
```

At this point, you can go back and run `{targets}` chunks in interactive mode without interfering with the code or data of the non-interactive pipeline.
