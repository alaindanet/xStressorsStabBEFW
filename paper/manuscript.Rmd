---
title: Response diversity and food-web structure drive stability and stability-richness relationships in complex communities
author: "Alain Danet (1), Sonia Kéfi (2,3), Thomas F Johnson (1), Andrew P. Beckerman (1)"
date: ""
output:
  bookdown::pdf_document2:
    latex_engine: xelatex
    keep_tex: true
    spacing: double
    number_sections: false
  officedown::rdocx_document:
    number_sections: false
    base_format: "bookdown::word_document2"
always_allow_html: true
bibliography: references.bib
link-citations: true
csl: nature.csl
#csl: ecology-letters.csl
toc: false
linestretch: 2.0
header-includes:
  - \usepackage[left]{lineno}
  - \linenumbers
  - \usepackage{hyperref}
  - \hypersetup{backref=true}
  - \usepackage{setspace}\doublespacing
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  cache = FALSE,
  collapse = TRUE,
  comment = "#>",
  fig.pos = "H",  # pdf mode
  #fig.dim = c(7, 7),
  fig.fullwidth = TRUE,
  fig.show = "hold",
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  results = TRUE,
  fig.path="figures/"
)
```

```{r, results = FALSE}
sapply(c("targets", "tidyverse", "magrittr", "cowplot", "here", "piecewiseSEM",
    "semEff", "ggcorrplot", "kableExtra", "rmarkdown", "officedown"),
  require,
  character.only = TRUE)
mytheme <- theme_cowplot(font_size = 8) +
background_grid() +
theme(legend.position = "bottom")
theme_set(mytheme)
sapply(list.files(here("R"), full.names = TRUE), source)
```

- 1 School of Biosciences, Ecology and Evolutionary Biology, University of Sheffield, Western Bank, Sheffield, S10 2TN, UK
- 2 ISEM, CNRS, Univ. Montpellier, IRD, EPHE, Montpellier, France
- 3 Santa Fe Institute, 1399 Hyde Park Road, Santa Fe, NM 87501, USA

---
## IDEA:
# Talk about about how stochasticity minor interaction effects similar to
# dispersal (Holt, 1985; other papers I guess)
---

# Abstract (179/200 words)

Global environmental change constitutes a suite of major threats to biodiversity
and ecosystem functioning. These threats can materialised via changes to the
stability of communities and the services they provide. Despite independent
advances in understanding the impact on stability of community size and
structure, synchrony and responses to environmental variation, there remains no
core theory connecting these key processes. Developing this theory requires
combining concepts from diversity - stability relationships, synchrony and the
portfolio effect, and the emerging field of response diversity. Using a
stochastic Bioenergenetic food-web model of 20-50 interacting species, we show
that response diversity and species richness are also strong drivers of overall
community stability in complex food-webs. We further show that connectance and
average trophic level consistently dampened asynchrony but that average trophic
level stabilises population stability. Positive stability-richness relationships
always emerged only in presence of response diversity, but interaction strength,
connectance, average trophic level strongly interact with response diversity to
determine the sign of stability-diversity relationships. Our study disentangles
the complex effects of food-web structure on community stability and its
pathway, showing that response diversity is a mechanism that generates positive
stability-diversity relationships, beyond plant communities.


# Introduction

Ecological communities are facing ever-growing environmental variability caused
by climate and environmental change[@lee_ipcc_2023;
@simmons_refocusing_2021]. Decreases in the temporal stability of communities
are increasingly documented[@olivier_urbanization_2020;
@de_boeck_patterns_2018; @hansen_climate_2013; @bluthgen_land_2016; @harris_biological_2018], raising
concerns about the long-term consequences at the ecosystem scale. Repeated calls
have been made to clarify the role of environmental stochasticity in driving the
temporal stability of ecological communities[@yang_predictability_2019]. It
remains challenging because species have a diversity of response to
environmental change [@elmqvist_response_2003; @loreau_species_2008;
@ives_stability_2000; @ross_how_2023] (“response diversity”) and they are
entangled in complex communities such as food-webs, that both ultimately drive
community stability[@may_will_1972; @angelis_stability_1975; @mccann_weak_1998;
@mccann_reevaluating_1997; @thebault_stability_2010] and stability-richness
relationships[@thebault_trophic_2005; @thebault_relationship_2006]. Despite the
overarching effects of response diversity and food-web structure on temporal
community stability, they have been so far studied in isolation.

The temporal stability of ecological communities stems from average population
stability and asynchrony of population fluctuations[@thibaut_understanding_2013;
@zhao_biodiversity_2022]. While higher environmental stochasticity/variability
decrease population stability by increasing the amplitude species oscillations,
higher species response diversity increases asynchrony of species
fluctuations[@doak_statistical_1998; @loreau_species_2008;
@thibaut_understanding_2013]. This is increasingly well-established in
simplified species assemblages, where high response diversity increases
asynchrony and is the determinant of positive stability-diversity relationships
across many taxa[@tilman_biodiversity_2006; @olivier_urbanization_2020;
@zhao_biodiversity_2022]. However, it remains largely unknown how the effects of
environmental stochasticity and response diversity on population stability and
asynchrony are mediated in the context of complex communities, such as
food-webs.

Complexity-stability theory well documented that the structure of food-webs
determines population stability [@may_will_1972; @angelis_stability_1975;
@mccann_weak_1998; @mccann_reevaluating_1997; @vasseur_environmental_2007;
@eschenbrenner_diversity_2023], and stability-richness relationships
[@thebault_trophic_2005; @thebault_relationship_2006]. Population stability is
indeed documented to decrease with increasing interaction strength
[@may_will_1972; @mccann_weak_1998], connectance [@may_will_1972], but to be
higher at higher trophic level [@shanafelt_stability_2018; @danet_species_2021].
In result, the distribution and strength of species interactions, as well as
trophic level might have a strong effect on community stability and
stability-richness relationships [@thebault_trophic_2005;
@thebault_relationship_2006]. This expectation is reinforced by documented
examples where predators can mediate the effect of response diversity on
asynchrony [@vasseur_environmental_2007], and synchronise the dynamics of their
prey [@raimondo_interspecific_2004; @korpimaki_predatorinduced_2005]. Recent
study in plant communities suggests that asynchrony stems mainly from the
statistical averaging of independent species fluctuations (“portfolio effects”),
rather than compensatory dynamics resulting from response diversity and species
interactions [@zhao_biodiversity_2022]. But we might expect that prey switching
and trophic cascades arising in food-webs lead to higher compensatory dynamics
than in plant communities [@mccann_diversitystability_2000;
@fahimipour_compensation_2017].

Here, we investigated the effects of response diversity and food-web structure
on community stability and on stability-richness relationships in stochastic
environment. To do so, we developed an extension of the Bioenergetic food web
model [@brose_allometric_2006; @lajaaiti_ecologicalnetworksdynamicsjl_2024]
which includes environmental stochasticity and response diversity
[@loreau_species_2008; @vasseur_environmental_2007; @ripa_food_2003]. We
included environmental stochasticity on allometric natural death rate, such as
species of higher trophic level had lower death rate in
average[@vasseur_environmental_2007], response diversity was included as the
inverse of species correlation in their mortality rates.  We first decipher the
respective effects of food-web structure, environmental stochasticity, and
response diversity on community stability and its partition into population
stability and asynchrony (i.e. portfolio and compensatory effects). We then
investigate how food-web structure and response diversity interact to determine
the sign of stability-richness relationship.


```{r}
tar_load(sim_param_tab)
p_mm <- function(
  v = "S",
  data = sim_param_tab
) {
  out <- data[data$Parameter %in% v, ]
  paste0("", signif(out[["min"]], 1), "-", signif(out[["max"]], 1), "")
}
```

```{r, eval = FALSE}
p_mm("ct")
```


# Results

```{r}
sem_cap <- paste0(
  "Structural Equation Model linking food-web structure and stressors to temporal
  stability of community biomass. a, continuous red arrows display positive and
  dashed blue arrows display negative standardised effects, width of the arrows
  being proportional to the absolute values of the standardised effects. Only
  the standardised coefficients whose absolute values are superior to 0.05 are
  displayed. The full table of coefficients including control variables is
  displayed in Table S4. A more complete SEM containing further partition of
  compensatory effects and control variables is displayed in Table S5. b, total
  effects of food-web structure on community stability, asynchrony, and
  population stability. N = ", nrow(tar_read(sim_fw)), " simulations.") %>%
  str_replace_all("\\s+", " ")
```

```{r sem, fig.cap=sem_cap, fig.id = "sem"}
knitr::include_graphics(here("report", "figures", "p_sem_fig.pdf"))
```

```{r}
tar_load(c(sem_doak_eff_tab, sem_simplified_eff_tab))

```

```{r fig2-coeff, eval = FALSE}
tar_read(sem_fig_coeff)
tar_read(sem_doak_rsquared_csc_rerun)
```

```{r}
tar_load(sim_summary_stat)
m_sim <- function(
  v = "stab_com",
  data = sim_summary_stat,
  col = "Median (5%, 95%)"
  ) {
  data[data$var %in% v, ][[col]]
}
```
```{r, eval = FALSE}
m_sim(v = c("stab_com", "async"))
m_sim(c("stab_com", "async"))
m_sim(col = "n")
```



## Drivers of community stability, population stability and asynchrony

```{r}
get_eff <- function(
  y = "pop_stab", x = "richness",
  d = 2, effect_type = "direct",
  tab = sem_doak_eff_tab) {
  mask <- tab$response == y & tab$predictor == x &
    tab$effect_type == effect_type
  round(tab[mask, ]$effect, d)
}

rpt <- get_eff(y = "pop_stab", x = "w_avg_tlvl")
rpc <- get_eff(y = "pop_stab", x = "c")
rpe <- get_eff(y = "pop_stab", x = "env_stoch")
rpd <- get_eff(y = "pop_stab", x = "resp_div")

rsr <- get_eff(y = "sae_doak", x = "richness")
rst <- get_eff(y = "sae_doak", x = "w_avg_tlvl")
rsi <- get_eff(y = "sae_doak", x = "avg_int_strength")
rsc <- get_eff(y = "sae_doak", x = "ct_alive")

rcr <- get_eff(y = "cpe_int", x = "richness")
rci <- get_eff(y = "cpe_int", x = "avg_int_strength")
rct <- get_eff(y = "cpe_int", x = "w_avg_tlvl")
rcd <- get_eff(y = "cpe_int", x = "resp_div")
rcc <- get_eff(y = "cpe_int", x = "ct_alive")

# Detailled SEM coefficients
rsr <- get_eff(y = "sae_doak", x = "richness")
rst <- get_eff(y = "sae_doak", x = "w_avg_tlvl")
rsr <- get_eff(y = "sae_doak", x = "richness")
rsa <- get_eff(y = "sae_doak", x = "avg_int_strength")
rsct <- get_eff(y = "sae_doak", x = "ct_alive")
rsc <- get_eff(y = "sae_doak", x = "c")
rsd <- get_eff(y = "sae_doak", x = "resp_div")

```


```{r}
rscp <- get_eff(y = "stab_com", x = "pop_stab")
rsca <- get_eff(y = "stab_com", x = "async")

rac <- get_eff(y = "async", x = "cpe")
ras <- get_eff(y = "async", x = "sae_total")
```

The `r format(m_sim(col = "n"), scientific = FALSE)` simulations generated a
wide range of food-web structure (Median (5%, 95%), species richness:
`r m_sim("richness")`, connectance: `r m_sim("ct_alive")`, average interaction
strength: `r m_sim("avg_int_strength")`, maximum trophic level:
`r m_sim("max_tlvl")`). We quantified the  (1) the respective effects of
population
stability and asynchrony on community stability, (2) the source of asynchrony,
either portfolio effects or compensatory dynamics, and disentangled (3) how
stressors (environmental stochasticity, response diversity) and food-web
structure (species richness, average interaction strength, average trophic
level, connectance) determine average population stability, portfolio effects
(using Doak's definition), and compensatory dynamics stemming from species
interactions. We did so by using a structural equation model which included all
the simulation variables as control (i.e. predator interference, predator-prey
mass ratio) to avoid the detection of spurious non-causal effects (See Methods,
Table/Figure SXX). Overall, we found that population stability had a positive
effect twice higher than asynchrony on the temporal stability of community
biomass (resp. $r_\delta$= `r rscp` and `r rsca`, $r_\delta$ being the
standardised coefficient, Fig. \@ref(fig:sem)a). We further found that
asynchrony was driven more by portfolio effects than by compensatory dynamics
stemming from species interactions (resp. $r_\delta$= `r rac` and `r ras`).
However, we found opposite results, i.e. that compensatory dynamics contributed
more than portfolio effects to asynchrony, using an alternative portfolio
effects definition that attributes the effects of response diversity to
compensatory effects instead of portfolio effects (Fig. SXX).

Food-web structure had consistent negative effects on asynchrony, mainly through
portfolio and compensatory effects (Fig. \@ref(fig:sem)a). Indeed, average
trophic level and connectance had negative effects on the compensatory effects
stemming from species interactions (resp. $r_\delta$= `r rct` and `r rcc`, Fig.
\@ref(fig:sem)a), while average interaction strength had a small negative
effects on portfolio effects ($r_\delta$= `r rsi`). In contrast, response
diversity and species richness had strong positive effects on asynchrony,
mainly through portfolio effects. Response diversity had a strong positive
effect on portfolio effects ($r_\delta$= `r rsd`), and a negative one on
compensatory dynamics ($r_\delta$= `r rcd`). In turn, species richness had a
positive effect on both portfolio and compensatory effects (resp.
$r_\delta$=`r rsr` and `r rcr`). Finally, environmental stochasticity had a
small negative effect on compensatory dynamics.

In turn, we found little effect of food-web structure on population stability,
except for average trophic level having a strong positive effect on
population stability ($r_\delta$= `r rpt`, Fig. \@ref(fig:sem)a). In turn, the
variance of environmental stochasticity had a strong negative effect on
population stability ($r_\delta$= `r rpe`), while response diversity had a small
positive effect on population stability ($r_\delta$= `r rpd`).


```{r}
rtsdiv <- get_eff(y = "stab_com", x = "resp_div", effect_type = "total")
rtsenv <- get_eff(y = "stab_com", x = "env_stoch", effect_type = "total")

rtsr <- get_eff(y = "stab_com", x = "richness", effect_type = "total")
rtst <- get_eff(y = "stab_com", x = "w_avg_tlvl", effect_type = "total")
rtsz <- get_eff(y = "stab_com", x = "Z", effect_type = "total")
rtsc <- get_eff(y = "stab_com", x = "c", effect_type = "total")
rtsct <- get_eff(y = "stab_com", x = "ct_alive", effect_type = "total")
rtsi <- get_eff(y = "stab_com", x = "avg_int_strength", effect_type = "total")

rtpr <- get_eff(y = "pop_stab", x = "richness", effect_type = "total")
rtpt <- get_eff(y = "pop_stab", x = "w_avg_tlvl", effect_type = "total")
rtpi <- get_eff(y = "pop_stab", x = "avg_int_strength", effect_type = "total")
rtpz <- get_eff(y = "pop_stab", x = "Z", effect_type = "total")
rtpc <- get_eff(y = "pop_stab", x = "c", effect_type = "total")
rtpct <- get_eff(y = "pop_stab", x = "ct_alive", effect_type = "total")

rtar <- get_eff(y = "async", x = "richness", effect_type = "total")
rtat <- get_eff(y = "async", x = "w_avg_tlvl", effect_type = "total")
rtai <- get_eff(y = "async", x = "avg_int_strength", effect_type = "total")
rtaz <- get_eff(y = "async", x = "Z", effect_type = "total")
rtac <- get_eff(y = "async", x = "c", effect_type = "total")
rtact <- get_eff(y = "async", x = "ct_alive", effect_type = "total")
```

Deriving the sum of direct and indirect effects from the structural equation
model, we show that both the variance of environmental stochasticity and species response
diversity had by far the most important effects on community stability (resp.
$r_\delta$= `r rtsenv` and `r rtsdiv`, Fig. \@ref(fig:sem)b). Species richness
and average trophic level had similar positive total effects on community stability
($r_\delta$=`r rtsr`), but through opposite pathways and antagonistic effects on
asynchrony and population stability. While species richness increased community
stability through a strong positive effect on asynchrony ($r_\delta$=`r rtar`), it
also weakly decreased population stability ($r_\delta$=`r rtpr`). At the opposite, average
trophic level increased community stability through strong positive effect on
population stability ($r_\delta$=`r rtpt`), but dampened by a negative total
effect on asynchrony ($r_\delta$=`r rtat`). Interestingly, average interaction
strength also had a positive effect on population stability and a negative one
on asynchrony (resp. $r_\delta$= `r rtpi` and `r rtai`), but resulting in a
total negative effect on community stability ($r_\delta$= `r rtsi`).
Connectance, instead, had a negative effect on community stability ($r_\delta$=
`r rtsct`) through consistent negative effects on asynchrony and population
stability (resp. $r_\delta$=`r rtact` and `r rtpct`).

## Stability-richness relationship

```{r}
tar_load(default_variable_values_pred)
pv <- default_variable_values_pred

pv_cap <- paste0(
  "connectance = ", round(pv["ct_alive"], 2),
  ", average interaction strength = ", round(pv["avg_int_strength"], 3),
  ", average trophic level = ", round(pv["w_avg_tlvl"], 2),
  ", predator interference = ", round(pv["c"], 1),
  ", Predator-Prey Mass Ratio = ", round(pv["Z"]),
  ", and environmental stochasticity = ", round(pv["env_stoch"], 1)

)
pred_cap <- paste0("Slope of the community stability - species
  richness relationship according to food-web structure and response diversity. (a),
  Diagrams displaying the slope coefficients of the effect of species richness
  on community stability. The average values of the control variables were used
  to generate the predictions: ", pv_cap, ". (b, c): Examples of predictions
  from the model for two combinations of average trophic level and response
  diversity (values displayed in panel (a)). Lines display the mean predictions
  of the model. The coefficients of the linear model are displayed in Fig. S4.
  Relationships between population stability, asynchrony and species richness
  are displayed in Fig. S5."
  ) %>%
  str_replace_all("\\s+", " ")
```


```{r pred, fig.cap = pred_cap, fig.id = "pred"}
knitr::include_graphics(here("report", "figures", "p_fig3.pdf"))
```

Using a more complex linear model including interactions among food-web
structure, response diversity and environmental stochasticity, we found that
food-web structure strongly interacts with response diversity to determine the
sign of the stability-richness relationships. In the absence of response
diversity, we found only negative stability-richness, regardless of the food-web
structure (Fig. \@ref(fig:pred)a). Response diversity enabled the rise of
positive stability-richness relationships, enhanced by average interaction
strength and dampened by average trophic level and connectance. Higher
interaction strength led to positive stability-richness relationships for lower
values of response diversity, interaction strength enhanced asynchrony-richness
relationships (Fig. SXX), so that the stronger positive stability-richness
relationships were found at both high interaction strength and response
diversity. In contrast, higher average trophic level and connectance both led to
negative stability-richness relationships, because they led to more negative
population stability-richness relationships and weaker positive
asynchrony-richness relationships (Fig. SXX). Overall, our results highlight
strong contrast between the relatively small effects of food-web structure on overall
community stability (Fig. \@ref(fig:sem)b) and their strong effects on
stability-richness relationships (Fig. \@ref(fig:pred)a).

```{r, eval = FALSE}
tar_read(p_int_fw_str)
```

# Discussion

Temporal community stability is well documented in simplified assemblages
such as plant communities, where community stability is driven by asynchrony in
species fluctuations. In contrast, our results show that community stability in
complex food-webs was mainly driven population stability rather than asynchrony.
In the range of our simulations, we identified that environmental variability
and response diversity were the main driver of community stability, far more
than any food-web structure component, a result consistent across methodological
choices (Fig. SXX). Moreover, we found that species richness and food-web
structure have antagonistic but consistent effect on community stability.
Finally, we found that the sign of the stability-richness relationship is
strongly mediated by the interaction between food-web structure and response
diversity. These results highlight the need to account for both food-web
structure and response diversity to improve our understanding of the stability
of ecological communities in variable environments.

Our results show that community stability in complex food-webs is mainly driven
by population stability rather than synchrony, which contrasts with empirical
data that reported an equivalent influence of population stability and
asynchrony on community stability in birds and bats assemblages
[@olivier_urbanization_2020]. However, our results are in accordance with
previous findings in empirical food-webs [@danet_species_2021] and
food-web models [@eschenbrenner_diversity_2023]. Are there fundamental
differences between single trophic and food-web in the contribution of
population stability and asynchrony? We found that all food-web metrics, i.e.
average trophic level, connectance, and average interaction strength all
decreased asynchrony. In line with previous studies showing that predators can
synchronise their preys [@raimondo_interspecific_2004;
@kortsch_disentangling_2021], and that predator-prey couples are more
synchronous [@danet_species_2021], those results suggest that trophic links
might dampen overall asynchrony in ecological communities. A complementary
explanation could be related to the biomass structure of food-webs. Food-webs
typically includes range of bodymasses much larger than in species assemblages,
differing in bodymass by several orders of magnitude [@brose_predator_2019].
This highly uneven biomass distribution can translate in uneven species
variability, thereby creating uneven contributions of species to asynchrony
[@thibaut_understanding_2013] and limits portfolio effects and compensatory
dynamics in species rich communities [@zhao_biodiversity_2022]. The fact that
average trophic level, connectance, and average interaction strength all
decreased evenness of portfolio effects lends toward this hypothesis. Our
results then reinforce the evidence that community stability in food-web might
be driven more by population stability than asynchrony.

We further found that asynchrony was driven more by portfolio effects than
compensatory dynamics. But this results was dependant of the definition of
portfolio effects, as we found the opposite while taking Tilman's
definition[@tilman_ecological_1999; @zhao_biodiversity_2022] instead of Doak's
one[@doak_statistical_1998], in contrast with previous assessment in
experimental plant communities[@zhao_biodiversity_2022]. Portfolio effects is
supposed to measure stabilising effects of species richness in the absence of
species interactions[@loreau_biodiversity_2021]. While Tilman's considers that
portfolio effects are emerging from statistical averaging of independent species
fluctuations alone (i.e. in the absence of covariance among species), Doak's
explicitly states that statistical averaging can only emerge if compensatory
dynamics hold by response diversity is present[@zhao_biodiversity_2022]. While
the definition of portfolio effects is a long-standing
debate[@zhao_biodiversity_2022], our results show that the importance of
portfolio effects depends on where response diversity acts. In agreement with
previous studies[@loreau_species_2008; @doak_statistical_1998;
@thibaut_understanding_2013; @loreau_biodiversity_2021], we believe that the
definition of portfolio effects standing from statistical averaging and
environmental compensatory dynamics generated by response diversity is the more
appropriate as the absence of species interactions does not guarantee independent
species fluctuations, because common environment tend to generate positive
covariances among species[@loreau_biodiversity_2021]. The fact that
environmental stochasticity alone had a really small effect on asynchrony to the
difference of response lends toward this interpretation. So, our study suggests
that response diversity is a key ingredient to generate asynchrony, not only in
plant communities, but also in food-webs. We further show that explicitly
manipulating response diversity highlight that it is the main driver of
asynchrony, and that the respective contribution of portfolio effects and
compensatory dynamics to asynchrony depends on the decision to consider that
response diversity is part of portfolio effects or compensatory dynamics.

We further found that higher average trophic level lead to higher community
stability by increasing average population stability, confirming previous
theoretical[@brose_allometric_2006; @shanafelt_stability_2018;
@eschenbrenner_diversity_2023] and empirical[@danet_species_2021] results. But
this effect disappeared when we simulated community dynamics with equal
mortality rates for all species instead of allometric ones (Fig. S1). It then
suggests that higher stability of food-web with higher average trophic level is
because of species life-history traits and not directly by species interactions.
The assumption that natural mortality rates decreased with bodymass is well
documented across eukaryotes[@hatton_linking_2019] and seems to be a necessary
ingredient for the stabilising effects of higher trophic levels. In turn, we
found that average trophic level and connectance decreases strongly asynchrony
mainly through a negative effect on compensatory dynamics generated by species
interactions. Both higher connectance and average trophic level lead to greater
generalism of predators in the niche model that we used to build food-webs. The
synchronising effects of average trophic level and connectance echo with
empirical findings that a generalist predator can indeed synchronise the
dynamics of numerous preys[@raimondo_interspecific_2004;
@korpimaki_predatorinduced_2005]. The overall effect of connectance on overall
community stability was quite low, in agreement with previous empirical
findings[@danet_species_2021]. Similarly, we found very low effects
of the average interaction strength on community stability which in apparent
disagreement with the predominant role of interaction strength and connectance
on stability in the complexity-stability debate [complexity-stability paradox,
@may_will_1972]. But our study focused on the temporal stability of coexisting
species at steady state, which might mask connectance and interaction strength
values that led to species extinctions during the transient phase.

We found that species richness had a positive effect on community stability of
the same importance as average trophic level, but through opposite pathways.
Species richness had strong positive effects on asynchrony through positive
effects on portfolio and compensatory effects. It is in agreement with previous
study showing that species richness can promote asynchrony by both
pathways[@zhao_biodiversity_2022]. Furthermore, our study shows that the positive
effects of species richness on asynchrony is three times lower than the effects
of response diversity. Our model predictions further indicates that in absence
of response diversity, we only observe negative relationships between
community stability and species richness. Therefore, it reinforces the idea that
response diversity is the crucial ingredient that hold the observed
positive effects of species richness on community stability and not species
richness alone[@thebault_trophic_2005; @loreau_species_2008;
@loreau_biodiversity_2021]. In return, species richness had a small negative
effect on average population stability. It is in agreement with previous
meta-analysis reporting that such negative effects are common in natural systems
but weak[@houlahan_negative_2018], but the mechanisms behind this relationship
are still debated. Overall our study highlights that the central role of
response diversity and species richness on asynchrony and thus community
stability also extends to complex food-webs.


Our results further show that food-web structure interact strongly with response
diversity to determine the sign of stability-richness relationships. We found
surprisingly that higher average interaction strength enhance positive
stability-richness relationships, by enhancing asynchrony-richness
relationships. At the opposite, higher average trophic level and higher
connectance both led to negative stability-richness, by dampening
asynchrony-richness relationships. Our result echoes with previous results
showing negative stability-richness relationship in freshwater
food-webs[@danet_species_2021]. Those results also echo with the
complexity-stability debate where population stability decreases as the
community is more species diverse, has higher connectance, and higher
interaction strength[@may_will_1972]. However, we found that the negative
effects of complexity on stability-richness relationships are dampened in
presence of high response diversity. Response diversity might then be one of the
mechanisms that explains why positive relationships between stability and
species richness are so prevalent in empirical settings while food-web
theoretical models that do not often include environmental stochasticity and
response diversity finds negative complexity-stability
relationships[@ives_stability_2007]. It is also in agreement previous studies
showing that higher connectance in low response diversity can drive negative
stability-richness in plant-herbivore systems[@thebault_trophic_2005]. Finally,
found that the strength of environmental stochasticity itself does not
affect the shape of the community stability-richness but rather controls the
overall community stability through its effects on population stability.

In conclusion, our study uncovers complex but consistent effects of response
diversity and food-web structure on the temporal stability of complex
communities. We showed that community stability was more driven by population
stability than asynchrony. We further showed that species richness and average
trophic level both increase community stability but by opposite pathways. Our
study also demonstrates that response diversity is the core mechanism driving
the buffering effects of biodiversity on environmental stochasticity also in
complex food-webs. Finally, our study shows that food-web structure and response
diversity interact to drive a continuum from negative to positive
stability-richness relationships. Looking to practical applications, our study
highlights that species richness without response diversity does not lead to
positive community-richness relations. So that assessment on how ecological
communities widespread recomposition[@dornelas_assemblage_2014;
@blowes_geography_2019] and homogenisation[@olden_homogocene_2018;
@muthukrishnan_invasive_2020; @wang_biotic_2021] is affecting response diversity
would be crucial to accurately predict long-term consequences on community
stability. The second take away to be drawn is that the variance of
environmental stochasticity was the main driver of community stability,
suggesting that increase in species richness and the maintenance of high
response diversity would be not enough to compensate for strong increase in
environmental variability in the coming decades[@lee_ipcc_2023].

# Methods

## Bioenergenetic model

We simulated the dynamics of complex food-webs using the allometric bioenergetic
model [@yodzis_body_1992; @brose_allometric_2006; @delmas_simulations_2017]. This model
is widely used to simulate the dynamics of complex ecological communities
because of the simplicity  and because it can be parametrized using  the
metabolic theory of ecology [@brown_toward_2004]. The model describes species
biomass dynamics over time with two master equations, one for the primary
producers (eq. \@ref(eq:prod)) and one for the consumers (eq.\@ref(eq:cons)):

\begin{equation}
    (\#eq:cons)
        \frac{dB_i}{dt} =
        \sum_{j \in \{\mathrm{res}\}_i} x_i y_i B_k F_{ij}
        - \sum_{j \in \{\mathrm{cons}\}_i} \frac{x_j y_j B_j F_{ji}}{e_{ij}}
        - x_i B_i - d_i B_i
\end{equation}

\begin{equation}
    (\#eq:prod)
	\frac{dB_i}{dt} =
    r_i B_i G_i
    - \sum_{j \in \{\mathrm{cons}\}_i} \frac{x_j y_j B_j F_{ji}}{e_{ij}}
    - d_i B_i
\end{equation}


The consumers gain biomass by consuming resources (i.e. their preys) at a rate
that depends on their mass specific metabolic rate ($x_i$),  maximum consumption
rate ($y_i$) and on the functional response ($F_ij$) describing how the rate of
consumption of a consumer $i$ on a resource $j$ vary with the biomass of this resource.
Consumers then lose biomass by being consumed, $e_ij$ being the assimilation
efficiency of the consumer $j$ on the resource $i$. Consumers also lose biomass
over time through metabolic losses ($-x_iB_i$) and by natural mortality due to
environment ($-d_iB_i$). The primary producers gain biomass over time with a
growth rate ($r_i$, eq. \@ref(eq:prod)) and a functional response ($G_i$)
describing how the growth of the producers vary with their biomass. They lose
biomass by being consumed by consumers and by natural mortality.

\begin{equation}
    (\#eq:growth)
    G_i = (1 - \dfrac{\sum_{j \in \{\mathrm{prod}\}} \alpha_{ij} B_j}{K_i})
\end{equation}

\begin{equation}
    (\#eq:holling)
    F_{ij} = \frac{\omega_{ij} B_j^h}
    {B_0^h + c_i B_i
    	+ \sum_{k \in \{\mathrm{res}\}_i} \omega_{ik} B_k^h}
\end{equation}


The growth of the primary producers (eq. \@ref(eq:growth)) is logistic
where the growth rate is maximal and null when
$\sum_{j \in \{\mathrm{prod}\}} \alpha_{ij} B_j$ are respectively close to 0 and 1. $\alpha_{ij}$ is the
per capita effect of the producer $j$ on the producer $i$, $K_i$ being the
carrying capacity for the producer $j$. The functional response of a consumer
feeding on a resource (eq. \@ref(eq:holling)) depends on the relative preference
of the consumer on the resource ($\omega_ij$) is limited by a half-saturation
rate ($B_0$), intraspecific interference coefficient ($c_i$), and on the
availability of its other resources
($\sum_{k \in \{\mathrm{res}\}_i} \omega_{ik} B_k^h$). Finally, the $h$ exponent
controls the shape of the functional response from a saturating function
($h = 1$, Holling type II) to a sigmoid ($h = 2$, Holling type III).

## Environmental stochasticity and response diversity

We added a stochastic natural mortality rate to the species dynamics,
representing a fluctuating environment. Based on the literature and previous
models [@vasseur_environmental_2007], we assumed that natural mortality rates
scales inversely with the species body mass ($d_i = d_0M_i^{-1/4}$), as all
other physiological parameters. We used a basal natural mortality rate of $d_0 =
.4$, as done in previous studies[@vasseur_environmental_2007].

We introduced environmental stochasticity by considering stochastic variation of
mortality rates. Doing so allows to consider stochasticity without modifying
species interactions themselves
[@vasseur_environmental_2007]. The stochastic part of the mortality rates
($\epsilon_{i, t}$) follow a normal distribution 0 centered
($\epsilon_{i, t} \sim N(0,\sigma^2_e)$) with a variance ($\sigma^2_e$). The
mortality rates of each species at the time $t$ equals to $d_{i,t} = d_i
e^{\epsilon_{i, t}}$, which ensured that the mortality rates never become
negative [@vasseur_environmental_2007]. We
simulated $\epsilon$ using an Ornstein-Uhlenbeck process, which is a modified
Brownian motion where the stochastic values tend to come back to the central
value (i.e. $\epsilon = 0$) such as $\epsilon_t$ varies according to this
stochastic differential equation: $d\epsilon_t = (0 - \epsilon_t)d_t + \sigma_e
dW_t$, where $dW_t$ is a Brownian motion. The strength of environmental
stochasticity was then controlled by $\sigma_e$.

Response diversity was controlled by the correlation among species stochastic
mortality rates ($\rho_{ij, i \neq j}$) such as response diversity is maximal
when species mortality rates are uncorrelated ($\rho = 0$) and null when species
mortality rates are perfectly correlated ($\rho = 1$) [@ripa_food_2003;
@vasseur_environmental_2007; @gouhier_synchrony_2010]. So the species mortality
rates were a product of the stochastic mortality rates generated by the
Ornstein-Uhlenbeck process and a variance-covariance matrix such as:


\begin{equation}
\begin{aligned}
\epsilon_{i, t} =
  \begin{bmatrix}
     \rho_{11}\sigma^2_e & \rho_{12}\sigma^2_e & \cdots & \rho_{1n}\sigma^2_e \\
     \rho_{21}\sigma^2_e & \rho_{22}\sigma^2_e & \cdots & \rho_{2n}\sigma^2_e \\
     \vdots  & \vdots  & \ddots & \vdots  \\
     \rho_{n1}\sigma^2_e & \rho_{n2}\sigma^2_e & \cdots & \rho_{nn}\sigma^2_e
  \end{bmatrix}
  \begin{bmatrix}
     a_{1,t} \\
     a_{2,t} \\
     \vdots  \\
     a_{n,t}
  \end{bmatrix}
(\#eq:rho)
\end{aligned}
\end{equation}

Where $a_{i,t}$ the stochastic value generated by the Ornstein-Uhlenbeck process
at time $t$, $\rho_{ii} = 1.0$ while all $\rho_{ij, i \neq j}$ were equal and
control the level of response diversity.

## Simulation

```{r}
tar_load(sim_param_tab)
spt <- sim_param_tab
get_sim_par_val <- function(x = "S", data = sim_param_tab) {
  x <- data[data$Parameter == x,][c("min", "max", "n")]
  setNames(unlist(x), c("min", "max", "n"))

}
pS <- get_sim_par_val(x = "S")
pct <- round(get_sim_par_val(x = "ct"), 2)
pZ <- get_sim_par_val(x = "Z")
pc <- get_sim_par_val(x = "c")
pe <- get_sim_par_val(x = "env_stoch")
prd <- get_sim_par_val(x = "resp_div")
pr <- get_sim_par_val(x = "rho")
```
\pagebreak

```{r}
met_cap <- "Examples of stochastic food-web simulations. a, Simulations with low
and high response diversity. b, simulations with low and high predator-prey mass
ratio (upper and bottom panels), low and high species richness (left and right
  panels). The food-webs are displayed on the side with the node size
being proportional to the average species biomass across the simulation. We
also display the food-web structure and the stability metrics. Across all
simulations, $h = 2$, $\\sigma_e = .3$. Low and high response diversity were
respectively $\\rho = 1$ and $\\rho = 0$. Low and high PPMR were respectively 1
and 100." %>%
str_replace_all("\\s+", " ")
```

```{r met, fig.cap = met_cap}
knitr::include_graphics(here("report", "figures", "p_methods.pdf"))
```

We generated food-web structure using the niche model [@williams_simple_2000]
with an initial species richness from $`r pS["min"]`$ to $`r pS["max"]`$, and
connectance from $`r pct["min"]`$ to $`r pct["max"]`$ (Table S1). We generated
food-webs without cannibalistic links and discarded food-webs that contained
disconnected species.

We varied the strength of environmental stochasticity by varying $\sigma_e$ from
$`r pe["min"]`$ to $`r pe["max"]`$, the range of mortality rates observed in
protists [@vasseur_environmental_2007]. We decreased response diversity by
increasing $\rho$ from $`r pr["min"]`$ to $`r pr["max"]`$ (i.e. response
diversity being $1 - \rho$) (Fig. \@ref(fig:met)a).

To vary interaction strength and mortality rates (i.e. allometrically
scaled mortality rate $d$) in the community, we varied the Predator-Prey
Mass Ratio (PPMR) from $`r pZ["min"]`$ to $`r pZ["max"]`$ (Fig. \@ref(fig:met)b).
We set $h = 2$, i.e. a functional response of type III (eq. \@ref(eq:holling)),
and varied predator interference (i.e. from $c = `r pc["min"]`$ to
$c = `r pc["max"]`$, eq. \@ref(eq:holling)), as predator interference was shown
to have a tremendous role on population stability [@brose_allometric_2006]. We
set a global carrying capacity of $K' = 10$ to ensure that consumers were not
limited by the biomass input from primary producers. We standardised the
carrying capacity by the number of primary producers and by the interspecific
competition among producers to ensure that the effects of species richness on
temporal stability are not driven by the increase in the number of primary
producers, thereby trivially increase biomass input for consumers. We then
standardised $K'$ such as $K_i = \frac{1 + \alpha_{ij} (S - 1)}{S}K'$
[@ives_stability_2000]. However, we found that our results were not affected
when removing the standardisation of carrying capacity (Fig. S1).

We numerically solved the stochastic differential equation systems during 2000
timesteps and collected the last 500 timesteps, similarly to previous studies
[@brose_allometric_2006]. We set $d_t = .1$, and $d_t = .05$ when instability
was detected during the simulations due to stiff changes in biomass. We set
extinction threshold to $10^{-6}$ and if an extinction happened in the last 500
timesteps, we continued to run the simulation for another 1000 timesteps until
there was no extinction events during the last 500 timesteps. When we found
disconnected species at the end of the simulation (i.e. a primary producer
without consumer or a consumer without prey), we set their biomass to 0 and
re-run the simulation for another 1000 timesteps. Except in the case of
disconnected species, we re-ran simulations with species starting biomass equal
to their biomass at the last timestep of the previous simulation. Supplementary
analysis showed that alternative choices of simulation processes, such as longer
simulations, rebuilding food-webs (i.e. resetting consumer preferences,
recomputing species bodymass according to the new food-web) after removing
disconnected species did not affect our results (Fig. S1). The food-web
generation and simulations were done using the `Julia` package
`EcologicalNetworkDynamics.jl` [@lajaaiti_ecologicalnetworksdynamicsjl_2024].

## Simulation analysis

We measured food-web properties that have been linked with stability in the
literature.  We measured total biomass, species richness, connectance, average
trophic level weighted by biomass, average omnivory and average interaction
strength. Food-web properties were measured at each of the 500 timesteps and
then averaged, except connectance and trophic level that were static.
Connectance was computed as $C = L / S(S-1)$, $L$ being the number of trophic
links and $S$ being the number of species in the community. Species trophic
level was computed recursively from the bottom of the food-web, such as the
trophic level of a consumer was equal to the average trophic level of its
resources added to 1, the trophic level of primary producers being set to 1
[@christensen_ecopath_1992]. Average trophic level was then equal to:
$1/\hat{B}_i\sum_{i}\mathrm{TL}_i$, $\mathrm{TL}_i$ being the trophic level and
$\hat{B}_i$ the average biomass of the species $i$. The degree of omnivory of a
consumer was computed  such as the sum of squares of its resource trophic levels
weighted by the relative preference of the consumer for each resource: $\sum_i
(\mathrm{TL}_i - \hat{\mathrm{TL}})^2 \omega_i/ \sum \omega_i$
[@christensen_ecopath_1992]. Interaction strength was computed was quantified as
the biomass fluxes going from a resource to a consumer, such as: $I = x_i y_i
B_k F_{ij}$ (eq. \@ref(eq:cons)), and averaged over time. Our way of measuring
interaction strength is very similar to previous metrics used in previous
studies, at the difference here that we average fluxes over time and not the
maximal interaction strength [@mccann_weak_1998]. Finally, the average
interaction strength of a community was computed as the average interaction
strength at the exclusion of null interaction strengths (i.e. excluding absence
of trophic interactions).

We assessed the effects of food-web structure, environmental stochasticity and
response diversity on temporal stability of biomass. We measured temporal stability of biomass
as the inverse of the coefficient of variation. We further partitioned stability
into population stability ($S_{pop}$) and asynchrony ($\phi$) such as:

\begin{equation}
\begin{aligned}
S_{com} = S_{pop} \times \phi
(\#eq:scom)
\end{aligned}
\end{equation}

with $S_{com} = \mu_{tot} / \sigma_{tot}$, $S_{pop} = \mu_{tot} / \sum_i \sigma_i$,
$\phi = \sum_i \sigma_i / \sigma_{tot}$.

$\mu_{tot}$ and $\sigma_{tot}$ being respectively average total biomass and standard
deviation of total biomass.

To further get a mechanistic insight about the effects of stressors and food-web
structure on stability, we partitioned asynchrony into portfolio effects and
compensatory dynamics stemming from species interaction[@zhao_biodiversity_2022]
($CPE_{int}$). The measurement of portfolio effects has been a topic of
debate[@loreau_biodiversity_2021;@zhao_biodiversity_2022]. Doak's
definition[@doak_statistical_1998] defines portfolio effects as the product of
statistical averaging effects ($SAE$) and compensatory effects arising from
response diversity[@zhao_biodiversity_2022; @doak_statistical_1998]
($CPE_{env}$). It then quantities the portfolio effect ($PFE = SAE \times
CPE_{env}$) emerging from independent species fluctuations, i.e. the statistical
averaging effect ($SAE$), weighted by the effects of response diversity of
species to environmental fluctuations, such as portfolio effects are dampened if
species have correlated responses. For completeness and comparison with previous
studies, we also measured portfolio effects according to Tilman's
definition[@tilman_ecological_1999] which consider that portfolio effects stem
solely from a pure statistical averaging of independent species fluctuations
($SAE$).

\begin{equation}
\begin{aligned}
S_{com} = S_{pop} \times SAE \times CPE
(\#eq:scom2)
\end{aligned}
\end{equation}

Statistical averaging effect is the share of asynchrony assuming that species are
independent, meaning that the variance total of the community is equal to the
sum of species variances only (i.e. species covariances are null). We can
define community stability ($S_{com, IP}$) in that scenario and then derive $SAE$.

\begin{equation}
\begin{aligned}
S_{com, IP} &= \dfrac{\mu_{tot}}{\sqrt{\sum_i \sigma^2_i}} = SAE \times S_{pop} \\
SAE &= \dfrac{S_{com, IP}}{S_{pop}} = \dfrac{\sum_i \sigma_i}{\sqrt{\sum_i \sigma^2_i}}\\
\end{aligned}
(\#eq:sae2)
\end{equation}

Compensatory dynamics in the food-webs is then the remaining part of asynchrony:

\begin{equation}
\begin{aligned}
CPE &= \dfrac{S_{com}}{SAE \times S_{pop}} = \dfrac{\sqrt{\sum_i \sigma^2_i}}{\sigma_{tot}}\\
\end{aligned}
(\#eq:cpe)
\end{equation}

Compensatory dynamics can arise from predator-prey interactions
($CPE_{int}$) or from differential response of species to environmental
stochasticity ($CPE_{env}$). From the deterministic and stochastic parts of
mortality rates, we computed the compensatory dynamics linked to the environment
such as:

\begin{equation}
\begin{aligned}
CPE_{env} &= \mathbf{B} \times \mathrm{diag}(d_i) \times e^\mathbf{E}
\end{aligned}
(\#eq:cpenv)
\end{equation}

With $\mathbf{B}$ and $\mathbf{E}$ being the matrices time x species for species biomass
and stochastic mortality rates respectively. Then compensatory dynamics raising
from species interactions were computed as: $CPE_{int} = CPE / CPE_{env}$.
Finally, portfolio effects was computed as: $SAE \times CPE_{env}$ and
compensatory dynamics raising from species interactions as $CPE_{int}$.

## Statistical analysis

Using a structural equation model, we disentangled the complex effects of
food-web structure, environmental stochasticity and response diversity on the
different facets of temporal stability of biomass (i.e. population stability,
portfolio effects and compensatory dynamic effects). We tested the
effects of food-web structure (average interaction strength, average trophic
level, connectance) on population stability and asynchrony partitions (portfolio and
compensatory effects). Grounded in theoretical ecology, we expected that higher
average trophic level, lower interaction strength, lower connectance[@mccann_weak_1998;
@mccann_reevaluating_1997; @shanafelt_stability_2018]. We further added
simulation parameters as control variables because higher Predator-Prey Mass
Ratio and predator interference were also expected to increase population
stability [@brose_allometric_2006]. Finally, we tested the effects of environmental
stochasticity and response diversity on population stability and asynchrony
partitions, although there were predicted to mainly affect to population stability
(i.e. by increasing amplitude of population fluctuations) and asynchrony (i.e.
by generating independent population fluctuations) respectively. We
completed the structural equation model with the mathematical relationship
linking compensatory dynamics and statistical averaging effects to asynchrony,
and from asynchrony and population stability to community stability. We further
developed a more detailed SEM including the partition of compensatory dynamics
due to species interactions ($CPE_{int}$) and due to environmental fluctuations
($CPE_{env}$).

Prior to test the structural equation model, we logged all the stability
components to transform their relation from multiplicative to additive (eq.
\@ref(eq:scom2)). We ensured that all the linear models composing the structural
equation model presented low multicollinearity (Variance Inflation
Factor < 3, Table S2), although interaction strength and species richness were
highly correlated (Fig. S2). The structural equation model using the R package
`PiecewiseSEM` [@lefcheck_piecewisesem_2016]. We then bootstrapped (N = 100) the
SEM to obtain confidence intervals on the estimated effects and computed the sum
of the direct and indirect effects using `semEff` R package
[@murphy_semeff_2021]. In the main text, we reported standardised coefficients
which were obtained by scaling the coefficients by the standard deviation of the
response and predictor variable. Finally, we reported only the direct
standardised coefficients that had an absolute value above $0.05$, because
almost all linked were statistically significant given the high numbers of
simulations.

In a second analysis, we aimed to test how stability-species richness
relationships were modulated by food-web structure and the two stressors:
environmental stochasticity and response diversity. We then modelled temporal
stability of community biomass according to food-web structure: species
richness, weighted average trophic level, connectance and average interaction
strength, as well as environmental stochasticity and species response diversity.
We further included the two-way interactions between species richness and
food-web structure, plus between species richness and stressors. Finally, we
added the three-way interaction between species richness, food-web structure and
stressors. We added predator interference, predator-prey mass ratio as control
variables. We further added the id of the food-web as a random intercept. We
then used the linear equation of the model and associated slope coefficients to
predict the shape of the relationship between community stability and species
richness according to a gradient of response diversity and of food-web
structure. To do so, we summed all the coefficients involving species richness
in the model, i.e. the one, two, and three-way terms. The values of the other
variables were set to the values indicated in the Fig. \@ref(fig:pred). The VIF
were inferior to 3, indicating low multicollinearity (Table S3), we checked the
distribution of the residuals (Fig. S3) using `DHARMa` R package. The model was
implemented using the R package `glmmTMB` [@brooks_glmmtmb_2017].

# References {-}
